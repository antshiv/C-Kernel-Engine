<?xml version="1.0" encoding="UTF-8"?>
<svg width="1200" height="1800" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#333"/>
    </marker>
    <marker id="arrowhead-red" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#c00"/>
    </marker>
  </defs>

  <!-- Title -->
  <text x="600" y="40" text-anchor="middle" font-size="24" font-weight="bold" fill="#333">
    Qwen2-0.5B Single Layer Data Flow (Inference, T=1 token decode)
  </text>
  <text x="600" y="70" text-anchor="middle" font-size="14" fill="#666">
    D=896, H=14, H_kv=2, head_dim=64, intermediate=4864
  </text>

  <!-- Legend -->
  <rect x="30" y="90" width="200" height="120" fill="#f8f8f8" stroke="#ccc" rx="5"/>
  <text x="40" y="110" font-size="12" font-weight="bold">Legend:</text>
  <rect x="40" y="120" width="20" height="15" fill="#e3f2fd" stroke="#1976d2"/>
  <text x="70" y="132" font-size="11">Weight (read-only)</text>
  <rect x="40" y="140" width="20" height="15" fill="#fff3e0" stroke="#f57c00"/>
  <text x="70" y="152" font-size="11">Activation (read+write)</text>
  <rect x="40" y="160" width="20" height="15" fill="#ffebee" stroke="#c62828"/>
  <text x="70" y="172" font-size="11">DRAM bottleneck</text>
  <line x1="40" y1="190" x2="60" y2="190" stroke="#c00" stroke-width="2" marker-end="url(#arrowhead-red)"/>
  <text x="70" y="194" font-size="11">Memory transfer</text>

  <!-- Model Config Box -->
  <rect x="900" y="90" width="280" height="140" fill="#e8f5e9" stroke="#4caf50" rx="5"/>
  <text x="910" y="115" font-size="12" font-weight="bold">Qwen2-0.5B Config:</text>
  <text x="910" y="135" font-size="11" font-family="monospace">hidden_size     = 896</text>
  <text x="910" y="150" font-size="11" font-family="monospace">num_heads       = 14</text>
  <text x="910" y="165" font-size="11" font-family="monospace">num_kv_heads    = 2</text>
  <text x="910" y="180" font-size="11" font-family="monospace">head_dim        = 64</text>
  <text x="910" y="195" font-size="11" font-family="monospace">intermediate    = 4864</text>
  <text x="910" y="210" font-size="11" font-family="monospace">rope_theta      = 1,000,000</text>
  <text x="910" y="225" font-size="11" font-family="monospace">rms_norm_eps    = 1e-6</text>

  <!-- ========== INPUT ========== -->
  <rect x="450" y="250" width="300" height="50" fill="#c8e6c9" stroke="#388e3c" rx="5" stroke-width="2"/>
  <text x="600" y="275" text-anchor="middle" font-size="14" font-weight="bold">INPUT (from prev layer)</text>
  <text x="600" y="292" text-anchor="middle" font-size="11" font-family="monospace">[T=1, D=896] = 3.5 KB</text>

  <!-- Arrow to RMSNorm1 -->
  <line x1="600" y1="300" x2="600" y2="330" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>

  <!-- ========== ATTENTION BLOCK ========== -->
  <rect x="100" y="340" width="1000" height="480" fill="none" stroke="#1976d2" stroke-width="2" stroke-dasharray="5,5" rx="10"/>
  <text x="120" y="365" font-size="14" font-weight="bold" fill="#1976d2">ATTENTION BLOCK</text>

  <!-- RMSNorm 1 -->
  <rect x="450" y="380" width="300" height="60" fill="#fff3e0" stroke="#f57c00" rx="5" stroke-width="2"/>
  <text x="600" y="405" text-anchor="middle" font-size="13" font-weight="bold">1. RMSNorm (pre-attention)</text>
  <text x="600" y="422" text-anchor="middle" font-size="10" font-family="monospace">READ: input[1,896], ln1_gamma[896]</text>
  <text x="600" y="435" text-anchor="middle" font-size="10" font-family="monospace">WRITE: ln1_out[1,896] = 3.5 KB ⚠️</text>

  <!-- Weight: ln1_gamma -->
  <rect x="780" y="385" width="120" height="35" fill="#e3f2fd" stroke="#1976d2" rx="3"/>
  <text x="840" y="405" text-anchor="middle" font-size="10">ln1_gamma</text>
  <text x="840" y="417" text-anchor="middle" font-size="9" font-family="monospace">[896] = 3.5KB</text>
  <line x1="780" y1="402" x2="750" y2="402" stroke="#1976d2" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Arrow to QKV -->
  <line x1="600" y1="440" x2="600" y2="470" stroke="#c00" stroke-width="2" marker-end="url(#arrowhead-red)"/>
  <text x="610" y="460" font-size="9" fill="#c00">DRAM R/W</text>

  <!-- QKV Projection -->
  <rect x="300" y="480" width="600" height="80" fill="#fff3e0" stroke="#f57c00" rx="5" stroke-width="2"/>
  <text x="600" y="505" text-anchor="middle" font-size="13" font-weight="bold">2. QKV Linear Projection</text>
  <text x="600" y="522" text-anchor="middle" font-size="10" font-family="monospace">READ: ln1_out[1,896], Wq[14,64,896], Wk[2,64,896], Wv[2,64,896]</text>
  <text x="600" y="537" text-anchor="middle" font-size="10" font-family="monospace">WRITE: Q[14,1,64], K[2,1,64], V[2,1,64] = 4.5 KB ⚠️</text>
  <text x="600" y="552" text-anchor="middle" font-size="10" fill="#c00">Wq+Wk+Wv = 14*64*896 + 2*2*64*896 = 1.02M + 229K = 5 MB weights!</text>

  <!-- Weights box for QKV -->
  <rect x="920" y="475" width="160" height="90" fill="#e3f2fd" stroke="#1976d2" rx="3"/>
  <text x="1000" y="495" text-anchor="middle" font-size="10" font-weight="bold">QKV Weights</text>
  <text x="1000" y="510" text-anchor="middle" font-size="9" font-family="monospace">Wq[14,64,896]=3.2MB</text>
  <text x="1000" y="525" text-anchor="middle" font-size="9" font-family="monospace">Wk[2,64,896]=460KB</text>
  <text x="1000" y="540" text-anchor="middle" font-size="9" font-family="monospace">Wv[2,64,896]=460KB</text>
  <text x="1000" y="555" text-anchor="middle" font-size="9" font-weight="bold">Total: 4.1 MB</text>
  <line x1="920" y1="520" x2="900" y2="520" stroke="#1976d2" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Arrow to RoPE -->
  <line x1="600" y1="560" x2="600" y2="590" stroke="#c00" stroke-width="2" marker-end="url(#arrowhead-red)"/>

  <!-- RoPE -->
  <rect x="400" y="600" width="400" height="55" fill="#fff3e0" stroke="#f57c00" rx="5" stroke-width="2"/>
  <text x="600" y="622" text-anchor="middle" font-size="13" font-weight="bold">3. RoPE (Rotary Position Embedding)</text>
  <text x="600" y="638" text-anchor="middle" font-size="10" font-family="monospace">READ: Q[14,1,64], K[2,1,64], cos/sin cache</text>
  <text x="600" y="650" text-anchor="middle" font-size="10" font-family="monospace">WRITE: Q, K in-place (same buffers)</text>

  <!-- Arrow to Attention -->
  <line x1="600" y1="655" x2="600" y2="685" stroke="#c00" stroke-width="2" marker-end="url(#arrowhead-red)"/>

  <!-- Attention -->
  <rect x="300" y="695" width="600" height="70" fill="#ffebee" stroke="#c62828" rx="5" stroke-width="3"/>
  <text x="600" y="718" text-anchor="middle" font-size="13" font-weight="bold" fill="#c62828">4. Scaled Dot-Product Attention (GQA)</text>
  <text x="600" y="735" text-anchor="middle" font-size="10" font-family="monospace">READ: Q[14,1,64], K[2,T,64], V[2,T,64] from KV cache</text>
  <text x="600" y="750" text-anchor="middle" font-size="10" font-family="monospace">WRITE: attn_out[14,1,64] = 3.5 KB ⚠️ (scores temp if training)</text>
  <text x="600" y="762" text-anchor="middle" font-size="9" fill="#c62828">← KV cache can be HUGE for long context!</text>

  <!-- Arrow to Output Proj -->
  <line x1="600" y1="765" x2="600" y2="795" stroke="#c00" stroke-width="2" marker-end="url(#arrowhead-red)"/>

  <!-- Output Projection -->
  <rect x="350" y="805" width="500" height="60" fill="#fff3e0" stroke="#f57c00" rx="5" stroke-width="2"/>
  <text x="600" y="828" text-anchor="middle" font-size="13" font-weight="bold">5. Output Projection + Residual Add</text>
  <text x="600" y="845" text-anchor="middle" font-size="10" font-family="monospace">READ: attn_out[14,64], Wo[896,896], input (residual)</text>
  <text x="600" y="858" text-anchor="middle" font-size="10" font-family="monospace">WRITE: residual1[1,896] = 3.5 KB ⚠️</text>

  <!-- Wo weight -->
  <rect x="870" y="810" width="120" height="45" fill="#e3f2fd" stroke="#1976d2" rx="3"/>
  <text x="930" y="830" text-anchor="middle" font-size="10">Wo weight</text>
  <text x="930" y="845" text-anchor="middle" font-size="9" font-family="monospace">[896,896]=3.2MB</text>
  <line x1="870" y1="832" x2="850" y2="832" stroke="#1976d2" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- ========== MLP BLOCK ========== -->
  <rect x="100" y="890" width="1000" height="380" fill="none" stroke="#388e3c" stroke-width="2" stroke-dasharray="5,5" rx="10"/>
  <text x="120" y="915" font-size="14" font-weight="bold" fill="#388e3c">MLP BLOCK (SwiGLU)</text>

  <!-- Arrow to RMSNorm2 -->
  <line x1="600" y1="865" x2="600" y2="930" stroke="#c00" stroke-width="2" marker-end="url(#arrowhead-red)"/>

  <!-- RMSNorm 2 -->
  <rect x="450" y="940" width="300" height="55" fill="#fff3e0" stroke="#f57c00" rx="5" stroke-width="2"/>
  <text x="600" y="962" text-anchor="middle" font-size="13" font-weight="bold">6. RMSNorm (pre-MLP)</text>
  <text x="600" y="978" text-anchor="middle" font-size="10" font-family="monospace">READ: residual1[1,896], ln2_gamma[896]</text>
  <text x="600" y="990" text-anchor="middle" font-size="10" font-family="monospace">WRITE: ln2_out[1,896] = 3.5 KB ⚠️</text>

  <!-- Arrow to Gate+Up -->
  <line x1="600" y1="995" x2="600" y2="1030" stroke="#c00" stroke-width="2" marker-end="url(#arrowhead-red)"/>

  <!-- Gate+Up Projection -->
  <rect x="300" y="1040" width="600" height="70" fill="#ffebee" stroke="#c62828" rx="5" stroke-width="3"/>
  <text x="600" y="1063" text-anchor="middle" font-size="13" font-weight="bold" fill="#c62828">7. Gate + Up Projection (Fused W1)</text>
  <text x="600" y="1080" text-anchor="middle" font-size="10" font-family="monospace">READ: ln2_out[1,896], W1[2*4864, 896]</text>
  <text x="600" y="1095" text-anchor="middle" font-size="10" font-family="monospace">WRITE: fc1_out[1, 9728] = 38 KB ⚠️ (gate + up concatenated)</text>
  <text x="600" y="1107" text-anchor="middle" font-size="9" fill="#c62828">← W1 = 34.6 MB! Biggest weight in layer</text>

  <!-- W1 weight -->
  <rect x="920" y="1045" width="160" height="55" fill="#e3f2fd" stroke="#1976d2" rx="3"/>
  <text x="1000" y="1065" text-anchor="middle" font-size="10" font-weight="bold">W1 (gate_up)</text>
  <text x="1000" y="1080" text-anchor="middle" font-size="9" font-family="monospace">[9728,896]=34.6MB</text>
  <text x="1000" y="1093" text-anchor="middle" font-size="9" fill="#c62828">BIGGEST!</text>
  <line x1="920" y1="1075" x2="900" y2="1075" stroke="#1976d2" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- Arrow to SwiGLU -->
  <line x1="600" y1="1110" x2="600" y2="1140" stroke="#c00" stroke-width="2" marker-end="url(#arrowhead-red)"/>

  <!-- SwiGLU -->
  <rect x="400" y="1150" width="400" height="55" fill="#fff3e0" stroke="#f57c00" rx="5" stroke-width="2"/>
  <text x="600" y="1172" text-anchor="middle" font-size="13" font-weight="bold">8. SwiGLU Activation</text>
  <text x="600" y="1188" text-anchor="middle" font-size="10" font-family="monospace">READ: fc1_out[1, 9728] (gate + up parts)</text>
  <text x="600" y="1200" text-anchor="middle" font-size="10" font-family="monospace">WRITE: swiglu_out[1, 4864] = 19 KB ⚠️</text>

  <!-- Arrow to Down Proj -->
  <line x1="600" y1="1205" x2="600" y2="1235" stroke="#c00" stroke-width="2" marker-end="url(#arrowhead-red)"/>

  <!-- Down Projection -->
  <rect x="350" y="1245" width="500" height="60" fill="#fff3e0" stroke="#f57c00" rx="5" stroke-width="2"/>
  <text x="600" y="1268" text-anchor="middle" font-size="13" font-weight="bold">9. Down Projection + Residual Add</text>
  <text x="600" y="1285" text-anchor="middle" font-size="10" font-family="monospace">READ: swiglu_out[1,4864], W2[896,4864], residual1</text>
  <text x="600" y="1298" text-anchor="middle" font-size="10" font-family="monospace">WRITE: output[1,896] = 3.5 KB ⚠️</text>

  <!-- W2 weight -->
  <rect x="870" y="1250" width="130" height="45" fill="#e3f2fd" stroke="#1976d2" rx="3"/>
  <text x="935" y="1270" text-anchor="middle" font-size="10">W2 (down)</text>
  <text x="935" y="1285" text-anchor="middle" font-size="9" font-family="monospace">[896,4864]=17.3MB</text>
  <line x1="870" y1="1272" x2="850" y2="1272" stroke="#1976d2" stroke-width="1" marker-end="url(#arrowhead)"/>

  <!-- ========== OUTPUT ========== -->
  <line x1="600" y1="1305" x2="600" y2="1350" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>

  <rect x="450" y="1360" width="300" height="50" fill="#c8e6c9" stroke="#388e3c" rx="5" stroke-width="2"/>
  <text x="600" y="1385" text-anchor="middle" font-size="14" font-weight="bold">OUTPUT (to next layer)</text>
  <text x="600" y="1402" text-anchor="middle" font-size="11" font-family="monospace">[T=1, D=896] = 3.5 KB</text>

  <!-- ========== SUMMARY BOX ========== -->
  <rect x="100" y="1440" width="500" height="180" fill="#fff8e1" stroke="#ff8f00" rx="5" stroke-width="2"/>
  <text x="120" y="1465" font-size="14" font-weight="bold">MEMORY TRAFFIC PER LAYER (T=1 decode):</text>

  <text x="120" y="1490" font-size="12" font-weight="bold" fill="#1976d2">Weights (read-only):</text>
  <text x="130" y="1508" font-size="11" font-family="monospace">Wq+Wk+Wv+Wo = 4.1 + 3.2 = 7.3 MB</text>
  <text x="130" y="1523" font-size="11" font-family="monospace">W1 (gate+up) = 34.6 MB</text>
  <text x="130" y="1538" font-size="11" font-family="monospace">W2 (down)    = 17.3 MB</text>
  <text x="130" y="1553" font-size="11" font-family="monospace" font-weight="bold">Total weights: ~59 MB / layer</text>

  <text x="120" y="1578" font-size="12" font-weight="bold" fill="#c62828">Activations (read+write to DRAM):</text>
  <text x="130" y="1596" font-size="11" font-family="monospace">9 intermediate buffers × ~3-38 KB each</text>
  <text x="130" y="1611" font-size="11" font-family="monospace" font-weight="bold" fill="#c62828">~9 DRAM round-trips per layer!</text>

  <!-- OPTIMIZATION BOX -->
  <rect x="620" y="1440" width="480" height="180" fill="#e8f5e9" stroke="#4caf50" rx="5" stroke-width="2"/>
  <text x="640" y="1465" font-size="14" font-weight="bold" fill="#2e7d32">FUSION OPPORTUNITIES:</text>

  <text x="640" y="1490" font-size="11">1. RMSNorm + QKV → eliminate ln1_out write</text>
  <text x="640" y="1510" font-size="11">2. RMSNorm + Gate+Up → eliminate ln2_out write</text>
  <text x="640" y="1530" font-size="11">3. Gate+Up + SwiGLU → eliminate fc1_out write</text>
  <text x="640" y="1550" font-size="11">4. SwiGLU + Down → eliminate swiglu_out write</text>

  <text x="640" y="1580" font-size="12" font-weight="bold" fill="#2e7d32">With fusion: 2 DRAM writes instead of 9</text>
  <text x="640" y="1600" font-size="12" font-weight="bold" fill="#2e7d32">Potential speedup: 3-5x for decode!</text>

  <!-- CPU utilization note -->
  <rect x="100" y="1640" width="1000" height="50" fill="#ffebee" stroke="#c62828" rx="5"/>
  <text x="600" y="1665" text-anchor="middle" font-size="12" font-weight="bold" fill="#c62828">
    Your perf data shows only 10% CPU utilization → Memory-bound! Most time spent waiting for DRAM.
  </text>
  <text x="600" y="1682" text-anchor="middle" font-size="11" fill="#c62828">
    Fusion keeps data in L2 cache (~256KB-1MB), avoiding 100+ cycle DRAM latency per access.
  </text>

</svg>
