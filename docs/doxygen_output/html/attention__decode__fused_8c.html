<!-- Doxygen custom header with link back to main docs -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>attention_decode_fused.c File Reference</title>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<style>
/* Back to docs banner */
.docs-banner {
    background: linear-gradient(135deg, #2a2a2a 0%, #363636 50%, #2a2a2a 100%);
    border-bottom: 3px solid #ffb400;
    padding: 0.5rem 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}
.docs-banner a {
    color: #ffb400;
    text-decoration: none;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.docs-banner a:hover {
    color: #ffc933;
}
.docs-banner .logo {
    background: #ffb400;
    color: #1d1d1d;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-weight: 700;
    font-family: monospace;
}
.docs-banner .subtitle {
    color: #707070;
    font-size: 0.85rem;
}
</style>
</head>
<body>
<div class="docs-banner">
    <a href="../index.html">
        <span class="logo">CK</span>
        <span>‚Üê Back to C-Kernel-Engine Docs</span>
    </a>
    <span class="subtitle">Doxygen Source Documentation</span>
</div>
<div id="top">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('attention__decode__fused_8c.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">attention_decode_fused.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="ckernel__orchestration_8h_source.html">ckernel_orchestration.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="ckernel__engine_8h_source.html">ckernel_engine.h</a>&quot;</code><br />
<code>#include &lt;stddef.h&gt;</code><br />
</div>
<p><a href="attention__decode__fused_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ade31f5d0f381b108e331db103adc6251"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="attention__decode__fused_8c.html#ade31f5d0f381b108e331db103adc6251">ck_attention_project_head_major_decode_token</a> (const float *attn_token, const float *wo, const float *bo, float *out_token, int embed_dim, int aligned_embed_dim, int num_heads, int aligned_head_dim)</td></tr>
<tr class="separator:ade31f5d0f381b108e331db103adc6251"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a606857bd1c4a89fc378a6787ce01d348"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="attention__decode__fused_8c.html#a606857bd1c4a89fc378a6787ce01d348">ck_attention_project_head_major_decode_token_residual</a> (const float *attn_token, const float *wo, const float *bo, const float *residual_in, float *proj_out, float *residual_out, int embed_dim, int aligned_embed_dim, int num_heads, int aligned_head_dim)</td></tr>
<tr class="separator:a606857bd1c4a89fc378a6787ce01d348"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a481d5a4d4ee37e40f432109b3873bc05"><td class="memItemLeft" align="right" valign="top">static float&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="attention__decode__fused_8c.html#a481d5a4d4ee37e40f432109b3873bc05">ck_dot_f32</a> (const float *a, const float *b, int len)</td></tr>
<tr class="separator:a481d5a4d4ee37e40f432109b3873bc05"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad466e4eeb1c0ab92d9c9bf15cb51f679"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="attention__decode__fused_8c.html#ad466e4eeb1c0ab92d9c9bf15cb51f679">ck_layer_forward_rmsnorm_swiglu_decode_fused_attn</a> (const <a class="el" href="structCKLayerForwardParams.html">CKLayerForwardParams</a> *p, int token_index, int cache_capacity)</td></tr>
<tr class="separator:ad466e4eeb1c0ab92d9c9bf15cb51f679"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1e6628f9f140c9749a6dd7c2c9ce263a"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="attention__decode__fused_8c.html#a1e6628f9f140c9749a6dd7c2c9ce263a">ck_layer_forward_rmsnorm_swiglu_decode_fused_attn_impl</a> (const <a class="el" href="structCKLayerForwardParams.html">CKLayerForwardParams</a> *p, int token_index, int cache_capacity, int fuse_mlp)</td></tr>
<tr class="separator:a1e6628f9f140c9749a6dd7c2c9ce263a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a50899fc552648f5d1cadd0e4c5671dc1"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="attention__decode__fused_8c.html#a50899fc552648f5d1cadd0e4c5671dc1">ck_layer_forward_rmsnorm_swiglu_decode_fused_attn_mlp</a> (const <a class="el" href="structCKLayerForwardParams.html">CKLayerForwardParams</a> *p, int token_index, int cache_capacity)</td></tr>
<tr class="separator:a50899fc552648f5d1cadd0e4c5671dc1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab6c6524b0f30733a077e3783bb55a592"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="attention__decode__fused_8c.html#ab6c6524b0f30733a077e3783bb55a592">ck_qkv_project_head_major_token</a> (const float *input_row, const float *wq, const float *bq, const float *wk, const float *bk, const float *wv, const float *bv, float *q_token, float *k_token, float *v_token, int aligned_embed_dim, int num_heads, int num_kv_heads, int aligned_head_dim)</td></tr>
<tr class="separator:ab6c6524b0f30733a077e3783bb55a592"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a id="ade31f5d0f381b108e331db103adc6251"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ade31f5d0f381b108e331db103adc6251">&#9670;&nbsp;</a></span>ck_attention_project_head_major_decode_token()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ck_attention_project_head_major_decode_token </td>
          <td>(</td>
          <td class="paramtype">const float *&#160;</td>
          <td class="paramname"><em>attn_token</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const float *&#160;</td>
          <td class="paramname"><em>wo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const float *&#160;</td>
          <td class="paramname"><em>bo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>out_token</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>embed_dim</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>aligned_embed_dim</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>num_heads</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>aligned_head_dim</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="attention__decode__fused_8c_source.html#l00099">99</a> of file <a class="el" href="attention__decode__fused_8c_source.html">attention_decode_fused.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;{</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">size_t</span> head_in_stride = (size_t)aligned_head_dim;</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">size_t</span> head_weight_stride = (size_t)aligned_embed_dim * (<span class="keywordtype">size_t</span>)aligned_head_dim;</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160; </div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="preprocessor">#pragma omp parallel for schedule(static)</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; embed_dim; ++j) {</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        <span class="keywordtype">float</span> sum = bo ? bo[j] : 0.0f;</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> h = 0; h &lt; num_heads; ++h) {</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;            <span class="keyword">const</span> <span class="keywordtype">float</span> *head_in = attn_token + (size_t)h * head_in_stride;</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;            <span class="keyword">const</span> <span class="keywordtype">float</span> *wo_row = wo + (size_t)h * head_weight_stride + (<span class="keywordtype">size_t</span>)j * (size_t)aligned_head_dim;</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;            sum += <a class="code" href="attention__decode__fused_8c.html#a481d5a4d4ee37e40f432109b3873bc05">ck_dot_f32</a>(head_in, wo_row, aligned_head_dim);</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;        }</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;        out_token[j] = sum;</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    }</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160; </div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = embed_dim; j &lt; aligned_embed_dim; ++j) {</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;        out_token[j] = 0.0f;</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    }</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;}</div>
<div class="ttc" id="aattention__decode__fused_8c_html_a481d5a4d4ee37e40f432109b3873bc05"><div class="ttname"><a href="attention__decode__fused_8c.html#a481d5a4d4ee37e40f432109b3873bc05">ck_dot_f32</a></div><div class="ttdeci">static float ck_dot_f32(const float *a, const float *b, int len)</div><div class="ttdef"><b>Definition:</b> <a href="attention__decode__fused_8c_source.html#l00025">attention_decode_fused.c:25</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="attention__decode__fused_8c_source.html#l00025">ck_dot_f32()</a>.</p>

<p class="reference">Referenced by <a class="el" href="ckernel__orchestration_8c_source.html#l01040">ck_layer_forward_rmsnorm_swiglu_decode()</a>, <a class="el" href="ckernel__orchestration_8c_source.html#l01198">ck_layer_forward_rmsnorm_swiglu_decode_fused()</a>, and <a class="el" href="ckernel__orchestration_8c_source.html#l02238">ck_layer_forward_rmsnorm_swiglu_decode_quant()</a>.</p>

</div>
</div>
<a id="a606857bd1c4a89fc378a6787ce01d348"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a606857bd1c4a89fc378a6787ce01d348">&#9670;&nbsp;</a></span>ck_attention_project_head_major_decode_token_residual()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void ck_attention_project_head_major_decode_token_residual </td>
          <td>(</td>
          <td class="paramtype">const float *&#160;</td>
          <td class="paramname"><em>attn_token</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const float *&#160;</td>
          <td class="paramname"><em>wo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const float *&#160;</td>
          <td class="paramname"><em>bo</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const float *&#160;</td>
          <td class="paramname"><em>residual_in</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>proj_out</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>residual_out</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>embed_dim</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>aligned_embed_dim</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>num_heads</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>aligned_head_dim</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="attention__decode__fused_8c_source.html#l00129">129</a> of file <a class="el" href="attention__decode__fused_8c_source.html">attention_decode_fused.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;{</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">size_t</span> head_in_stride = (size_t)aligned_head_dim;</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">size_t</span> head_weight_stride = (size_t)aligned_embed_dim * (<span class="keywordtype">size_t</span>)aligned_head_dim;</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160; </div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="preprocessor">#pragma omp parallel for schedule(static)</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; embed_dim; ++j) {</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        <span class="keywordtype">float</span> sum = bo ? bo[j] : 0.0f;</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> h = 0; h &lt; num_heads; ++h) {</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;            <span class="keyword">const</span> <span class="keywordtype">float</span> *head_in = attn_token + (size_t)h * head_in_stride;</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;            <span class="keyword">const</span> <span class="keywordtype">float</span> *wo_row = wo + (size_t)h * head_weight_stride + (<span class="keywordtype">size_t</span>)j * (size_t)aligned_head_dim;</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;            sum += <a class="code" href="attention__decode__fused_8c.html#a481d5a4d4ee37e40f432109b3873bc05">ck_dot_f32</a>(head_in, wo_row, aligned_head_dim);</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;        }</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;        <span class="keywordflow">if</span> (proj_out) {</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;            proj_out[j] = sum;</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;        }</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;        residual_out[j] = sum + residual_in[j];</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    }</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160; </div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = embed_dim; j &lt; aligned_embed_dim; ++j) {</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        <span class="keywordflow">if</span> (proj_out) {</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;            proj_out[j] = 0.0f;</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        }</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;        residual_out[j] = 0.0f;</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    }</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;}</div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="attention__decode__fused_8c_source.html#l00025">ck_dot_f32()</a>.</p>

<p class="reference">Referenced by <a class="el" href="attention__decode__fused_8c_source.html#l00165">ck_layer_forward_rmsnorm_swiglu_decode_fused_attn_impl()</a>.</p>

</div>
</div>
<a id="a481d5a4d4ee37e40f432109b3873bc05"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a481d5a4d4ee37e40f432109b3873bc05">&#9670;&nbsp;</a></span>ck_dot_f32()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static float ck_dot_f32 </td>
          <td>(</td>
          <td class="paramtype">const float *&#160;</td>
          <td class="paramname"><em>a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const float *&#160;</td>
          <td class="paramname"><em>b</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>len</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="attention__decode__fused_8c_source.html#l00025">25</a> of file <a class="el" href="attention__decode__fused_8c_source.html">attention_decode_fused.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;{</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#if defined(__AVX512F__)</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;    __m512 acc = _mm512_setzero_ps();</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;    <span class="keywordtype">int</span> i = 0;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;    <span class="keywordflow">for</span> (; i &lt;= len - 16; i += 16) {</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;        __m512 va = _mm512_loadu_ps(a + i);</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;        __m512 vb = _mm512_loadu_ps(b + i);</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;        acc = _mm512_fmadd_ps(va, vb, acc);</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;    }</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;    <span class="keywordtype">float</span> sum = _mm512_reduce_add_ps(acc);</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;    <span class="keywordflow">for</span> (; i &lt; len; ++i) {</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;        sum += a[i] * b[i];</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;    }</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;    <span class="keywordflow">return</span> sum;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="preprocessor">#elif defined(__AVX__)</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    __m256 acc = _mm256_setzero_ps();</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    <span class="keywordtype">int</span> i = 0;</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    <span class="keywordflow">for</span> (; i &lt;= len - 8; i += 8) {</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;        __m256 va = _mm256_loadu_ps(a + i);</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;        __m256 vb = _mm256_loadu_ps(b + i);</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;        acc = _mm256_add_ps(acc, _mm256_mul_ps(va, vb));</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    }</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    <span class="keywordtype">float</span> sum = ck_hsum256_ps(acc);</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    <span class="keywordflow">for</span> (; i &lt; len; ++i) {</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;        sum += a[i] * b[i];</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    }</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    <span class="keywordflow">return</span> sum;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    <span class="keywordtype">float</span> sum = 0.0f;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; len; ++i) {</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;        sum += a[i] * b[i];</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    }</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    <span class="keywordflow">return</span> sum;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;}</div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="attention__decode__fused_8c_source.html#l00099">ck_attention_project_head_major_decode_token()</a>, and <a class="el" href="attention__decode__fused_8c_source.html#l00129">ck_attention_project_head_major_decode_token_residual()</a>.</p>

</div>
</div>
<a id="ad466e4eeb1c0ab92d9c9bf15cb51f679"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad466e4eeb1c0ab92d9c9bf15cb51f679">&#9670;&nbsp;</a></span>ck_layer_forward_rmsnorm_swiglu_decode_fused_attn()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ck_layer_forward_rmsnorm_swiglu_decode_fused_attn </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structCKLayerForwardParams.html">CKLayerForwardParams</a> *&#160;</td>
          <td class="paramname"><em>p</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>token_index</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>cache_capacity</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="attention__decode__fused_8c_source.html#l00325">325</a> of file <a class="el" href="attention__decode__fused_8c_source.html">attention_decode_fused.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;{</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    <a class="code" href="attention__decode__fused_8c.html#a1e6628f9f140c9749a6dd7c2c9ce263a">ck_layer_forward_rmsnorm_swiglu_decode_fused_attn_impl</a>(p,</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;                                                           token_index,</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;                                                           cache_capacity,</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;                                                           <span class="comment">/*fuse_mlp=*/</span>0);</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;}</div>
<div class="ttc" id="aattention__decode__fused_8c_html_a1e6628f9f140c9749a6dd7c2c9ce263a"><div class="ttname"><a href="attention__decode__fused_8c.html#a1e6628f9f140c9749a6dd7c2c9ce263a">ck_layer_forward_rmsnorm_swiglu_decode_fused_attn_impl</a></div><div class="ttdeci">static void ck_layer_forward_rmsnorm_swiglu_decode_fused_attn_impl(const CKLayerForwardParams *p, int token_index, int cache_capacity, int fuse_mlp)</div><div class="ttdef"><b>Definition:</b> <a href="attention__decode__fused_8c_source.html#l00165">attention_decode_fused.c:165</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="attention__decode__fused_8c_source.html#l00165">ck_layer_forward_rmsnorm_swiglu_decode_fused_attn_impl()</a>.</p>

</div>
</div>
<a id="a1e6628f9f140c9749a6dd7c2c9ce263a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1e6628f9f140c9749a6dd7c2c9ce263a">&#9670;&nbsp;</a></span>ck_layer_forward_rmsnorm_swiglu_decode_fused_attn_impl()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void ck_layer_forward_rmsnorm_swiglu_decode_fused_attn_impl </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structCKLayerForwardParams.html">CKLayerForwardParams</a> *&#160;</td>
          <td class="paramname"><em>p</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>token_index</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>cache_capacity</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>fuse_mlp</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="attention__decode__fused_8c_source.html#l00165">165</a> of file <a class="el" href="attention__decode__fused_8c_source.html">attention_decode_fused.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;{</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    <span class="keywordflow">if</span> (!p) {</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    }</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structCKLayerForwardParams.html#ad678ed659e2a04e07062a4aff3fe50a7">input</a> || !p-&gt;<a class="code" href="structCKLayerForwardParams.html#a4a3337a600f787d4b2fe9ab83f7594c9">ln1_gamma</a> || !p-&gt;<a class="code" href="structCKLayerForwardParams.html#aace627c9eb6644fac5c3fc5a4748f1f4">ln2_gamma</a> || !p-&gt;<a class="code" href="structCKLayerForwardParams.html#a621ed21298acc47932068d4a97ba72d7">wq</a> || !p-&gt;<a class="code" href="structCKLayerForwardParams.html#a14ca061d781c1ed9631ff94df3e6278b">wk</a> || !p-&gt;<a class="code" href="structCKLayerForwardParams.html#a7e8ccf20ccec87eb230737334d589f5d">wv</a> || !p-&gt;<a class="code" href="structCKLayerForwardParams.html#a98753685d03e778a1d655f8f3cd486ea">wo</a> ||</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;        !p-&gt;<a class="code" href="structCKLayerForwardParams.html#a72a52720f195370d45e7cc00a6985651">w1</a> || !p-&gt;<a class="code" href="structCKLayerForwardParams.html#a070376c4c42bb40d7cdd919ea74c669b">w2</a> || !p-&gt;<a class="code" href="structCKLayerForwardParams.html#ac4abe1c97c14c49d953ae5dd8f910c96">k</a> || !p-&gt;<a class="code" href="structCKLayerForwardParams.html#ac49cad0850ce2e111044fc2114783d16">v</a> || !p-&gt;<a class="code" href="structCKLayerForwardParams.html#a97ce8698227c9cf419c8e21d17cebc12">residual1</a> || !p-&gt;<a class="code" href="structCKLayerForwardParams.html#a122026c6f33e91f706fc37dab39c10b2">ln2_out</a> || !p-&gt;<a class="code" href="structCKLayerForwardParams.html#a64b3c9bf08573696fe23f773e0af3f4a">swiglu_out</a> ||</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        !p-&gt;<a class="code" href="structCKLayerForwardParams.html#a86060e45304124966b764eb8db0365b7">mlp_out</a> || !p-&gt;<a class="code" href="structCKLayerForwardParams.html#a61d1bcef2bcffd12c7a49d243a6c51d1">output</a>) {</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    }</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    <span class="keywordflow">if</span> (!fuse_mlp &amp;&amp; !p-&gt;<a class="code" href="structCKLayerForwardParams.html#a7ca0c2bd14cfcde3504bd43030609e4b">fc1_out</a>) {</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    }</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    <span class="keywordflow">if</span> (token_index &lt; 0 || cache_capacity &lt;= 0 || token_index &gt;= cache_capacity) {</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    }</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structCKLayerForwardParams.html#a6ef0a14fb20cf0840ecc43d05ece08a5">num_heads</a> &lt;= 0 || p-&gt;<a class="code" href="structCKLayerForwardParams.html#a16731d5e0724c25e7b807955d41be75a">num_kv_heads</a> &lt;= 0 || p-&gt;<a class="code" href="structCKLayerForwardParams.html#a4eb2bdb409cf3a010bbb554a98e61e65">aligned_head_dim</a> &lt;= 0) {</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    }</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160; </div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">int</span> D = p-&gt;<a class="code" href="structCKLayerForwardParams.html#a0a48ad009d13315fb1a18ec1f9aff5c8">embed_dim</a>;</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">int</span> aligned_D = p-&gt;<a class="code" href="structCKLayerForwardParams.html#adcd26186adf7f31c20dbdfed35cc0d88">aligned_embed_dim</a>;</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">int</span> H = p-&gt;<a class="code" href="structCKLayerForwardParams.html#a6ef0a14fb20cf0840ecc43d05ece08a5">num_heads</a>;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">int</span> H_kv = p-&gt;<a class="code" href="structCKLayerForwardParams.html#a16731d5e0724c25e7b807955d41be75a">num_kv_heads</a>;</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">int</span> hd = p-&gt;<a class="code" href="structCKLayerForwardParams.html#a5aac19a779c176623a55fd48bb9502cf">head_dim</a>;</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">int</span> ad = p-&gt;<a class="code" href="structCKLayerForwardParams.html#a4eb2bdb409cf3a010bbb554a98e61e65">aligned_head_dim</a>;</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">int</span> aligned_intermediate = p-&gt;<a class="code" href="structCKLayerForwardParams.html#add2c7b423bea0a7261e1fbdc2820d3d6">aligned_intermediate_dim</a>;</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160; </div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">float</span> *input_row = p-&gt;<a class="code" href="structCKLayerForwardParams.html#ad678ed659e2a04e07062a4aff3fe50a7">input</a> + (size_t)token_index * (<span class="keywordtype">size_t</span>)aligned_D;</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    <span class="keywordtype">float</span> *proj_row = NULL;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    <span class="keywordtype">float</span> *residual_row = p-&gt;<a class="code" href="structCKLayerForwardParams.html#a97ce8698227c9cf419c8e21d17cebc12">residual1</a> + (size_t)token_index * (<span class="keywordtype">size_t</span>)aligned_D;</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    <span class="keywordtype">float</span> *ln2_row = p-&gt;<a class="code" href="structCKLayerForwardParams.html#a122026c6f33e91f706fc37dab39c10b2">ln2_out</a> + (size_t)token_index * (<span class="keywordtype">size_t</span>)aligned_D;</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    <span class="keywordtype">float</span> *swiglu_row = p-&gt;<a class="code" href="structCKLayerForwardParams.html#a64b3c9bf08573696fe23f773e0af3f4a">swiglu_out</a> + (size_t)token_index * (<span class="keywordtype">size_t</span>)aligned_intermediate;</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    <span class="keywordtype">float</span> *mlp_row = p-&gt;<a class="code" href="structCKLayerForwardParams.html#a86060e45304124966b764eb8db0365b7">mlp_out</a> + (size_t)token_index * (<span class="keywordtype">size_t</span>)aligned_D;</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    <span class="keywordtype">float</span> *out_row = p-&gt;<a class="code" href="structCKLayerForwardParams.html#a61d1bcef2bcffd12c7a49d243a6c51d1">output</a> + (size_t)token_index * (<span class="keywordtype">size_t</span>)aligned_D;</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160; </div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    <span class="keywordtype">float</span> ln1_rstd_tmp = 0.0f;</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    <span class="keywordtype">float</span> ln2_rstd_tmp = 0.0f;</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    <span class="keywordtype">float</span> *ln2_rstd = p-&gt;<a class="code" href="structCKLayerForwardParams.html#a4bad26d55e52ce0462fb8b4081880a0f">ln2_rstd</a> ? (p-&gt;<a class="code" href="structCKLayerForwardParams.html#a4bad26d55e52ce0462fb8b4081880a0f">ln2_rstd</a> + token_index) : &amp;ln2_rstd_tmp;</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160; </div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    <span class="keywordtype">float</span> ln1_row[aligned_D];</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160; </div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    <a class="code" href="ckernel__engine_8h.html#a9a068ed02d809a81a23f09e61b820baf">rmsnorm_forward</a>(input_row,</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;                    p-&gt;<a class="code" href="structCKLayerForwardParams.html#a4a3337a600f787d4b2fe9ab83f7594c9">ln1_gamma</a>,</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;                    ln1_row,</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;                    &amp;ln1_rstd_tmp,</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;                    <span class="comment">/*tokens=*/</span>1,</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;                    D,</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;                    aligned_D,</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;                    p-&gt;<a class="code" href="structCKLayerForwardParams.html#a63e37652b3bb5e0d394ea70af0895595">eps</a>);</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160; </div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    <span class="keywordtype">size_t</span> q_elems = (size_t)H * (<span class="keywordtype">size_t</span>)ad;</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    <span class="keywordtype">size_t</span> kv_elems = (size_t)H_kv * (<span class="keywordtype">size_t</span>)ad;</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    <span class="keywordtype">float</span> q_token[q_elems];</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    <span class="keywordtype">float</span> k_token[kv_elems];</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    <span class="keywordtype">float</span> v_token[kv_elems];</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    <span class="keywordtype">float</span> attn_token[q_elems];</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160; </div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    <a class="code" href="attention__decode__fused_8c.html#ab6c6524b0f30733a077e3783bb55a592">ck_qkv_project_head_major_token</a>(ln1_row,</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;                                    p-&gt;<a class="code" href="structCKLayerForwardParams.html#a621ed21298acc47932068d4a97ba72d7">wq</a>, p-&gt;<a class="code" href="structCKLayerForwardParams.html#a1002972e750e6b75ba1151cc4de47a05">bq</a>,</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;                                    p-&gt;<a class="code" href="structCKLayerForwardParams.html#a14ca061d781c1ed9631ff94df3e6278b">wk</a>, p-&gt;<a class="code" href="structCKLayerForwardParams.html#a7e508ab8ae215c31fbae4f78b23d5929">bk</a>,</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;                                    p-&gt;<a class="code" href="structCKLayerForwardParams.html#a7e8ccf20ccec87eb230737334d589f5d">wv</a>, p-&gt;<a class="code" href="structCKLayerForwardParams.html#ab2e6f98706c4822473bee01a6b4c46d6">bv</a>,</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;                                    q_token, k_token, v_token,</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;                                    aligned_D,</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;                                    H,</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;                                    H_kv,</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;                                    ad);</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160; </div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structCKLayerForwardParams.html#a3be9a0f9fae1ab8fddc30e14628d74a0">rope_cos</a> &amp;&amp; p-&gt;<a class="code" href="structCKLayerForwardParams.html#a332fc12fb11a99adfd72dba034c56ea7">rope_sin</a>) {</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        <a class="code" href="ckernel__engine_8h.html#ab18869516e9a6ab5998038716ac8a179">rope_forward_qk</a>(q_token,</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;                        k_token,</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;                        p-&gt;<a class="code" href="structCKLayerForwardParams.html#a3be9a0f9fae1ab8fddc30e14628d74a0">rope_cos</a>,</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;                        p-&gt;<a class="code" href="structCKLayerForwardParams.html#a332fc12fb11a99adfd72dba034c56ea7">rope_sin</a>,</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;                        H,</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;                        H_kv,</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;                        <span class="comment">/*num_tokens=*/</span>1,</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;                        hd,</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;                        ad,</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;                        p-&gt;<a class="code" href="structCKLayerForwardParams.html#ad0e18a97d0cd2746890333bcc2d0d0e1">rope_pos_offset</a>);</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    }</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160; </div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    <a class="code" href="ckernel__engine_8h.html#a1b1c905b9d69fc8aadca4c714147ce45">kv_cache_write_head_major</a>(k_token,</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;                              v_token,</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;                              p-&gt;<a class="code" href="structCKLayerForwardParams.html#ac4abe1c97c14c49d953ae5dd8f910c96">k</a>,</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;                              p-&gt;<a class="code" href="structCKLayerForwardParams.html#ac49cad0850ce2e111044fc2114783d16">v</a>,</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;                              H_kv,</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;                              token_index,</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                              cache_capacity,</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                              hd,</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;                              ad);</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160; </div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    <a class="code" href="ckernel__engine_8h.html#a84803f8c5509c325dd6b9feec50a0493">attention_forward_decode_head_major_gqa_flash</a>(q_token,</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;                                                  p-&gt;<a class="code" href="structCKLayerForwardParams.html#ac4abe1c97c14c49d953ae5dd8f910c96">k</a>,</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;                                                  p-&gt;<a class="code" href="structCKLayerForwardParams.html#ac49cad0850ce2e111044fc2114783d16">v</a>,</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;                                                  attn_token,</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;                                                  H,</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;                                                  H_kv,</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;                                                  <span class="comment">/*kv_tokens=*/</span>token_index + 1,</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;                                                  cache_capacity,</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;                                                  hd,</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;                                                  ad);</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160; </div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    <a class="code" href="attention__decode__fused_8c.html#a606857bd1c4a89fc378a6787ce01d348">ck_attention_project_head_major_decode_token_residual</a>(attn_token,</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;                                                          p-&gt;<a class="code" href="structCKLayerForwardParams.html#a98753685d03e778a1d655f8f3cd486ea">wo</a>,</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;                                                          p-&gt;<a class="code" href="structCKLayerForwardParams.html#ae1e3ff68d1bc957125df225fec96dcc2">bo</a>,</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;                                                          input_row,</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;                                                          proj_row,</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;                                                          residual_row,</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;                                                          D,</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;                                                          aligned_D,</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;                                                          H,</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;                                                          ad);</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160; </div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    <a class="code" href="ckernel__engine_8h.html#a9a068ed02d809a81a23f09e61b820baf">rmsnorm_forward</a>(residual_row,</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;                    p-&gt;<a class="code" href="structCKLayerForwardParams.html#aace627c9eb6644fac5c3fc5a4748f1f4">ln2_gamma</a>,</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;                    ln2_row,</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;                    ln2_rstd,</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;                    <span class="comment">/*tokens=*/</span>1,</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;                    D,</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;                    aligned_D,</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;                    p-&gt;<a class="code" href="structCKLayerForwardParams.html#a63e37652b3bb5e0d394ea70af0895595">eps</a>);</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160; </div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;    <span class="keywordflow">if</span> (fuse_mlp) {</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;        <span class="comment">// Fully fused MLP avoids writing SwiGLU activations to DRAM (aligned dims</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;        <span class="comment">// match padded weight layout).</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;        <a class="code" href="ckernel__orchestration_8h.html#a6aaebd943ca5ad278729a207b401ab45">ck_mlp_swiglu_forward_fully_fused_token</a>(ln2_row,</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;                                                 p-&gt;<a class="code" href="structCKLayerForwardParams.html#a72a52720f195370d45e7cc00a6985651">w1</a>,</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;                                                 p-&gt;<a class="code" href="structCKLayerForwardParams.html#a8b216d5540d147750b5b7d6ebe238445">b1</a>,</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;                                                 p-&gt;<a class="code" href="structCKLayerForwardParams.html#a070376c4c42bb40d7cdd919ea74c669b">w2</a>,</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;                                                 p-&gt;<a class="code" href="structCKLayerForwardParams.html#acc91fa02742733363b55e38ff2305e7f">b2</a>,</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;                                                 mlp_row,</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;                                                 aligned_D,</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;                                                 aligned_intermediate);</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;        <span class="keywordtype">int</span> up_dim = 2 * aligned_intermediate;</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;        <span class="keywordtype">float</span> *fc1_row = p-&gt;<a class="code" href="structCKLayerForwardParams.html#a7ca0c2bd14cfcde3504bd43030609e4b">fc1_out</a> + (size_t)token_index * (<span class="keywordtype">size_t</span>)up_dim;</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160; </div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;        <a class="code" href="ckernel__orchestration_8h.html#a2e894b79792aaf694427446c1d89fab8">ck_mlp_swiglu_forward</a>(ln2_row,</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;                              p-&gt;<a class="code" href="structCKLayerForwardParams.html#a72a52720f195370d45e7cc00a6985651">w1</a>,</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;                              p-&gt;<a class="code" href="structCKLayerForwardParams.html#a8b216d5540d147750b5b7d6ebe238445">b1</a>,</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;                              p-&gt;<a class="code" href="structCKLayerForwardParams.html#a070376c4c42bb40d7cdd919ea74c669b">w2</a>,</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;                              p-&gt;<a class="code" href="structCKLayerForwardParams.html#acc91fa02742733363b55e38ff2305e7f">b2</a>,</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;                              fc1_row,</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;                              swiglu_row,</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                              mlp_row,</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;                              <span class="comment">/*tokens=*/</span>1,</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;                              aligned_D,</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;                              aligned_intermediate);</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    }</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160; </div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    <a class="code" href="ckernel__orchestration_8h.html#ab0948def8f4a6c6fd8a5288aacd22f01">ck_residual_add_token_major</a>(residual_row,</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;                                mlp_row,</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;                                out_row,</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;                                <span class="comment">/*tokens=*/</span>1,</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;                                aligned_D);</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;}</div>
<div class="ttc" id="aattention__decode__fused_8c_html_a606857bd1c4a89fc378a6787ce01d348"><div class="ttname"><a href="attention__decode__fused_8c.html#a606857bd1c4a89fc378a6787ce01d348">ck_attention_project_head_major_decode_token_residual</a></div><div class="ttdeci">static void ck_attention_project_head_major_decode_token_residual(const float *attn_token, const float *wo, const float *bo, const float *residual_in, float *proj_out, float *residual_out, int embed_dim, int aligned_embed_dim, int num_heads, int aligned_head_dim)</div><div class="ttdef"><b>Definition:</b> <a href="attention__decode__fused_8c_source.html#l00129">attention_decode_fused.c:129</a></div></div>
<div class="ttc" id="aattention__decode__fused_8c_html_ab6c6524b0f30733a077e3783bb55a592"><div class="ttname"><a href="attention__decode__fused_8c.html#ab6c6524b0f30733a077e3783bb55a592">ck_qkv_project_head_major_token</a></div><div class="ttdeci">void ck_qkv_project_head_major_token(const float *input_row, const float *wq, const float *bq, const float *wk, const float *bk, const float *wv, const float *bv, float *q_token, float *k_token, float *v_token, int aligned_embed_dim, int num_heads, int num_kv_heads, int aligned_head_dim)</div><div class="ttdef"><b>Definition:</b> <a href="attention__decode__fused_8c_source.html#l00062">attention_decode_fused.c:62</a></div></div>
<div class="ttc" id="ackernel__engine_8h_html_a1b1c905b9d69fc8aadca4c714147ce45"><div class="ttname"><a href="ckernel__engine_8h.html#a1b1c905b9d69fc8aadca4c714147ce45">kv_cache_write_head_major</a></div><div class="ttdeci">void kv_cache_write_head_major(const float *k_token, const float *v_token, float *k_cache, float *v_cache, int num_kv_heads, int token_index, int cache_capacity, int head_dim, int aligned_head_dim)</div><div class="ttdef"><b>Definition:</b> <a href="kv__cache__kernels_8c_source.html#l00048">kv_cache_kernels.c:48</a></div></div>
<div class="ttc" id="ackernel__engine_8h_html_a84803f8c5509c325dd6b9feec50a0493"><div class="ttname"><a href="ckernel__engine_8h.html#a84803f8c5509c325dd6b9feec50a0493">attention_forward_decode_head_major_gqa_flash</a></div><div class="ttdeci">void attention_forward_decode_head_major_gqa_flash(const float *q_token, const float *k_cache, const float *v_cache, float *out_token, int num_heads, int num_kv_heads, int kv_tokens, int cache_capacity, int head_dim, int aligned_head_dim)</div><div class="ttdef"><b>Definition:</b> <a href="attention__kernels_8c_source.html#l00798">attention_kernels.c:798</a></div></div>
<div class="ttc" id="ackernel__engine_8h_html_a9a068ed02d809a81a23f09e61b820baf"><div class="ttname"><a href="ckernel__engine_8h.html#a9a068ed02d809a81a23f09e61b820baf">rmsnorm_forward</a></div><div class="ttdeci">void rmsnorm_forward(const float *input, const float *gamma, float *output, float *rstd_cache, int tokens, int d_model, int aligned_embed_dim, float eps)</div><div class="ttdef"><b>Definition:</b> <a href="rmsnorm__kernels_8c_source.html#l00030">rmsnorm_kernels.c:30</a></div></div>
<div class="ttc" id="ackernel__engine_8h_html_ab18869516e9a6ab5998038716ac8a179"><div class="ttname"><a href="ckernel__engine_8h.html#ab18869516e9a6ab5998038716ac8a179">rope_forward_qk</a></div><div class="ttdeci">void rope_forward_qk(float *q, float *k, const float *cos_cache, const float *sin_cache, int num_heads, int num_kv_heads, int num_tokens, int head_dim, int aligned_head_dim, int pos_offset)</div><div class="ttdef"><b>Definition:</b> <a href="rope__kernels_8c_source.html#l00375">rope_kernels.c:375</a></div></div>
<div class="ttc" id="ackernel__orchestration_8h_html_a2e894b79792aaf694427446c1d89fab8"><div class="ttname"><a href="ckernel__orchestration_8h.html#a2e894b79792aaf694427446c1d89fab8">ck_mlp_swiglu_forward</a></div><div class="ttdeci">void ck_mlp_swiglu_forward(const float *input, const float *w1, const float *b1, const float *w2, const float *b2, float *fc1_out, float *swiglu_out, float *output, int tokens, int aligned_embed_dim, int aligned_intermediate_dim)</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8c_source.html#l00705">ckernel_orchestration.c:705</a></div></div>
<div class="ttc" id="ackernel__orchestration_8h_html_a6aaebd943ca5ad278729a207b401ab45"><div class="ttname"><a href="ckernel__orchestration_8h.html#a6aaebd943ca5ad278729a207b401ab45">ck_mlp_swiglu_forward_fully_fused_token</a></div><div class="ttdeci">void ck_mlp_swiglu_forward_fully_fused_token(const float *input_row, const float *w1, const float *b1, const float *w2, const float *b2, float *output_row, int aligned_embed_dim, int aligned_intermediate_dim)</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8c_source.html#l00998">ckernel_orchestration.c:998</a></div></div>
<div class="ttc" id="ackernel__orchestration_8h_html_ab0948def8f4a6c6fd8a5288aacd22f01"><div class="ttname"><a href="ckernel__orchestration_8h.html#ab0948def8f4a6c6fd8a5288aacd22f01">ck_residual_add_token_major</a></div><div class="ttdeci">void ck_residual_add_token_major(const float *a, const float *b, float *out, int tokens, int aligned_embed_dim)</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8c_source.html#l00015">ckernel_orchestration.c:15</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_a070376c4c42bb40d7cdd919ea74c669b"><div class="ttname"><a href="structCKLayerForwardParams.html#a070376c4c42bb40d7cdd919ea74c669b">CKLayerForwardParams::w2</a></div><div class="ttdeci">const float * w2</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00044">ckernel_orchestration.h:44</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_a0a48ad009d13315fb1a18ec1f9aff5c8"><div class="ttname"><a href="structCKLayerForwardParams.html#a0a48ad009d13315fb1a18ec1f9aff5c8">CKLayerForwardParams::embed_dim</a></div><div class="ttdeci">int embed_dim</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00013">ckernel_orchestration.h:13</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_a1002972e750e6b75ba1151cc4de47a05"><div class="ttname"><a href="structCKLayerForwardParams.html#a1002972e750e6b75ba1151cc4de47a05">CKLayerForwardParams::bq</a></div><div class="ttdeci">const float * bq</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00033">ckernel_orchestration.h:33</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_a122026c6f33e91f706fc37dab39c10b2"><div class="ttname"><a href="structCKLayerForwardParams.html#a122026c6f33e91f706fc37dab39c10b2">CKLayerForwardParams::ln2_out</a></div><div class="ttdeci">float * ln2_out</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00057">ckernel_orchestration.h:57</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_a14ca061d781c1ed9631ff94df3e6278b"><div class="ttname"><a href="structCKLayerForwardParams.html#a14ca061d781c1ed9631ff94df3e6278b">CKLayerForwardParams::wk</a></div><div class="ttdeci">const float * wk</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00034">ckernel_orchestration.h:34</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_a16731d5e0724c25e7b807955d41be75a"><div class="ttname"><a href="structCKLayerForwardParams.html#a16731d5e0724c25e7b807955d41be75a">CKLayerForwardParams::num_kv_heads</a></div><div class="ttdeci">int num_kv_heads</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00016">ckernel_orchestration.h:16</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_a332fc12fb11a99adfd72dba034c56ea7"><div class="ttname"><a href="structCKLayerForwardParams.html#a332fc12fb11a99adfd72dba034c56ea7">CKLayerForwardParams::rope_sin</a></div><div class="ttdeci">const float * rope_sin</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00030">ckernel_orchestration.h:30</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_a3be9a0f9fae1ab8fddc30e14628d74a0"><div class="ttname"><a href="structCKLayerForwardParams.html#a3be9a0f9fae1ab8fddc30e14628d74a0">CKLayerForwardParams::rope_cos</a></div><div class="ttdeci">const float * rope_cos</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00029">ckernel_orchestration.h:29</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_a4a3337a600f787d4b2fe9ab83f7594c9"><div class="ttname"><a href="structCKLayerForwardParams.html#a4a3337a600f787d4b2fe9ab83f7594c9">CKLayerForwardParams::ln1_gamma</a></div><div class="ttdeci">const float * ln1_gamma</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00026">ckernel_orchestration.h:26</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_a4bad26d55e52ce0462fb8b4081880a0f"><div class="ttname"><a href="structCKLayerForwardParams.html#a4bad26d55e52ce0462fb8b4081880a0f">CKLayerForwardParams::ln2_rstd</a></div><div class="ttdeci">float * ln2_rstd</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00058">ckernel_orchestration.h:58</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_a4eb2bdb409cf3a010bbb554a98e61e65"><div class="ttname"><a href="structCKLayerForwardParams.html#a4eb2bdb409cf3a010bbb554a98e61e65">CKLayerForwardParams::aligned_head_dim</a></div><div class="ttdeci">int aligned_head_dim</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00018">ckernel_orchestration.h:18</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_a5aac19a779c176623a55fd48bb9502cf"><div class="ttname"><a href="structCKLayerForwardParams.html#a5aac19a779c176623a55fd48bb9502cf">CKLayerForwardParams::head_dim</a></div><div class="ttdeci">int head_dim</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00017">ckernel_orchestration.h:17</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_a61d1bcef2bcffd12c7a49d243a6c51d1"><div class="ttname"><a href="structCKLayerForwardParams.html#a61d1bcef2bcffd12c7a49d243a6c51d1">CKLayerForwardParams::output</a></div><div class="ttdeci">float * output</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00062">ckernel_orchestration.h:62</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_a621ed21298acc47932068d4a97ba72d7"><div class="ttname"><a href="structCKLayerForwardParams.html#a621ed21298acc47932068d4a97ba72d7">CKLayerForwardParams::wq</a></div><div class="ttdeci">const float * wq</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00032">ckernel_orchestration.h:32</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_a63e37652b3bb5e0d394ea70af0895595"><div class="ttname"><a href="structCKLayerForwardParams.html#a63e37652b3bb5e0d394ea70af0895595">CKLayerForwardParams::eps</a></div><div class="ttdeci">float eps</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00022">ckernel_orchestration.h:22</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_a64b3c9bf08573696fe23f773e0af3f4a"><div class="ttname"><a href="structCKLayerForwardParams.html#a64b3c9bf08573696fe23f773e0af3f4a">CKLayerForwardParams::swiglu_out</a></div><div class="ttdeci">float * swiglu_out</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00060">ckernel_orchestration.h:60</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_a6ef0a14fb20cf0840ecc43d05ece08a5"><div class="ttname"><a href="structCKLayerForwardParams.html#a6ef0a14fb20cf0840ecc43d05ece08a5">CKLayerForwardParams::num_heads</a></div><div class="ttdeci">int num_heads</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00015">ckernel_orchestration.h:15</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_a72a52720f195370d45e7cc00a6985651"><div class="ttname"><a href="structCKLayerForwardParams.html#a72a52720f195370d45e7cc00a6985651">CKLayerForwardParams::w1</a></div><div class="ttdeci">const float * w1</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00042">ckernel_orchestration.h:42</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_a7ca0c2bd14cfcde3504bd43030609e4b"><div class="ttname"><a href="structCKLayerForwardParams.html#a7ca0c2bd14cfcde3504bd43030609e4b">CKLayerForwardParams::fc1_out</a></div><div class="ttdeci">float * fc1_out</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00059">ckernel_orchestration.h:59</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_a7e508ab8ae215c31fbae4f78b23d5929"><div class="ttname"><a href="structCKLayerForwardParams.html#a7e508ab8ae215c31fbae4f78b23d5929">CKLayerForwardParams::bk</a></div><div class="ttdeci">const float * bk</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00035">ckernel_orchestration.h:35</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_a7e8ccf20ccec87eb230737334d589f5d"><div class="ttname"><a href="structCKLayerForwardParams.html#a7e8ccf20ccec87eb230737334d589f5d">CKLayerForwardParams::wv</a></div><div class="ttdeci">const float * wv</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00036">ckernel_orchestration.h:36</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_a86060e45304124966b764eb8db0365b7"><div class="ttname"><a href="structCKLayerForwardParams.html#a86060e45304124966b764eb8db0365b7">CKLayerForwardParams::mlp_out</a></div><div class="ttdeci">float * mlp_out</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00061">ckernel_orchestration.h:61</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_a8b216d5540d147750b5b7d6ebe238445"><div class="ttname"><a href="structCKLayerForwardParams.html#a8b216d5540d147750b5b7d6ebe238445">CKLayerForwardParams::b1</a></div><div class="ttdeci">const float * b1</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00043">ckernel_orchestration.h:43</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_a97ce8698227c9cf419c8e21d17cebc12"><div class="ttname"><a href="structCKLayerForwardParams.html#a97ce8698227c9cf419c8e21d17cebc12">CKLayerForwardParams::residual1</a></div><div class="ttdeci">float * residual1</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00056">ckernel_orchestration.h:56</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_a98753685d03e778a1d655f8f3cd486ea"><div class="ttname"><a href="structCKLayerForwardParams.html#a98753685d03e778a1d655f8f3cd486ea">CKLayerForwardParams::wo</a></div><div class="ttdeci">const float * wo</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00039">ckernel_orchestration.h:39</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_aace627c9eb6644fac5c3fc5a4748f1f4"><div class="ttname"><a href="structCKLayerForwardParams.html#aace627c9eb6644fac5c3fc5a4748f1f4">CKLayerForwardParams::ln2_gamma</a></div><div class="ttdeci">const float * ln2_gamma</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00027">ckernel_orchestration.h:27</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_ab2e6f98706c4822473bee01a6b4c46d6"><div class="ttname"><a href="structCKLayerForwardParams.html#ab2e6f98706c4822473bee01a6b4c46d6">CKLayerForwardParams::bv</a></div><div class="ttdeci">const float * bv</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00037">ckernel_orchestration.h:37</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_ac49cad0850ce2e111044fc2114783d16"><div class="ttname"><a href="structCKLayerForwardParams.html#ac49cad0850ce2e111044fc2114783d16">CKLayerForwardParams::v</a></div><div class="ttdeci">float * v</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00051">ckernel_orchestration.h:51</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_ac4abe1c97c14c49d953ae5dd8f910c96"><div class="ttname"><a href="structCKLayerForwardParams.html#ac4abe1c97c14c49d953ae5dd8f910c96">CKLayerForwardParams::k</a></div><div class="ttdeci">float * k</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00050">ckernel_orchestration.h:50</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_acc91fa02742733363b55e38ff2305e7f"><div class="ttname"><a href="structCKLayerForwardParams.html#acc91fa02742733363b55e38ff2305e7f">CKLayerForwardParams::b2</a></div><div class="ttdeci">const float * b2</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00045">ckernel_orchestration.h:45</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_ad0e18a97d0cd2746890333bcc2d0d0e1"><div class="ttname"><a href="structCKLayerForwardParams.html#ad0e18a97d0cd2746890333bcc2d0d0e1">CKLayerForwardParams::rope_pos_offset</a></div><div class="ttdeci">int rope_pos_offset</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00023">ckernel_orchestration.h:23</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_ad678ed659e2a04e07062a4aff3fe50a7"><div class="ttname"><a href="structCKLayerForwardParams.html#ad678ed659e2a04e07062a4aff3fe50a7">CKLayerForwardParams::input</a></div><div class="ttdeci">const float * input</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00025">ckernel_orchestration.h:25</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_adcd26186adf7f31c20dbdfed35cc0d88"><div class="ttname"><a href="structCKLayerForwardParams.html#adcd26186adf7f31c20dbdfed35cc0d88">CKLayerForwardParams::aligned_embed_dim</a></div><div class="ttdeci">int aligned_embed_dim</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00014">ckernel_orchestration.h:14</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_add2c7b423bea0a7261e1fbdc2820d3d6"><div class="ttname"><a href="structCKLayerForwardParams.html#add2c7b423bea0a7261e1fbdc2820d3d6">CKLayerForwardParams::aligned_intermediate_dim</a></div><div class="ttdeci">int aligned_intermediate_dim</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00021">ckernel_orchestration.h:21</a></div></div>
<div class="ttc" id="astructCKLayerForwardParams_html_ae1e3ff68d1bc957125df225fec96dcc2"><div class="ttname"><a href="structCKLayerForwardParams.html#ae1e3ff68d1bc957125df225fec96dcc2">CKLayerForwardParams::bo</a></div><div class="ttdeci">const float * bo</div><div class="ttdef"><b>Definition:</b> <a href="ckernel__orchestration_8h_source.html#l00040">ckernel_orchestration.h:40</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="ckernel__orchestration_8h_source.html#l00014">CKLayerForwardParams::aligned_embed_dim</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00018">CKLayerForwardParams::aligned_head_dim</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00021">CKLayerForwardParams::aligned_intermediate_dim</a>, <a class="el" href="attention__kernels_8c_source.html#l00798">attention_forward_decode_head_major_gqa_flash()</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00043">CKLayerForwardParams::b1</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00045">CKLayerForwardParams::b2</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00035">CKLayerForwardParams::bk</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00040">CKLayerForwardParams::bo</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00033">CKLayerForwardParams::bq</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00037">CKLayerForwardParams::bv</a>, <a class="el" href="attention__decode__fused_8c_source.html#l00129">ck_attention_project_head_major_decode_token_residual()</a>, <a class="el" href="ckernel__orchestration_8c_source.html#l00705">ck_mlp_swiglu_forward()</a>, <a class="el" href="ckernel__orchestration_8c_source.html#l00998">ck_mlp_swiglu_forward_fully_fused_token()</a>, <a class="el" href="attention__decode__fused_8c_source.html#l00062">ck_qkv_project_head_major_token()</a>, <a class="el" href="ckernel__orchestration_8c_source.html#l00015">ck_residual_add_token_major()</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00013">CKLayerForwardParams::embed_dim</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00022">CKLayerForwardParams::eps</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00059">CKLayerForwardParams::fc1_out</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00017">CKLayerForwardParams::head_dim</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00025">CKLayerForwardParams::input</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00050">CKLayerForwardParams::k</a>, <a class="el" href="kv__cache__kernels_8c_source.html#l00048">kv_cache_write_head_major()</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00026">CKLayerForwardParams::ln1_gamma</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00027">CKLayerForwardParams::ln2_gamma</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00057">CKLayerForwardParams::ln2_out</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00058">CKLayerForwardParams::ln2_rstd</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00061">CKLayerForwardParams::mlp_out</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00015">CKLayerForwardParams::num_heads</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00016">CKLayerForwardParams::num_kv_heads</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00062">CKLayerForwardParams::output</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00056">CKLayerForwardParams::residual1</a>, <a class="el" href="rmsnorm__kernels_8c_source.html#l00030">rmsnorm_forward()</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00029">CKLayerForwardParams::rope_cos</a>, <a class="el" href="rope__kernels_8c_source.html#l00375">rope_forward_qk()</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00023">CKLayerForwardParams::rope_pos_offset</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00030">CKLayerForwardParams::rope_sin</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00060">CKLayerForwardParams::swiglu_out</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00051">CKLayerForwardParams::v</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00042">CKLayerForwardParams::w1</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00044">CKLayerForwardParams::w2</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00034">CKLayerForwardParams::wk</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00039">CKLayerForwardParams::wo</a>, <a class="el" href="ckernel__orchestration_8h_source.html#l00032">CKLayerForwardParams::wq</a>, and <a class="el" href="ckernel__orchestration_8h_source.html#l00036">CKLayerForwardParams::wv</a>.</p>

<p class="reference">Referenced by <a class="el" href="attention__decode__fused_8c_source.html#l00325">ck_layer_forward_rmsnorm_swiglu_decode_fused_attn()</a>, and <a class="el" href="attention__decode__fused_8c_source.html#l00335">ck_layer_forward_rmsnorm_swiglu_decode_fused_attn_mlp()</a>.</p>

</div>
</div>
<a id="a50899fc552648f5d1cadd0e4c5671dc1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a50899fc552648f5d1cadd0e4c5671dc1">&#9670;&nbsp;</a></span>ck_layer_forward_rmsnorm_swiglu_decode_fused_attn_mlp()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ck_layer_forward_rmsnorm_swiglu_decode_fused_attn_mlp </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structCKLayerForwardParams.html">CKLayerForwardParams</a> *&#160;</td>
          <td class="paramname"><em>p</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>token_index</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>cache_capacity</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="attention__decode__fused_8c_source.html#l00335">335</a> of file <a class="el" href="attention__decode__fused_8c_source.html">attention_decode_fused.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;{</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    <a class="code" href="attention__decode__fused_8c.html#a1e6628f9f140c9749a6dd7c2c9ce263a">ck_layer_forward_rmsnorm_swiglu_decode_fused_attn_impl</a>(p,</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;                                                           token_index,</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;                                                           cache_capacity,</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;                                                           <span class="comment">/*fuse_mlp=*/</span>1);</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;}</div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="attention__decode__fused_8c_source.html#l00165">ck_layer_forward_rmsnorm_swiglu_decode_fused_attn_impl()</a>.</p>

</div>
</div>
<a id="ab6c6524b0f30733a077e3783bb55a592"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab6c6524b0f30733a077e3783bb55a592">&#9670;&nbsp;</a></span>ck_qkv_project_head_major_token()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ck_qkv_project_head_major_token </td>
          <td>(</td>
          <td class="paramtype">const float *&#160;</td>
          <td class="paramname"><em>input_row</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const float *&#160;</td>
          <td class="paramname"><em>wq</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const float *&#160;</td>
          <td class="paramname"><em>bq</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const float *&#160;</td>
          <td class="paramname"><em>wk</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const float *&#160;</td>
          <td class="paramname"><em>bk</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const float *&#160;</td>
          <td class="paramname"><em>wv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const float *&#160;</td>
          <td class="paramname"><em>bv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>q_token</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>k_token</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float *&#160;</td>
          <td class="paramname"><em>v_token</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>aligned_embed_dim</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>num_heads</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>num_kv_heads</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>aligned_head_dim</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="attention__decode__fused_8c_source.html#l00062">62</a> of file <a class="el" href="attention__decode__fused_8c_source.html">attention_decode_fused.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;{</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    <span class="keywordflow">if</span> (!input_row || !wq || !wk || !wv || !q_token || !k_token || !v_token) {</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    }</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160; </div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">int</span> q_out = num_heads * aligned_head_dim;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <a class="code" href="ckernel__engine_8h.html#af4f0e756d3ac00b45ce2c7a296b61ae3">gemm_blocked_serial</a>(input_row, wq, bq, q_token,</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;                        <span class="comment">/*tokens=*/</span>1, q_out, aligned_embed_dim);</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160; </div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    <span class="keywordtype">size_t</span> head_weight_stride = (size_t)aligned_head_dim * (<span class="keywordtype">size_t</span>)aligned_embed_dim;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="preprocessor">#pragma omp parallel for schedule(static) if(num_kv_heads &gt; 1)</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> h = 0; h &lt; num_kv_heads; ++h) {</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">float</span> *wk_h = wk + (size_t)h * head_weight_stride;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">float</span> *wv_h = wv + (size_t)h * head_weight_stride;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">float</span> *bk_h = bk ? (bk + (size_t)h * (<span class="keywordtype">size_t</span>)aligned_head_dim) : NULL;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">float</span> *bv_h = bv ? (bv + (size_t)h * (<span class="keywordtype">size_t</span>)aligned_head_dim) : NULL;</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;        <span class="keywordtype">float</span> *k_h = k_token + (size_t)h * (<span class="keywordtype">size_t</span>)aligned_head_dim;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;        <span class="keywordtype">float</span> *v_h = v_token + (size_t)h * (<span class="keywordtype">size_t</span>)aligned_head_dim;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160; </div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;        <a class="code" href="ckernel__engine_8h.html#af4f0e756d3ac00b45ce2c7a296b61ae3">gemm_blocked_serial</a>(input_row, wk_h, bk_h, k_h,</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;                            <span class="comment">/*tokens=*/</span>1, aligned_head_dim, aligned_embed_dim);</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;        <a class="code" href="ckernel__engine_8h.html#af4f0e756d3ac00b45ce2c7a296b61ae3">gemm_blocked_serial</a>(input_row, wv_h, bv_h, v_h,</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;                            <span class="comment">/*tokens=*/</span>1, aligned_head_dim, aligned_embed_dim);</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    }</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;}</div>
<div class="ttc" id="ackernel__engine_8h_html_af4f0e756d3ac00b45ce2c7a296b61ae3"><div class="ttname"><a href="ckernel__engine_8h.html#af4f0e756d3ac00b45ce2c7a296b61ae3">gemm_blocked_serial</a></div><div class="ttdeci">void gemm_blocked_serial(const float *A, const float *B, const float *bias, float *C, int M, int N, int K)</div><div class="ttdef"><b>Definition:</b> <a href="gemm__kernels_8c_source.html#l00642">gemm_kernels.c:642</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="gemm__kernels_8c_source.html#l00642">gemm_blocked_serial()</a>.</p>

<p class="reference">Referenced by <a class="el" href="ckernel__orchestration_8c_source.html#l01040">ck_layer_forward_rmsnorm_swiglu_decode()</a>, <a class="el" href="ckernel__orchestration_8c_source.html#l01198">ck_layer_forward_rmsnorm_swiglu_decode_fused()</a>, and <a class="el" href="attention__decode__fused_8c_source.html#l00165">ck_layer_forward_rmsnorm_swiglu_decode_fused_attn_impl()</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_40856f0cdd4bcafd28810d9265a200f7.html">kernels</a></li><li class="navelem"><a class="el" href="attention__decode__fused_8c.html">attention_decode_fused.c</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
