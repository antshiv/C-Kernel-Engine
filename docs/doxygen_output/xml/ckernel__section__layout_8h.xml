<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.9.1" xml:lang="en-US">
  <compounddef id="ckernel__section__layout_8h" kind="file" language="C++">
    <compoundname>ckernel_section_layout.h</compoundname>
    <includes local="no">stddef.h</includes>
    <includes local="no">stdint.h</includes>
    <incdepgraph>
      <node id="3">
        <label>stdint.h</label>
      </node>
      <node id="1">
        <label>ckernel_section_layout.h</label>
        <link refid="ckernel__section__layout_8h"/>
        <childnode refid="2" relation="include">
        </childnode>
        <childnode refid="3" relation="include">
        </childnode>
      </node>
      <node id="2">
        <label>stddef.h</label>
      </node>
    </incdepgraph>
    <innerclass refid="structCKFooterGradOffsets" prot="public">CKFooterGradOffsets</innerclass>
    <innerclass refid="structCKFooterOffsets" prot="public">CKFooterOffsets</innerclass>
    <innerclass refid="structCKHeaderOffsets" prot="public">CKHeaderOffsets</innerclass>
    <innerclass refid="structCKLayerGradOffsets" prot="public">CKLayerGradOffsets</innerclass>
    <innerclass refid="structCKLayerOffsets" prot="public">CKLayerOffsets</innerclass>
    <innerclass refid="structCKLayerOptimizerOffsets" prot="public">CKLayerOptimizerOffsets</innerclass>
    <innerclass refid="structCKModel" prot="public">CKModel</innerclass>
    <innerclass refid="structCKSection" prot="public">CKSection</innerclass>
    <innerclass refid="structCKSectionConfig" prot="public">CKSectionConfig</innerclass>
      <sectiondef kind="define">
      <memberdef kind="define" id="ckernel__section__layout_8h_1ad9ab657b96af3e55f3f6b56c799ef6a1" prot="public" static="no">
        <name>CK_ALIGN_CACHE</name>
        <initializer>64ULL           /* CPU cache line (64 bytes) */</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" line="88" column="9" bodyfile="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" bodystart="88" bodyend="-1"/>
      </memberdef>
      <memberdef kind="define" id="ckernel__section__layout_8h_1ad9dd86845c001eee80d1f249b848c08c" prot="public" static="no">
        <name>CK_ALIGN_HUGE_1GB</name>
        <initializer>(1ULL &lt;&lt; 30)    /* 1GB hugepage (NUMA optimal) */</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" line="91" column="9" bodyfile="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" bodystart="91" bodyend="-1"/>
      </memberdef>
      <memberdef kind="define" id="ckernel__section__layout_8h_1a99ca15bfe0225d4e7e71a7818eae2fe7" prot="public" static="no">
        <name>CK_ALIGN_HUGE_2MB</name>
        <initializer>(2ULL &lt;&lt; 20)    /* 2MB hugepage */</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" line="90" column="9" bodyfile="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" bodystart="90" bodyend="-1"/>
      </memberdef>
      <memberdef kind="define" id="ckernel__section__layout_8h_1a1a512f1e5caa9a5d3157053bdce18847" prot="public" static="no">
        <name>CK_ALIGN_SIMD</name>
        <initializer>64ULL           /* AVX-512 register (64 bytes) */</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" line="89" column="9" bodyfile="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" bodystart="89" bodyend="-1"/>
      </memberdef>
      <memberdef kind="define" id="ckernel__section__layout_8h_1adc318f4f8aa045cac46a382d033efea4" prot="public" static="no">
        <name>CK_FOOTER</name>
        <param><defname>model</defname></param>
        <param><defname>s</defname></param>
        <initializer>    (&amp;(model)-&gt;sections[s].footer)</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" line="541" column="9" bodyfile="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" bodystart="541" bodyend="-1"/>
      </memberdef>
      <memberdef kind="define" id="ckernel__section__layout_8h_1a6cd4d41f081a79df7ac57cc0d39e086f" prot="public" static="no">
        <name>CK_HEADER</name>
        <param><defname>model</defname></param>
        <param><defname>s</defname></param>
        <initializer>    (&amp;(model)-&gt;sections[s].header)</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" line="537" column="9" bodyfile="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" bodystart="537" bodyend="-1"/>
      </memberdef>
      <memberdef kind="define" id="ckernel__section__layout_8h_1abc25629d856fc301f5dcb0af8a63d03c" prot="public" static="no">
        <name>CK_LAYER</name>
        <param><defname>model</defname></param>
        <param><defname>s</defname></param>
        <param><defname>l</defname></param>
        <initializer>    (&amp;(model)-&gt;sections[s].layers[l])</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" line="529" column="9" bodyfile="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" bodystart="529" bodyend="-1"/>
      </memberdef>
      <memberdef kind="define" id="ckernel__section__layout_8h_1ac3349598b4a574599247b50fd72e0be6" prot="public" static="no">
        <name>CK_LAYER_GRAD</name>
        <param><defname>model</defname></param>
        <param><defname>s</defname></param>
        <param><defname>l</defname></param>
        <initializer>    (&amp;(model)-&gt;sections[s].layer_grads[l])</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" line="533" column="9" bodyfile="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" bodystart="533" bodyend="-1"/>
      </memberdef>
      <memberdef kind="define" id="ckernel__section__layout_8h_1aed689667a597546f4ca76393d018eb06" prot="public" static="no">
        <name>CK_PTR</name>
        <param><defname>model</defname></param>
        <param><defname>offset</defname></param>
        <initializer>    ((float*)((char*)(model)-&gt;base + (offset)))</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" line="522" column="9" bodyfile="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" bodystart="522" bodyend="-1"/>
      </memberdef>
      <memberdef kind="define" id="ckernel__section__layout_8h_1a8c3c24884f3f89455a6578875d6ebe40" prot="public" static="no">
        <name>CK_PTR_BF16</name>
        <param><defname>model</defname></param>
        <param><defname>offset</defname></param>
        <initializer>    ((uint16_t*)((char*)(model)-&gt;base + (offset)))</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" line="525" column="9" bodyfile="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" bodystart="525" bodyend="-1"/>
      </memberdef>
      </sectiondef>
      <sectiondef kind="enum">
      <memberdef kind="enum" id="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efe" prot="public" static="no" strong="no">
        <type></type>
        <name>CKFusionFlags</name>
        <enumvalue id="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efeac701cd87ffd41b651fdb39fd4d9231db" prot="public">
          <name>CK_FUSE_NONE</name>
          <initializer>= 0</initializer>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <enumvalue id="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efea45bba7ecc02555c097f51c9469157a21" prot="public">
          <name>CK_FUSE_EMBED_NORM</name>
          <initializer>= 1 &lt;&lt; 0</initializer>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <enumvalue id="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efea34b104e34a7aa0d0937ad1d8d064f0a9" prot="public">
          <name>CK_FUSE_NORM_QKV</name>
          <initializer>= 1 &lt;&lt; 1</initializer>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <enumvalue id="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efeabdee28d29574a516859ce8a97cdbe959" prot="public">
          <name>CK_FUSE_QKV_ROPE</name>
          <initializer>= 1 &lt;&lt; 2</initializer>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <enumvalue id="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efea43848ac20412b3e616a81b53bacb02ce" prot="public">
          <name>CK_FUSE_ATTN_PROJ</name>
          <initializer>= 1 &lt;&lt; 3</initializer>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <enumvalue id="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efeac49b63f12bae2e1fb3db203ec6a60fca" prot="public">
          <name>CK_FUSE_NORM_MLP</name>
          <initializer>= 1 &lt;&lt; 4</initializer>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <enumvalue id="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efeaa4b32bb297017e550a88ca82c0346b02" prot="public">
          <name>CK_FUSE_MLP_GATE_UP</name>
          <initializer>= 1 &lt;&lt; 5</initializer>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <enumvalue id="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efea97e883e02f60415d64767579e4b65eb2" prot="public">
          <name>CK_FUSE_MLP_ACT_DOWN</name>
          <initializer>= 1 &lt;&lt; 6</initializer>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <enumvalue id="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efea784a02f46d179bd5baf2ae6c9b628a7a" prot="public">
          <name>CK_FUSE_ADD_NORM</name>
          <initializer>= 1 &lt;&lt; 7</initializer>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <enumvalue id="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efeac701cd87ffd41b651fdb39fd4d9231db" prot="public">
          <name>CK_FUSE_NONE</name>
          <initializer>= 0</initializer>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <enumvalue id="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efea45bba7ecc02555c097f51c9469157a21" prot="public">
          <name>CK_FUSE_EMBED_NORM</name>
          <initializer>= 1 &lt;&lt; 0</initializer>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <enumvalue id="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efea34b104e34a7aa0d0937ad1d8d064f0a9" prot="public">
          <name>CK_FUSE_NORM_QKV</name>
          <initializer>= 1 &lt;&lt; 1</initializer>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <enumvalue id="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efeabdee28d29574a516859ce8a97cdbe959" prot="public">
          <name>CK_FUSE_QKV_ROPE</name>
          <initializer>= 1 &lt;&lt; 2</initializer>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <enumvalue id="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efea43848ac20412b3e616a81b53bacb02ce" prot="public">
          <name>CK_FUSE_ATTN_PROJ</name>
          <initializer>= 1 &lt;&lt; 3</initializer>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <enumvalue id="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efeac49b63f12bae2e1fb3db203ec6a60fca" prot="public">
          <name>CK_FUSE_NORM_MLP</name>
          <initializer>= 1 &lt;&lt; 4</initializer>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <enumvalue id="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efeaa4b32bb297017e550a88ca82c0346b02" prot="public">
          <name>CK_FUSE_MLP_GATE_UP</name>
          <initializer>= 1 &lt;&lt; 5</initializer>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <enumvalue id="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efea97e883e02f60415d64767579e4b65eb2" prot="public">
          <name>CK_FUSE_MLP_ACT_DOWN</name>
          <initializer>= 1 &lt;&lt; 6</initializer>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <enumvalue id="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efea6a3bb26ab9dcc8bb90714a3c77250997" prot="public">
          <name>CK_FUSE_RESIDUAL_NORM</name>
          <initializer>= 1 &lt;&lt; 7</initializer>
          <briefdescription>
          </briefdescription>
          <detaileddescription>
          </detaileddescription>
        </enumvalue>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" line="459" column="1" bodyfile="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" bodystart="459" bodyend="469"/>
      </memberdef>
      </sectiondef>
      <sectiondef kind="func">
      <memberdef kind="function" id="ckernel__section__layout_8h_1a8d52ec7a90940748c493c1e6cbb2675e" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>int ck_model_allocate</definition>
        <argsstring>(CKModel *model, int hugepage_mode)</argsstring>
        <name>ck_model_allocate</name>
        <param>
          <type><ref refid="structCKModel" kindref="compound">CKModel</ref> *</type>
          <declname>model</declname>
        </param>
        <param>
          <type>int</type>
          <declname>hugepage_mode</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Allocate the planned memory. <parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>hugepage_mode</parametername>
</parameternamelist>
<parameterdescription>
<para>0=normal, 1=2MB hugepages, 2=1GB hugepages </para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>0 on success, -1 on failure </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" line="508" column="5" declfile="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" declline="508" declcolumn="5"/>
      </memberdef>
      <memberdef kind="function" id="ckernel__section__layout_8h_1a1098b7df468a5ac5164b440b6e08209f" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void ck_model_free</definition>
        <argsstring>(CKModel *model)</argsstring>
        <name>ck_model_free</name>
        <param>
          <type><ref refid="structCKModel" kindref="compound">CKModel</ref> *</type>
          <declname>model</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Free the model (single free, since single allocation). </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" line="513" column="6" declfile="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" declline="513" declcolumn="6"/>
      </memberdef>
      <memberdef kind="function" id="ckernel__section__layout_8h_1a82b72b659b7ce81f24b3f79b101ab6d4" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>size_t</type>
        <definition>size_t ck_model_plan</definition>
        <argsstring>(CKModel *model, const CKSectionConfig *configs, int num_sections, int training_enabled, uint32_t fusion_flags)</argsstring>
        <name>ck_model_plan</name>
        <param>
          <type><ref refid="structCKModel" kindref="compound">CKModel</ref> *</type>
          <declname>model</declname>
        </param>
        <param>
          <type>const <ref refid="structCKSectionConfig" kindref="compound">CKSectionConfig</ref> *</type>
          <declname>configs</declname>
        </param>
        <param>
          <type>int</type>
          <declname>num_sections</declname>
        </param>
        <param>
          <type>int</type>
          <declname>training_enabled</declname>
        </param>
        <param>
          <type>uint32_t</type>
          <declname>fusion_flags</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Plan memory layout for complete model. Returns total bytes needed. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" line="497" column="8" declfile="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" declline="497" declcolumn="8"/>
      </memberdef>
      <memberdef kind="function" id="ckernel__section__layout_8h_1a45ba8ddf4f1d6280681d37136dbc3a5a" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void ck_section_config_init</definition>
        <argsstring>(CKSectionConfig *config, size_t simd_align)</argsstring>
        <name>ck_section_config_init</name>
        <param>
          <type><ref refid="structCKSectionConfig" kindref="compound">CKSectionConfig</ref> *</type>
          <declname>config</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>simd_align</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Initialize section config with computed alignments. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" line="482" column="6" declfile="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" declline="482" declcolumn="6"/>
      </memberdef>
      <memberdef kind="function" id="ckernel__section__layout_8h_1a7a3e8075d666d342c725cea328322cd2" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>size_t</type>
        <definition>size_t ck_section_plan</definition>
        <argsstring>(CKSection *section, const CKSectionConfig *config, int training_enabled, size_t base_offset)</argsstring>
        <name>ck_section_plan</name>
        <param>
          <type><ref refid="structCKSection" kindref="compound">CKSection</ref> *</type>
          <declname>section</declname>
        </param>
        <param>
          <type>const <ref refid="structCKSectionConfig" kindref="compound">CKSectionConfig</ref> *</type>
          <declname>config</declname>
        </param>
        <param>
          <type>int</type>
          <declname>training_enabled</declname>
        </param>
        <param>
          <type>size_t</type>
          <declname>base_offset</declname>
        </param>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>Plan memory layout for a single section. Returns bytes needed for this section. </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" line="488" column="8" declfile="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h" declline="488" declcolumn="8"/>
      </memberdef>
      </sectiondef>
    <briefdescription>
<para>Section-Based Memory Layout: Header / Body / Footer Pattern. </para>
    </briefdescription>
    <detaileddescription>
<para><hruler/>
 </para>
<sect1 id="ckernel__section__layout_8h_1autotoc_md3">
<title>PHILOSOPHY: WHY NO MEMORY REUSE?</title>
<para><orderedlist>
<listitem><para>CPU PREFETCH NEEDS PREDICTABLE PATTERNS<itemizedlist>
<listitem><para>Prefetcher learns: &quot;he&apos;s streaming forward through memory&quot;</para>
</listitem><listitem><para>Reuse breaks this: same address, different data, different time</para>
</listitem><listitem><para>Result: prefetcher gives up, cache misses explode</para>
</listitem></itemizedlist>
</para>
</listitem><listitem><para>TRAINING NEEDS ALL ACTIVATIONS<itemizedlist>
<listitem><para>Forward: compute activations</para>
</listitem><listitem><para>Backward: need EVERY activation to compute gradients</para>
</listitem><listitem><para>Can&apos;t reuse what you still need!</para>
</listitem></itemizedlist>
</para>
</listitem><listitem><para>MEMORY IS CHEAP, BANDWIDTH IS EXPENSIVE<itemizedlist>
<listitem><para>DDR5: ~$3/GB (1TB = $3000, trivial for training cluster)</para>
</listitem><listitem><para>Bandwidth: 100-400 GB/s per socket (the real bottleneck)</para>
</listitem><listitem><para>Optimize for streaming, not for saving bytes</para>
</listitem></itemizedlist>
</para>
</listitem><listitem><para>SINGLE ALLOCATION = ZERO RUNTIME MALLOC<itemizedlist>
<listitem><para>No fragmentation, no free(), no double-free bugs</para>
</listitem><listitem><para>Hugepage-backed: 1GB pages for NUMA optimization</para>
</listitem><listitem><para>One base pointer + offsets = maximum simplicity</para>
</listitem></itemizedlist>
</para>
</listitem></orderedlist>
</para>
<para><hruler/>
 </para>
</sect1>
<sect1 id="ckernel__section__layout_8h_1autotoc_md5">
<title>SECTION ARCHITECTURE</title>
<para>Multi-modal models have multiple SECTIONS. Each section is a complete encoder/decoder/vision/audio module with its own dimensions.</para>
<para>┌─────────────────────────────────────────────────────────────────┐ │ SINGLE ALLOCATION │ ├─────────────────────────────────────────────────────────────────┤ │ SECTION 0: Vision Encoder │ │ ├── HEADER: patch_embed, pos_embed │ │ ├── BODY: layer[0..N] (weights + activations interleaved) │ │ └── FOOTER: final_norm, bridge_to_text │ ├─────────────────────────────────────────────────────────────────┤ │ SECTION 1: Text Decoder │ │ ├── HEADER: token_embed, pos_embed │ │ ├── BODY: layer[0..N] (weights + activations interleaved) │ │ └── FOOTER: final_norm, lm_head, logits │ ├─────────────────────────────────────────────────────────────────┤ │ SECTION 2: Audio Encoder (optional) │ │ ├── HEADER: mel_embed │ │ ├── BODY: layer[0..N] │ │ └── FOOTER: bridge_to_text │ ├─────────────────────────────────────────────────────────────────┤ │ GRADIENTS (if training) │ │ └── Same layout: section[0].grads, section[1].grads, ... │ ├─────────────────────────────────────────────────────────────────┤ │ OPTIMIZER STATE (if training with Adam) │ │ └── m[], v[] for each weight │ └─────────────────────────────────────────────────────────────────┘</para>
<para><hruler/>
 </para>
</sect1>
<sect1 id="ckernel__section__layout_8h_1autotoc_md7">
<title>EXECUTION ORDER LAYOUT</title>
<para>Within each layer, memory is laid out in the ORDER operations execute:</para>
<para>weight → activation → weight → activation → ...</para>
<para>This is critical for CPU cache efficiency. The CPU streams forward, prefetching the next cache line while processing the current one. </para>
</sect1>
    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="comment">/**</highlight></codeline>
<codeline lineno="2"><highlight class="comment"><sp/>*<sp/>@file<sp/>ckernel_section_layout.h</highlight></codeline>
<codeline lineno="3"><highlight class="comment"><sp/>*<sp/>@brief<sp/>Section-Based<sp/>Memory<sp/>Layout:<sp/>Header<sp/>/<sp/>Body<sp/>/<sp/>Footer<sp/>Pattern</highlight></codeline>
<codeline lineno="4"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="5"><highlight class="comment"><sp/>*<sp/>=============================================================================</highlight></codeline>
<codeline lineno="6"><highlight class="comment"><sp/>*<sp/>PHILOSOPHY:<sp/>WHY<sp/>NO<sp/>MEMORY<sp/>REUSE?</highlight></codeline>
<codeline lineno="7"><highlight class="comment"><sp/>*<sp/>=============================================================================</highlight></codeline>
<codeline lineno="8"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="9"><highlight class="comment"><sp/>*<sp/>1.<sp/>CPU<sp/>PREFETCH<sp/>NEEDS<sp/>PREDICTABLE<sp/>PATTERNS</highlight></codeline>
<codeline lineno="10"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/>-<sp/>Prefetcher<sp/>learns:<sp/>&quot;he&apos;s<sp/>streaming<sp/>forward<sp/>through<sp/>memory&quot;</highlight></codeline>
<codeline lineno="11"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/>-<sp/>Reuse<sp/>breaks<sp/>this:<sp/>same<sp/>address,<sp/>different<sp/>data,<sp/>different<sp/>time</highlight></codeline>
<codeline lineno="12"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/>-<sp/>Result:<sp/>prefetcher<sp/>gives<sp/>up,<sp/>cache<sp/>misses<sp/>explode</highlight></codeline>
<codeline lineno="13"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="14"><highlight class="comment"><sp/>*<sp/>2.<sp/>TRAINING<sp/>NEEDS<sp/>ALL<sp/>ACTIVATIONS</highlight></codeline>
<codeline lineno="15"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/>-<sp/>Forward:<sp/>compute<sp/>activations</highlight></codeline>
<codeline lineno="16"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/>-<sp/>Backward:<sp/>need<sp/>EVERY<sp/>activation<sp/>to<sp/>compute<sp/>gradients</highlight></codeline>
<codeline lineno="17"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/>-<sp/>Can&apos;t<sp/>reuse<sp/>what<sp/>you<sp/>still<sp/>need!</highlight></codeline>
<codeline lineno="18"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="19"><highlight class="comment"><sp/>*<sp/>3.<sp/>MEMORY<sp/>IS<sp/>CHEAP,<sp/>BANDWIDTH<sp/>IS<sp/>EXPENSIVE</highlight></codeline>
<codeline lineno="20"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/>-<sp/>DDR5:<sp/>~$3/GB<sp/>(1TB<sp/>=<sp/>$3000,<sp/>trivial<sp/>for<sp/>training<sp/>cluster)</highlight></codeline>
<codeline lineno="21"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/>-<sp/>Bandwidth:<sp/>100-400<sp/>GB/s<sp/>per<sp/>socket<sp/>(the<sp/>real<sp/>bottleneck)</highlight></codeline>
<codeline lineno="22"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/>-<sp/>Optimize<sp/>for<sp/>streaming,<sp/>not<sp/>for<sp/>saving<sp/>bytes</highlight></codeline>
<codeline lineno="23"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="24"><highlight class="comment"><sp/>*<sp/>4.<sp/>SINGLE<sp/>ALLOCATION<sp/>=<sp/>ZERO<sp/>RUNTIME<sp/>MALLOC</highlight></codeline>
<codeline lineno="25"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/>-<sp/>No<sp/>fragmentation,<sp/>no<sp/>free(),<sp/>no<sp/>double-free<sp/>bugs</highlight></codeline>
<codeline lineno="26"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/>-<sp/>Hugepage-backed:<sp/>1GB<sp/>pages<sp/>for<sp/>NUMA<sp/>optimization</highlight></codeline>
<codeline lineno="27"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/>-<sp/>One<sp/>base<sp/>pointer<sp/>+<sp/>offsets<sp/>=<sp/>maximum<sp/>simplicity</highlight></codeline>
<codeline lineno="28"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="29"><highlight class="comment"><sp/>*<sp/>=============================================================================</highlight></codeline>
<codeline lineno="30"><highlight class="comment"><sp/>*<sp/>SECTION<sp/>ARCHITECTURE</highlight></codeline>
<codeline lineno="31"><highlight class="comment"><sp/>*<sp/>=============================================================================</highlight></codeline>
<codeline lineno="32"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="33"><highlight class="comment"><sp/>*<sp/>Multi-modal<sp/>models<sp/>have<sp/>multiple<sp/>SECTIONS.<sp/>Each<sp/>section<sp/>is<sp/>a<sp/>complete</highlight></codeline>
<codeline lineno="34"><highlight class="comment"><sp/>*<sp/>encoder/decoder/vision/audio<sp/>module<sp/>with<sp/>its<sp/>own<sp/>dimensions.</highlight></codeline>
<codeline lineno="35"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="36"><highlight class="comment"><sp/>*<sp/><sp/><sp/>┌─────────────────────────────────────────────────────────────────┐</highlight></codeline>
<codeline lineno="37"><highlight class="comment"><sp/>*<sp/><sp/><sp/>│<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>SINGLE<sp/>ALLOCATION<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>│</highlight></codeline>
<codeline lineno="38"><highlight class="comment"><sp/>*<sp/><sp/><sp/>├─────────────────────────────────────────────────────────────────┤</highlight></codeline>
<codeline lineno="39"><highlight class="comment"><sp/>*<sp/><sp/><sp/>│<sp/>SECTION<sp/>0:<sp/>Vision<sp/>Encoder<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>│</highlight></codeline>
<codeline lineno="40"><highlight class="comment"><sp/>*<sp/><sp/><sp/>│<sp/><sp/><sp/>├──<sp/>HEADER:<sp/>patch_embed,<sp/>pos_embed<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>│</highlight></codeline>
<codeline lineno="41"><highlight class="comment"><sp/>*<sp/><sp/><sp/>│<sp/><sp/><sp/>├──<sp/>BODY:<sp/><sp/><sp/>layer[0..N]<sp/>(weights<sp/>+<sp/>activations<sp/>interleaved)<sp/><sp/>│</highlight></codeline>
<codeline lineno="42"><highlight class="comment"><sp/>*<sp/><sp/><sp/>│<sp/><sp/><sp/>└──<sp/>FOOTER:<sp/>final_norm,<sp/>bridge_to_text<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>│</highlight></codeline>
<codeline lineno="43"><highlight class="comment"><sp/>*<sp/><sp/><sp/>├─────────────────────────────────────────────────────────────────┤</highlight></codeline>
<codeline lineno="44"><highlight class="comment"><sp/>*<sp/><sp/><sp/>│<sp/>SECTION<sp/>1:<sp/>Text<sp/>Decoder<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>│</highlight></codeline>
<codeline lineno="45"><highlight class="comment"><sp/>*<sp/><sp/><sp/>│<sp/><sp/><sp/>├──<sp/>HEADER:<sp/>token_embed,<sp/>pos_embed<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>│</highlight></codeline>
<codeline lineno="46"><highlight class="comment"><sp/>*<sp/><sp/><sp/>│<sp/><sp/><sp/>├──<sp/>BODY:<sp/><sp/><sp/>layer[0..N]<sp/>(weights<sp/>+<sp/>activations<sp/>interleaved)<sp/><sp/>│</highlight></codeline>
<codeline lineno="47"><highlight class="comment"><sp/>*<sp/><sp/><sp/>│<sp/><sp/><sp/>└──<sp/>FOOTER:<sp/>final_norm,<sp/>lm_head,<sp/>logits<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>│</highlight></codeline>
<codeline lineno="48"><highlight class="comment"><sp/>*<sp/><sp/><sp/>├─────────────────────────────────────────────────────────────────┤</highlight></codeline>
<codeline lineno="49"><highlight class="comment"><sp/>*<sp/><sp/><sp/>│<sp/>SECTION<sp/>2:<sp/>Audio<sp/>Encoder<sp/>(optional)<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>│</highlight></codeline>
<codeline lineno="50"><highlight class="comment"><sp/>*<sp/><sp/><sp/>│<sp/><sp/><sp/>├──<sp/>HEADER:<sp/>mel_embed<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>│</highlight></codeline>
<codeline lineno="51"><highlight class="comment"><sp/>*<sp/><sp/><sp/>│<sp/><sp/><sp/>├──<sp/>BODY:<sp/><sp/><sp/>layer[0..N]<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>│</highlight></codeline>
<codeline lineno="52"><highlight class="comment"><sp/>*<sp/><sp/><sp/>│<sp/><sp/><sp/>└──<sp/>FOOTER:<sp/>bridge_to_text<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>│</highlight></codeline>
<codeline lineno="53"><highlight class="comment"><sp/>*<sp/><sp/><sp/>├─────────────────────────────────────────────────────────────────┤</highlight></codeline>
<codeline lineno="54"><highlight class="comment"><sp/>*<sp/><sp/><sp/>│<sp/>GRADIENTS<sp/>(if<sp/>training)<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>│</highlight></codeline>
<codeline lineno="55"><highlight class="comment"><sp/>*<sp/><sp/><sp/>│<sp/><sp/><sp/>└──<sp/>Same<sp/>layout:<sp/>section[0].grads,<sp/>section[1].grads,<sp/>...<sp/><sp/><sp/><sp/><sp/>│</highlight></codeline>
<codeline lineno="56"><highlight class="comment"><sp/>*<sp/><sp/><sp/>├─────────────────────────────────────────────────────────────────┤</highlight></codeline>
<codeline lineno="57"><highlight class="comment"><sp/>*<sp/><sp/><sp/>│<sp/>OPTIMIZER<sp/>STATE<sp/>(if<sp/>training<sp/>with<sp/>Adam)<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>│</highlight></codeline>
<codeline lineno="58"><highlight class="comment"><sp/>*<sp/><sp/><sp/>│<sp/><sp/><sp/>└──<sp/>m[],<sp/>v[]<sp/>for<sp/>each<sp/>weight<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>│</highlight></codeline>
<codeline lineno="59"><highlight class="comment"><sp/>*<sp/><sp/><sp/>└─────────────────────────────────────────────────────────────────┘</highlight></codeline>
<codeline lineno="60"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="61"><highlight class="comment"><sp/>*<sp/>=============================================================================</highlight></codeline>
<codeline lineno="62"><highlight class="comment"><sp/>*<sp/>EXECUTION<sp/>ORDER<sp/>LAYOUT</highlight></codeline>
<codeline lineno="63"><highlight class="comment"><sp/>*<sp/>=============================================================================</highlight></codeline>
<codeline lineno="64"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="65"><highlight class="comment"><sp/>*<sp/>Within<sp/>each<sp/>layer,<sp/>memory<sp/>is<sp/>laid<sp/>out<sp/>in<sp/>the<sp/>ORDER<sp/>operations<sp/>execute:</highlight></codeline>
<codeline lineno="66"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="67"><highlight class="comment"><sp/>*<sp/><sp/><sp/>weight<sp/>→<sp/>activation<sp/>→<sp/>weight<sp/>→<sp/>activation<sp/>→<sp/>...</highlight></codeline>
<codeline lineno="68"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="69"><highlight class="comment"><sp/>*<sp/>This<sp/>is<sp/>critical<sp/>for<sp/>CPU<sp/>cache<sp/>efficiency.<sp/>The<sp/>CPU<sp/>streams<sp/>forward,</highlight></codeline>
<codeline lineno="70"><highlight class="comment"><sp/>*<sp/>prefetching<sp/>the<sp/>next<sp/>cache<sp/>line<sp/>while<sp/>processing<sp/>the<sp/>current<sp/>one.</highlight></codeline>
<codeline lineno="71"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="72"><highlight class="comment"><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="73"><highlight class="normal"></highlight></codeline>
<codeline lineno="74"><highlight class="normal"></highlight><highlight class="preprocessor">#ifndef<sp/>CKERNEL_SECTION_LAYOUT_H</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="75"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>CKERNEL_SECTION_LAYOUT_H</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="76"><highlight class="normal"></highlight></codeline>
<codeline lineno="77"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;stddef.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="78"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;stdint.h&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="79"><highlight class="normal"></highlight></codeline>
<codeline lineno="80"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>__cplusplus</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="81"><highlight class="normal"></highlight><highlight class="keyword">extern</highlight><highlight class="normal"><sp/></highlight><highlight class="stringliteral">&quot;C&quot;</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="82"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="83"><highlight class="normal"></highlight></codeline>
<codeline lineno="84"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="85"><highlight class="comment"><sp/>*<sp/>ALIGNMENT<sp/>CONSTANTS</highlight></codeline>
<codeline lineno="86"><highlight class="comment"><sp/>*<sp/>============================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="87"><highlight class="normal"></highlight></codeline>
<codeline lineno="88" refid="ckernel__section__layout_8h_1ad9ab657b96af3e55f3f6b56c799ef6a1" refkind="member"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>CK_ALIGN_CACHE<sp/><sp/><sp/><sp/><sp/><sp/>64ULL<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>CPU<sp/>cache<sp/>line<sp/>(64<sp/>bytes)<sp/>*/</highlight><highlight class="preprocessor"></highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="89" refid="ckernel__section__layout_8h_1a1a512f1e5caa9a5d3157053bdce18847" refkind="member"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>CK_ALIGN_SIMD<sp/><sp/><sp/><sp/><sp/><sp/><sp/>64ULL<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>AVX-512<sp/>register<sp/>(64<sp/>bytes)<sp/>*/</highlight><highlight class="preprocessor"></highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="90" refid="ckernel__section__layout_8h_1a99ca15bfe0225d4e7e71a7818eae2fe7" refkind="member"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>CK_ALIGN_HUGE_2MB<sp/><sp/><sp/>(2ULL<sp/>&lt;&lt;<sp/>20)<sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>2MB<sp/>hugepage<sp/>*/</highlight><highlight class="preprocessor"></highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="91" refid="ckernel__section__layout_8h_1ad9dd86845c001eee80d1f249b848c08c" refkind="member"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>CK_ALIGN_HUGE_1GB<sp/><sp/><sp/>(1ULL<sp/>&lt;&lt;<sp/>30)<sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>1GB<sp/>hugepage<sp/>(NUMA<sp/>optimal)<sp/>*/</highlight><highlight class="preprocessor"></highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="92"><highlight class="normal"></highlight></codeline>
<codeline lineno="93"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="94"><highlight class="comment"><sp/>*<sp/>SECTION<sp/>CONFIG</highlight></codeline>
<codeline lineno="95"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="96"><highlight class="comment"><sp/>*<sp/>Each<sp/>section<sp/>(encoder/decoder/vision/audio)<sp/>has<sp/>its<sp/>own<sp/>dimensions.</highlight></codeline>
<codeline lineno="97"><highlight class="comment"><sp/>*<sp/>A<sp/>vision<sp/>encoder<sp/>might<sp/>have<sp/>embed_dim=1024,<sp/>while<sp/>text<sp/>decoder<sp/>has<sp/>4096.</highlight></codeline>
<codeline lineno="98"><highlight class="comment"><sp/>*<sp/>============================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="99"><highlight class="normal"></highlight></codeline>
<codeline lineno="100"><highlight class="normal"></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="101"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>DIMENSIONS<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="102"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>embed_dim;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>hidden_size<sp/>for<sp/>this<sp/>section<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="103"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>num_heads;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>attention<sp/>heads<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="104"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>num_kv_heads;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>key-value<sp/>heads<sp/>(for<sp/>GQA)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="105"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>head_dim;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>embed_dim<sp/>/<sp/>num_heads<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="106"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>intermediate_dim;<sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>MLP<sp/>hidden<sp/>dimension<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="107"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>num_layers;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>transformer<sp/>layers<sp/>in<sp/>this<sp/>section<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="108"><highlight class="normal"></highlight></codeline>
<codeline lineno="109"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>VOCABULARY<sp/>(optional,<sp/>only<sp/>for<sp/>sections<sp/>with<sp/>embeddings)<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="110"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>vocab_size;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>0<sp/>if<sp/>no<sp/>token<sp/>embedding<sp/>in<sp/>this<sp/>section<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="111"><highlight class="normal"></highlight></codeline>
<codeline lineno="112"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>SEQUENCE<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="113"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>max_seq_len;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>maximum<sp/>sequence<sp/>length<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="114"><highlight class="normal"></highlight></codeline>
<codeline lineno="115"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>ALIGNED<sp/>DIMENSIONS<sp/>(computed,<sp/>for<sp/>SIMD)<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="116"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>aligned_embed;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>embed_dim<sp/>padded<sp/>to<sp/>SIMD<sp/>boundary<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="117"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>aligned_head;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>head_dim<sp/>padded<sp/>to<sp/>SIMD<sp/>boundary<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="118"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>aligned_intermediate;<sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>intermediate_dim<sp/>padded<sp/>to<sp/>SIMD<sp/>boundary<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="119"><highlight class="normal"></highlight></codeline>
<codeline lineno="120"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>FEATURES<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="121" refid="structCKSectionConfig_1a42f1619a5ca0b7dbee3506ab18f994e5" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="structCKSectionConfig_1a42f1619a5ca0b7dbee3506ab18f994e5" kindref="member">has_bias</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>1<sp/>if<sp/>layers<sp/>have<sp/>bias<sp/>terms<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="122" refid="structCKSectionConfig_1a4022d24bbcdac19db5fa032e6f02480f" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="structCKSectionConfig_1a4022d24bbcdac19db5fa032e6f02480f" kindref="member">has_rope</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>1<sp/>if<sp/>using<sp/>rotary<sp/>position<sp/>embeddings<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="123" refid="structCKSectionConfig_1a5309473074acf80aeb6e9ac8ec68bbc8" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="structCKSectionConfig_1a5309473074acf80aeb6e9ac8ec68bbc8" kindref="member">has_pos_embed</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>1<sp/>if<sp/>using<sp/>learned<sp/>position<sp/>embeddings<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="124" refid="structCKSectionConfig_1a3348e1ea8c54d4e25647daa3685da89a" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="structCKSectionConfig_1a3348e1ea8c54d4e25647daa3685da89a" kindref="member">gated_mlp</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>1<sp/>if<sp/>MLP<sp/>is<sp/>gated<sp/>(SwiGLU/GeGLU)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="125" refid="structCKSectionConfig_1a96ef28b42bf7654f3eeb5167950f31e9" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="structCKSectionConfig_1a96ef28b42bf7654f3eeb5167950f31e9" kindref="member">norm_type</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>0=LayerNorm,<sp/>1=RMSNorm<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="126"><highlight class="normal"></highlight></codeline>
<codeline lineno="127"><highlight class="normal">}<sp/><ref refid="structCKSectionConfig" kindref="compound">CKSectionConfig</ref>;</highlight></codeline>
<codeline lineno="128"><highlight class="normal"></highlight></codeline>
<codeline lineno="129"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="130"><highlight class="comment"><sp/>*<sp/>HEADER<sp/>OFFSETS</highlight></codeline>
<codeline lineno="131"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="132"><highlight class="comment"><sp/>*<sp/>The<sp/>HEADER<sp/>contains<sp/>embeddings<sp/>that<sp/>happen<sp/>BEFORE<sp/>the<sp/>transformer<sp/>layers.</highlight></codeline>
<codeline lineno="133"><highlight class="comment"><sp/>*<sp/>For<sp/>text:<sp/>token<sp/>embeddings<sp/>+<sp/>position<sp/>embeddings</highlight></codeline>
<codeline lineno="134"><highlight class="comment"><sp/>*<sp/>For<sp/>vision:<sp/>patch<sp/>embeddings<sp/>+<sp/>position<sp/>embeddings</highlight></codeline>
<codeline lineno="135"><highlight class="comment"><sp/>*<sp/>For<sp/>audio:<sp/>mel-spectrogram<sp/>projection</highlight></codeline>
<codeline lineno="136"><highlight class="comment"><sp/>*<sp/>============================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="137"><highlight class="normal"></highlight></codeline>
<codeline lineno="138" refid="structCKHeaderOffsets" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="139"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>TOKEN/PATCH<sp/>EMBEDDING<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="140" refid="structCKHeaderOffsets_1a09edd285803f7fecfbfe1a80ec241b23" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKHeaderOffsets_1a09edd285803f7fecfbfe1a80ec241b23" kindref="member">embed_weight</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[vocab_size,<sp/>embed_dim]<sp/>or<sp/>[patch_dim,<sp/>embed_dim]<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="141" refid="structCKHeaderOffsets_1a1c5c78d482920812a8353fe8b31a9038" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKHeaderOffsets_1a1c5c78d482920812a8353fe8b31a9038" kindref="member">embed_output</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[seq_len,<sp/>embed_dim]<sp/>activation<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="142"><highlight class="normal"></highlight></codeline>
<codeline lineno="143"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>POSITION<sp/>EMBEDDING<sp/>(if<sp/>learned)<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="144" refid="structCKHeaderOffsets_1a5869de8e522fdd1b310d75bd8eb849bb" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKHeaderOffsets_1a5869de8e522fdd1b310d75bd8eb849bb" kindref="member">pos_embed_weight</ref>;<sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[max_seq_len,<sp/>embed_dim]<sp/>weight<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="145" refid="structCKHeaderOffsets_1a2a082e03809f5e60dc469836ec86e553" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKHeaderOffsets_1a2a082e03809f5e60dc469836ec86e553" kindref="member">pos_embed_output</ref>;<sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[seq_len,<sp/>embed_dim]<sp/>activation<sp/>(added<sp/>to<sp/>embed)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="146"><highlight class="normal"></highlight></codeline>
<codeline lineno="147"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>COMBINED<sp/>OUTPUT<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="148" refid="structCKHeaderOffsets_1af6277b6a25c2312f49d22592e268dab0" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKHeaderOffsets_1af6277b6a25c2312f49d22592e268dab0" kindref="member">header_output</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[seq_len,<sp/>embed_dim]<sp/>=<sp/>embed<sp/>+<sp/>pos<sp/>(input<sp/>to<sp/>body)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="149"><highlight class="normal"></highlight></codeline>
<codeline lineno="150"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>BYTE<sp/>BOUNDARIES<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="151" refid="structCKHeaderOffsets_1a8bd89231afd3b0a519c8491e955504df" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKHeaderOffsets_1a8bd89231afd3b0a519c8491e955504df" kindref="member">header_start</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>first<sp/>byte<sp/>of<sp/>header<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="152" refid="structCKHeaderOffsets_1acb634ce1abbf44e2ee2791e8a1d1817e" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKHeaderOffsets_1acb634ce1abbf44e2ee2791e8a1d1817e" kindref="member">header_end</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>last<sp/>byte<sp/>+<sp/>1<sp/>of<sp/>header<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="153"><highlight class="normal"></highlight></codeline>
<codeline lineno="154"><highlight class="normal">}<sp/><ref refid="structCKHeaderOffsets" kindref="compound">CKHeaderOffsets</ref>;</highlight></codeline>
<codeline lineno="155"><highlight class="normal"></highlight></codeline>
<codeline lineno="156"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="157"><highlight class="comment"><sp/>*<sp/>LAYER<sp/>OFFSETS<sp/>(within<sp/>BODY)</highlight></codeline>
<codeline lineno="158"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="159"><highlight class="comment"><sp/>*<sp/>Each<sp/>layer&apos;s<sp/>memory<sp/>is<sp/>laid<sp/>out<sp/>in<sp/>EXECUTION<sp/>ORDER:</highlight></codeline>
<codeline lineno="160"><highlight class="comment"><sp/>*<sp/><sp/><sp/>pre_norm<sp/>→<sp/>qkv_proj<sp/>→<sp/>rope<sp/>→<sp/>attention<sp/>→<sp/>out_proj<sp/>→<sp/>residual<sp/>→</highlight></codeline>
<codeline lineno="161"><highlight class="comment"><sp/>*<sp/><sp/><sp/>post_norm<sp/>→<sp/>mlp_gate<sp/>→<sp/>mlp_up<sp/>→<sp/>activation<sp/>→<sp/>mlp_down<sp/>→<sp/>residual</highlight></codeline>
<codeline lineno="162"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="163"><highlight class="comment"><sp/>*<sp/>Weights<sp/>and<sp/>activations<sp/>are<sp/>INTERLEAVED,<sp/>not<sp/>separated.</highlight></codeline>
<codeline lineno="164"><highlight class="comment"><sp/>*<sp/>============================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="165"><highlight class="normal"></highlight></codeline>
<codeline lineno="166"><highlight class="normal"></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="167"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>LAYER<sp/>INPUT<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="168" refid="structCKLayerOffsets_1a207b51ce0a5d8afb92fbb3f810ca4574" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKLayerOffsets_1a207b51ce0a5d8afb92fbb3f810ca4574" kindref="member">input</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[seq,<sp/>embed]<sp/>activation<sp/>(from<sp/>previous<sp/>layer<sp/>or<sp/>header)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="169"><highlight class="normal"></highlight></codeline>
<codeline lineno="170"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>==========<sp/>ATTENTION<sp/>BLOCK<sp/>==========<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="171"><highlight class="normal"></highlight></codeline>
<codeline lineno="172"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Pre-Attention<sp/>Normalization<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="173"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>ln1_gamma;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[embed]<sp/>weight<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="174"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>ln1_beta;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[embed]<sp/>weight<sp/>(NULL<sp/>if<sp/>RMSNorm)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="175"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>ln1_output;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[seq,<sp/>embed]<sp/>activation<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="176"><highlight class="normal"></highlight></codeline>
<codeline lineno="177"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Q<sp/>Projection<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="178"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>wq;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[embed,<sp/>num_heads<sp/>*<sp/>head_dim]<sp/>weight<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="179"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>bq;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[num_heads<sp/>*<sp/>head_dim]<sp/>bias<sp/>(optional)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="180"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>q;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[seq,<sp/>num_heads,<sp/>head_dim]<sp/>activation<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="181"><highlight class="normal"></highlight></codeline>
<codeline lineno="182"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>K<sp/>Projection<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="183"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>wk;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[embed,<sp/>num_kv_heads<sp/>*<sp/>head_dim]<sp/>weight<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="184"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>bk;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[num_kv_heads<sp/>*<sp/>head_dim]<sp/>bias<sp/>(optional)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="185"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>k;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[seq,<sp/>num_kv_heads,<sp/>head_dim]<sp/>activation<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="186"><highlight class="normal"></highlight></codeline>
<codeline lineno="187"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>V<sp/>Projection<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="188"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>wv;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[embed,<sp/>num_kv_heads<sp/>*<sp/>head_dim]<sp/>weight<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="189"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>bv;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[num_kv_heads<sp/>*<sp/>head_dim]<sp/>bias<sp/>(optional)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="190"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>v;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[seq,<sp/>num_kv_heads,<sp/>head_dim]<sp/>activation<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="191"><highlight class="normal"></highlight></codeline>
<codeline lineno="192"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>RoPE<sp/>(if<sp/>enabled)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="193"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>q_rope;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[seq,<sp/>num_heads,<sp/>head_dim]<sp/>activation<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="194"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>k_rope;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[seq,<sp/>num_kv_heads,<sp/>head_dim]<sp/>activation<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="195"><highlight class="normal"></highlight></codeline>
<codeline lineno="196"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Attention<sp/>Scores<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="197"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>attn_scores;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[num_heads,<sp/>seq,<sp/>seq]<sp/>activation<sp/>(Q<sp/>@<sp/>K^T)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="198"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>attn_probs;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[num_heads,<sp/>seq,<sp/>seq]<sp/>activation<sp/>(softmax)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="199"><highlight class="normal"></highlight></codeline>
<codeline lineno="200"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Attention<sp/>Output<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="201" refid="structCKLayerOffsets_1a6f26daba0ff5fda605b9a751ac2ba2ee" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKLayerOffsets_1a6f26daba0ff5fda605b9a751ac2ba2ee" kindref="member">attn_out</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[seq,<sp/>num_heads,<sp/>head_dim]<sp/>activation<sp/>(probs<sp/>@<sp/>V)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="202"><highlight class="normal"></highlight></codeline>
<codeline lineno="203"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Output<sp/>Projection<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="204"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>wo;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[num_heads<sp/>*<sp/>head_dim,<sp/>embed]<sp/>weight<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="205"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>bo;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[embed]<sp/>bias<sp/>(optional)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="206" refid="structCKLayerOffsets_1ad4bc2b7cea35add011aa22e48f10f99c" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKLayerOffsets_1ad4bc2b7cea35add011aa22e48f10f99c" kindref="member">proj_out</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[seq,<sp/>embed]<sp/>activation<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="207"><highlight class="normal"></highlight></codeline>
<codeline lineno="208"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Residual<sp/>Connection<sp/>1<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="209"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>residual1;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[seq,<sp/>embed]<sp/>activation<sp/>(input<sp/>+<sp/>proj_out)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="210"><highlight class="normal"></highlight></codeline>
<codeline lineno="211"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>==========<sp/>MLP<sp/>BLOCK<sp/>==========<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="212"><highlight class="normal"></highlight></codeline>
<codeline lineno="213"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Post-Attention<sp/>Normalization<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="214"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>ln2_gamma;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[embed]<sp/>weight<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="215"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>ln2_beta;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[embed]<sp/>weight<sp/>(NULL<sp/>if<sp/>RMSNorm)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="216"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>ln2_output;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[seq,<sp/>embed]<sp/>activation<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="217"><highlight class="normal"></highlight></codeline>
<codeline lineno="218"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>MLP<sp/>Gate<sp/>Projection<sp/>(for<sp/>gated<sp/>MLP<sp/>like<sp/>SwiGLU)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="219"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>mlp_gate_w;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[embed,<sp/>intermediate]<sp/>weight<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="220"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>mlp_gate_b;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[intermediate]<sp/>bias<sp/>(optional)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="221"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>mlp_gate_out;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[seq,<sp/>intermediate]<sp/>activation<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="222"><highlight class="normal"></highlight></codeline>
<codeline lineno="223"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>MLP<sp/>Up<sp/>Projection<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="224"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>mlp_up_w;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[embed,<sp/>intermediate]<sp/>weight<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="225"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>mlp_up_b;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[intermediate]<sp/>bias<sp/>(optional)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="226"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>mlp_up_out;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[seq,<sp/>intermediate]<sp/>activation<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="227"><highlight class="normal"></highlight></codeline>
<codeline lineno="228"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>MLP<sp/>Activation<sp/>(SiLU/GELU)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="229"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>mlp_act_out;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[seq,<sp/>intermediate]<sp/>activation<sp/>(gate<sp/>*<sp/>silu(up))<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="230"><highlight class="normal"></highlight></codeline>
<codeline lineno="231"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>MLP<sp/>Down<sp/>Projection<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="232"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>mlp_down_w;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[intermediate,<sp/>embed]<sp/>weight<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="233"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>mlp_down_b;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[embed]<sp/>bias<sp/>(optional)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="234"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>mlp_down_out;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[seq,<sp/>embed]<sp/>activation<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="235"><highlight class="normal"></highlight></codeline>
<codeline lineno="236"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Residual<sp/>Connection<sp/>2<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="237"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>residual2;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[seq,<sp/>embed]<sp/>activation<sp/>(residual1<sp/>+<sp/>mlp_down_out)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="238"><highlight class="normal"></highlight></codeline>
<codeline lineno="239"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>==========<sp/>LAYER<sp/>OUTPUT<sp/>==========<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="240" refid="structCKLayerOffsets_1a253ebe103830f66006e992c1942359c6" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKLayerOffsets_1a253ebe103830f66006e992c1942359c6" kindref="member">output</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[seq,<sp/>embed]<sp/>=<sp/>residual2<sp/>(input<sp/>to<sp/>next<sp/>layer)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="241"><highlight class="normal"></highlight></codeline>
<codeline lineno="242"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>==========<sp/>KV<sp/>CACHE<sp/>(decode<sp/>mode)<sp/>==========<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="243"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>k_cache;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[max_seq,<sp/>num_kv_heads,<sp/>head_dim]<sp/>persistent<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="244"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>v_cache;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[max_seq,<sp/>num_kv_heads,<sp/>head_dim]<sp/>persistent<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="245"><highlight class="normal"></highlight></codeline>
<codeline lineno="246"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>==========<sp/>BYTE<sp/>BOUNDARIES<sp/>==========<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="247" refid="structCKLayerOffsets_1ace63bf4c6c97434a4fa90d2f765cf96f" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKLayerOffsets_1ace63bf4c6c97434a4fa90d2f765cf96f" kindref="member">layer_start</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>first<sp/>byte<sp/>of<sp/>this<sp/>layer<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="248" refid="structCKLayerOffsets_1a968c7ab2fdc25c0e8bf2b98d12b79687" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKLayerOffsets_1a968c7ab2fdc25c0e8bf2b98d12b79687" kindref="member">layer_end</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>last<sp/>byte<sp/>+<sp/>1<sp/>of<sp/>this<sp/>layer<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="249"><highlight class="normal"></highlight></codeline>
<codeline lineno="250"><highlight class="normal">}<sp/><ref refid="structCKLayerOffsets" kindref="compound">CKLayerOffsets</ref>;</highlight></codeline>
<codeline lineno="251"><highlight class="normal"></highlight></codeline>
<codeline lineno="252"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="253"><highlight class="comment"><sp/>*<sp/>LAYER<sp/>GRADIENT<sp/>OFFSETS<sp/>(for<sp/>training)</highlight></codeline>
<codeline lineno="254"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="255"><highlight class="comment"><sp/>*<sp/>Gradients<sp/>follow<sp/>the<sp/>same<sp/>interleaved<sp/>pattern.</highlight></codeline>
<codeline lineno="256"><highlight class="comment"><sp/>*<sp/>Laid<sp/>out<sp/>AFTER<sp/>all<sp/>forward<sp/>activations<sp/>(or<sp/>interleaved<sp/>per-layer).</highlight></codeline>
<codeline lineno="257"><highlight class="comment"><sp/>*<sp/>============================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="258"><highlight class="normal"></highlight></codeline>
<codeline lineno="259"><highlight class="normal"></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="260"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>ATTENTION<sp/>BLOCK<sp/>GRADIENTS<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="261"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>d_ln1_gamma,<sp/>d_ln1_beta;</highlight></codeline>
<codeline lineno="262"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>d_ln1_output;</highlight></codeline>
<codeline lineno="263"><highlight class="normal"></highlight></codeline>
<codeline lineno="264"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>d_wq,<sp/>d_bq,<sp/>d_q;</highlight></codeline>
<codeline lineno="265"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>d_wk,<sp/>d_bk,<sp/>d_k;</highlight></codeline>
<codeline lineno="266"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>d_wv,<sp/>d_bv,<sp/>d_v;</highlight></codeline>
<codeline lineno="267"><highlight class="normal"></highlight></codeline>
<codeline lineno="268" refid="structCKLayerGradOffsets_1a2d059e5b3e882d461ee74d459b54aeae" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>d_attn_scores,<sp/><ref refid="structCKLayerGradOffsets_1a2d059e5b3e882d461ee74d459b54aeae" kindref="member">d_attn_probs</ref>;</highlight></codeline>
<codeline lineno="269" refid="structCKLayerGradOffsets_1a5383122bbd9bca1d26dc23bca84d3ef3" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKLayerGradOffsets_1a5383122bbd9bca1d26dc23bca84d3ef3" kindref="member">d_attn_out</ref>;</highlight></codeline>
<codeline lineno="270"><highlight class="normal"></highlight></codeline>
<codeline lineno="271"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>d_wo,<sp/>d_bo;</highlight></codeline>
<codeline lineno="272" refid="structCKLayerGradOffsets_1ab39bad6aa2d7b4cdd624e1a3d4b18ca9" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKLayerGradOffsets_1ab39bad6aa2d7b4cdd624e1a3d4b18ca9" kindref="member">d_proj_out</ref>;</highlight></codeline>
<codeline lineno="273" refid="structCKLayerGradOffsets_1a8f5b64f6f0b8ce9fcd1264b8638b7082" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKLayerGradOffsets_1a8f5b64f6f0b8ce9fcd1264b8638b7082" kindref="member">d_residual1</ref>;</highlight></codeline>
<codeline lineno="274"><highlight class="normal"></highlight></codeline>
<codeline lineno="275"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>MLP<sp/>BLOCK<sp/>GRADIENTS<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="276"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>d_ln2_gamma,<sp/>d_ln2_beta;</highlight></codeline>
<codeline lineno="277"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>d_ln2_output;</highlight></codeline>
<codeline lineno="278"><highlight class="normal"></highlight></codeline>
<codeline lineno="279" refid="structCKLayerGradOffsets_1a020b61adaa42a2b67579be3ce01f4d4c" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>d_mlp_gate_w,<sp/><ref refid="structCKLayerGradOffsets_1a020b61adaa42a2b67579be3ce01f4d4c" kindref="member">d_mlp_gate_b</ref>,<sp/>d_mlp_gate_out;</highlight></codeline>
<codeline lineno="280" refid="structCKLayerGradOffsets_1aa70642f467ced05a1ce8e4795c9ec152" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>d_mlp_up_w,<sp/><ref refid="structCKLayerGradOffsets_1aa70642f467ced05a1ce8e4795c9ec152" kindref="member">d_mlp_up_b</ref>,<sp/>d_mlp_up_out;</highlight></codeline>
<codeline lineno="281" refid="structCKLayerGradOffsets_1aa093a6afe597f5b90196549170cb4aab" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKLayerGradOffsets_1aa093a6afe597f5b90196549170cb4aab" kindref="member">d_mlp_act_out</ref>;</highlight></codeline>
<codeline lineno="282" refid="structCKLayerGradOffsets_1ab0fdf34b696663ecd2a6adc66dc35e88" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>d_mlp_down_w,<sp/><ref refid="structCKLayerGradOffsets_1ab0fdf34b696663ecd2a6adc66dc35e88" kindref="member">d_mlp_down_b</ref>,<sp/>d_mlp_down_out;</highlight></codeline>
<codeline lineno="283"><highlight class="normal"></highlight></codeline>
<codeline lineno="284" refid="structCKLayerGradOffsets_1a40ee9ccba2e0a9b235f9350742fa7c96" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKLayerGradOffsets_1a40ee9ccba2e0a9b235f9350742fa7c96" kindref="member">d_residual2</ref>;</highlight></codeline>
<codeline lineno="285" refid="structCKLayerGradOffsets_1ace7e61f43563a3d22ea91a363aeb5609" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKLayerGradOffsets_1ace7e61f43563a3d22ea91a363aeb5609" kindref="member">d_output</ref>;</highlight></codeline>
<codeline lineno="286"><highlight class="normal"></highlight></codeline>
<codeline lineno="287"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>BYTE<sp/>BOUNDARIES<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="288" refid="structCKLayerGradOffsets_1a6272144a177f1aa0fd8a3ff88a84c88b" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKLayerGradOffsets_1a6272144a177f1aa0fd8a3ff88a84c88b" kindref="member">grad_start</ref>;</highlight></codeline>
<codeline lineno="289" refid="structCKLayerGradOffsets_1ad3dcd4463deb7947578383f61a5800d9" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKLayerGradOffsets_1ad3dcd4463deb7947578383f61a5800d9" kindref="member">grad_end</ref>;</highlight></codeline>
<codeline lineno="290"><highlight class="normal"></highlight></codeline>
<codeline lineno="291"><highlight class="normal">}<sp/><ref refid="structCKLayerGradOffsets" kindref="compound">CKLayerGradOffsets</ref>;</highlight></codeline>
<codeline lineno="292"><highlight class="normal"></highlight></codeline>
<codeline lineno="293"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="294"><highlight class="comment"><sp/>*<sp/>LAYER<sp/>OPTIMIZER<sp/>STATE<sp/>(Adam<sp/>m<sp/>and<sp/>v)</highlight></codeline>
<codeline lineno="295"><highlight class="comment"><sp/>*<sp/>============================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="296"><highlight class="normal"></highlight></codeline>
<codeline lineno="297" refid="structCKLayerOptimizerOffsets" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="298"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>First<sp/>moment<sp/>(m)<sp/>for<sp/>each<sp/>weight<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="299" refid="structCKLayerOptimizerOffsets_1a33e61c51c31c2fa53bbf9f4a42a6acb4" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>m_ln1_gamma,<sp/><ref refid="structCKLayerOptimizerOffsets_1a33e61c51c31c2fa53bbf9f4a42a6acb4" kindref="member">m_ln1_beta</ref>;</highlight></codeline>
<codeline lineno="300" refid="structCKLayerOptimizerOffsets_1a3cf63cde129a1b236bdad073b670c502" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>m_wq,<sp/>m_bq,<sp/>m_wk,<sp/><ref refid="structCKLayerOptimizerOffsets_1a3cf63cde129a1b236bdad073b670c502" kindref="member">m_bk</ref>,<sp/>m_wv,<sp/>m_bv;</highlight></codeline>
<codeline lineno="301" refid="structCKLayerOptimizerOffsets_1aa562f5efd6173858cf43d57551e53a34" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>m_wo,<sp/><ref refid="structCKLayerOptimizerOffsets_1aa562f5efd6173858cf43d57551e53a34" kindref="member">m_bo</ref>;</highlight></codeline>
<codeline lineno="302" refid="structCKLayerOptimizerOffsets_1a821ddf375173a7d11f8694c177a63d93" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>m_ln2_gamma,<sp/><ref refid="structCKLayerOptimizerOffsets_1a821ddf375173a7d11f8694c177a63d93" kindref="member">m_ln2_beta</ref>;</highlight></codeline>
<codeline lineno="303" refid="structCKLayerOptimizerOffsets_1a3f6bc539802d8836399a9bc58b64880f" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>m_mlp_gate_w,<sp/><ref refid="structCKLayerOptimizerOffsets_1a3f6bc539802d8836399a9bc58b64880f" kindref="member">m_mlp_gate_b</ref>;</highlight></codeline>
<codeline lineno="304" refid="structCKLayerOptimizerOffsets_1a9dec06808a0e417685225e98d95ff37a" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>m_mlp_up_w,<sp/><ref refid="structCKLayerOptimizerOffsets_1a9dec06808a0e417685225e98d95ff37a" kindref="member">m_mlp_up_b</ref>;</highlight></codeline>
<codeline lineno="305" refid="structCKLayerOptimizerOffsets_1a34a29c9146fdacaa56a6118fa684fa86" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>m_mlp_down_w,<sp/><ref refid="structCKLayerOptimizerOffsets_1a34a29c9146fdacaa56a6118fa684fa86" kindref="member">m_mlp_down_b</ref>;</highlight></codeline>
<codeline lineno="306"><highlight class="normal"></highlight></codeline>
<codeline lineno="307"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Second<sp/>moment<sp/>(v)<sp/>for<sp/>each<sp/>weight<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="308" refid="structCKLayerOptimizerOffsets_1acd7cb9443cff2872dc2fa0c6b6b159a6" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>v_ln1_gamma,<sp/><ref refid="structCKLayerOptimizerOffsets_1acd7cb9443cff2872dc2fa0c6b6b159a6" kindref="member">v_ln1_beta</ref>;</highlight></codeline>
<codeline lineno="309" refid="structCKLayerOptimizerOffsets_1a1bea81a97d9e230388a11aa88fcfaab8" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>v_wq,<sp/>v_bq,<sp/>v_wk,<sp/><ref refid="structCKLayerOptimizerOffsets_1a1bea81a97d9e230388a11aa88fcfaab8" kindref="member">v_bk</ref>,<sp/>v_wv,<sp/>v_bv;</highlight></codeline>
<codeline lineno="310" refid="structCKLayerOptimizerOffsets_1a64ed5b2a6e204efd8d40429fd9700744" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>v_wo,<sp/><ref refid="structCKLayerOptimizerOffsets_1a64ed5b2a6e204efd8d40429fd9700744" kindref="member">v_bo</ref>;</highlight></codeline>
<codeline lineno="311" refid="structCKLayerOptimizerOffsets_1a205ea40a57d44759dce23b92ce8a853f" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>v_ln2_gamma,<sp/><ref refid="structCKLayerOptimizerOffsets_1a205ea40a57d44759dce23b92ce8a853f" kindref="member">v_ln2_beta</ref>;</highlight></codeline>
<codeline lineno="312" refid="structCKLayerOptimizerOffsets_1a2b7d74bd97a70cc3ef67619b1090f5f1" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>v_mlp_gate_w,<sp/><ref refid="structCKLayerOptimizerOffsets_1a2b7d74bd97a70cc3ef67619b1090f5f1" kindref="member">v_mlp_gate_b</ref>;</highlight></codeline>
<codeline lineno="313" refid="structCKLayerOptimizerOffsets_1a7bafeba33b123654fbd253bbdded7bd6" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>v_mlp_up_w,<sp/><ref refid="structCKLayerOptimizerOffsets_1a7bafeba33b123654fbd253bbdded7bd6" kindref="member">v_mlp_up_b</ref>;</highlight></codeline>
<codeline lineno="314" refid="structCKLayerOptimizerOffsets_1a7cd21b2bb571c27da41ab7cd5c452b7f" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>v_mlp_down_w,<sp/><ref refid="structCKLayerOptimizerOffsets_1a7cd21b2bb571c27da41ab7cd5c452b7f" kindref="member">v_mlp_down_b</ref>;</highlight></codeline>
<codeline lineno="315"><highlight class="normal"></highlight></codeline>
<codeline lineno="316"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Byte<sp/>boundaries<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="317" refid="structCKLayerOptimizerOffsets_1a768c2644e129903d370b4010d37c74eb" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKLayerOptimizerOffsets_1a768c2644e129903d370b4010d37c74eb" kindref="member">opt_start</ref>;</highlight></codeline>
<codeline lineno="318" refid="structCKLayerOptimizerOffsets_1ac4940fcc8708472a83f4622f033ebbb6" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKLayerOptimizerOffsets_1ac4940fcc8708472a83f4622f033ebbb6" kindref="member">opt_end</ref>;</highlight></codeline>
<codeline lineno="319"><highlight class="normal"></highlight></codeline>
<codeline lineno="320"><highlight class="normal">}<sp/><ref refid="structCKLayerOptimizerOffsets" kindref="compound">CKLayerOptimizerOffsets</ref>;</highlight></codeline>
<codeline lineno="321"><highlight class="normal"></highlight></codeline>
<codeline lineno="322"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="323"><highlight class="comment"><sp/>*<sp/>FOOTER<sp/>OFFSETS</highlight></codeline>
<codeline lineno="324"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="325"><highlight class="comment"><sp/>*<sp/>The<sp/>FOOTER<sp/>contains<sp/>layers<sp/>AFTER<sp/>the<sp/>transformer<sp/>body:</highlight></codeline>
<codeline lineno="326"><highlight class="comment"><sp/>*<sp/>-<sp/>Final<sp/>normalization</highlight></codeline>
<codeline lineno="327"><highlight class="comment"><sp/>*<sp/>-<sp/>Output<sp/>projection<sp/>(lm_head<sp/>for<sp/>text,<sp/>classifier<sp/>for<sp/>vision)</highlight></codeline>
<codeline lineno="328"><highlight class="comment"><sp/>*<sp/>-<sp/>Bridge<sp/>projection<sp/>(to<sp/>connect<sp/>to<sp/>next<sp/>section)</highlight></codeline>
<codeline lineno="329"><highlight class="comment"><sp/>*<sp/>============================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="330"><highlight class="normal"></highlight></codeline>
<codeline lineno="331" refid="structCKFooterOffsets" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="332"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>FINAL<sp/>NORMALIZATION<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="333" refid="structCKFooterOffsets_1ab47cf73ae4b7e7de8cf801fa9ce1dc5c" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKFooterOffsets_1ab47cf73ae4b7e7de8cf801fa9ce1dc5c" kindref="member">final_ln_gamma</ref>;<sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[embed]<sp/>weight<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="334" refid="structCKFooterOffsets_1a8866b0a08fa2195bbb577d5e4a4e12dd" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKFooterOffsets_1a8866b0a08fa2195bbb577d5e4a4e12dd" kindref="member">final_ln_beta</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[embed]<sp/>weight<sp/>(NULL<sp/>if<sp/>RMSNorm)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="335" refid="structCKFooterOffsets_1ab297d1de6261098375f31e149519d4d4" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKFooterOffsets_1ab297d1de6261098375f31e149519d4d4" kindref="member">final_ln_output</ref>;<sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[seq,<sp/>embed]<sp/>activation<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="336"><highlight class="normal"></highlight></codeline>
<codeline lineno="337"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>OUTPUT<sp/>HEAD<sp/>(optional)<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="338" refid="structCKFooterOffsets_1ad4256e4d307e8deb6aadc34113d81e90" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKFooterOffsets_1ad4256e4d307e8deb6aadc34113d81e90" kindref="member">lm_head_w</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[embed,<sp/>vocab]<sp/>weight<sp/>(may<sp/>tie<sp/>with<sp/>embed_weight)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="339" refid="structCKFooterOffsets_1a97bbf97af4ac45e5c16437af7842957b" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKFooterOffsets_1a97bbf97af4ac45e5c16437af7842957b" kindref="member">lm_head_b</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[vocab]<sp/>bias<sp/>(optional)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="340" refid="structCKFooterOffsets_1a638f017bdaec7d988d89bf2692a48d6b" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKFooterOffsets_1a638f017bdaec7d988d89bf2692a48d6b" kindref="member">logits</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[seq,<sp/>vocab]<sp/>activation<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="341"><highlight class="normal"></highlight></codeline>
<codeline lineno="342"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>BRIDGE<sp/>TO<sp/>NEXT<sp/>SECTION<sp/>(optional)<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="343" refid="structCKFooterOffsets_1a5a3df48e55198eeebcfba9453881de01" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKFooterOffsets_1a5a3df48e55198eeebcfba9453881de01" kindref="member">bridge_w</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[this_embed,<sp/>next_embed]<sp/>weight<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="344" refid="structCKFooterOffsets_1a6e968314ca3082225d5fdbeda2c64343" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKFooterOffsets_1a6e968314ca3082225d5fdbeda2c64343" kindref="member">bridge_b</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[next_embed]<sp/>bias<sp/>(optional)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="345" refid="structCKFooterOffsets_1a44484b840457f80b8fa286f5167d1687" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKFooterOffsets_1a44484b840457f80b8fa286f5167d1687" kindref="member">bridge_output</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[seq,<sp/>next_embed]<sp/>activation<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="346"><highlight class="normal"></highlight></codeline>
<codeline lineno="347"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>BYTE<sp/>BOUNDARIES<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="348" refid="structCKFooterOffsets_1ae734eedf274912ce617fb86c5c14cbf4" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKFooterOffsets_1ae734eedf274912ce617fb86c5c14cbf4" kindref="member">footer_start</ref>;</highlight></codeline>
<codeline lineno="349" refid="structCKFooterOffsets_1a17d1b0599249931fab10aa62ce6b8b20" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKFooterOffsets_1a17d1b0599249931fab10aa62ce6b8b20" kindref="member">footer_end</ref>;</highlight></codeline>
<codeline lineno="350"><highlight class="normal"></highlight></codeline>
<codeline lineno="351"><highlight class="normal">}<sp/><ref refid="structCKFooterOffsets" kindref="compound">CKFooterOffsets</ref>;</highlight></codeline>
<codeline lineno="352"><highlight class="normal"></highlight></codeline>
<codeline lineno="353"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="354"><highlight class="comment"><sp/>*<sp/>FOOTER<sp/>GRADIENTS<sp/>(for<sp/>training)</highlight></codeline>
<codeline lineno="355"><highlight class="comment"><sp/>*<sp/>============================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="356"><highlight class="normal"></highlight></codeline>
<codeline lineno="357" refid="structCKFooterGradOffsets" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="358" refid="structCKFooterGradOffsets_1ada3b948a5b678ac0f01d74bf7ab3a8c8" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>d_final_ln_gamma,<sp/><ref refid="structCKFooterGradOffsets_1ada3b948a5b678ac0f01d74bf7ab3a8c8" kindref="member">d_final_ln_beta</ref>;</highlight></codeline>
<codeline lineno="359" refid="structCKFooterGradOffsets_1ae2a60b057eaa172d1132474349ad5d40" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKFooterGradOffsets_1ae2a60b057eaa172d1132474349ad5d40" kindref="member">d_final_ln_output</ref>;</highlight></codeline>
<codeline lineno="360"><highlight class="normal"></highlight></codeline>
<codeline lineno="361" refid="structCKFooterGradOffsets_1a6b4894e65e79da4ec83a9b2b535ef519" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>d_lm_head_w,<sp/><ref refid="structCKFooterGradOffsets_1a6b4894e65e79da4ec83a9b2b535ef519" kindref="member">d_lm_head_b</ref>;</highlight></codeline>
<codeline lineno="362" refid="structCKFooterGradOffsets_1ac3f2b08b2785cf1fa039bb3c0e6e2197" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKFooterGradOffsets_1ac3f2b08b2785cf1fa039bb3c0e6e2197" kindref="member">d_logits</ref>;</highlight></codeline>
<codeline lineno="363"><highlight class="normal"></highlight></codeline>
<codeline lineno="364" refid="structCKFooterGradOffsets_1a39e8fc85fe6bcd5c1a1fbd7ced054879" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>d_bridge_w,<sp/><ref refid="structCKFooterGradOffsets_1a39e8fc85fe6bcd5c1a1fbd7ced054879" kindref="member">d_bridge_b</ref>;</highlight></codeline>
<codeline lineno="365" refid="structCKFooterGradOffsets_1ae6e42eddc33324875a7458f7d804a694" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKFooterGradOffsets_1ae6e42eddc33324875a7458f7d804a694" kindref="member">d_bridge_output</ref>;</highlight></codeline>
<codeline lineno="366"><highlight class="normal"></highlight></codeline>
<codeline lineno="367" refid="structCKFooterGradOffsets_1ae9169fef93e53c932b9f4728d8cb6e30" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKFooterGradOffsets_1ae9169fef93e53c932b9f4728d8cb6e30" kindref="member">grad_start</ref>;</highlight></codeline>
<codeline lineno="368" refid="structCKFooterGradOffsets_1a1033308e389797d86251b87a79781bae" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKFooterGradOffsets_1a1033308e389797d86251b87a79781bae" kindref="member">grad_end</ref>;</highlight></codeline>
<codeline lineno="369"><highlight class="normal"></highlight></codeline>
<codeline lineno="370"><highlight class="normal">}<sp/><ref refid="structCKFooterGradOffsets" kindref="compound">CKFooterGradOffsets</ref>;</highlight></codeline>
<codeline lineno="371"><highlight class="normal"></highlight></codeline>
<codeline lineno="372"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="373"><highlight class="comment"><sp/>*<sp/>SECTION<sp/>-<sp/>Complete<sp/>Header<sp/>+<sp/>Body<sp/>+<sp/>Footer</highlight></codeline>
<codeline lineno="374"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="375"><highlight class="comment"><sp/>*<sp/>Each<sp/>section<sp/>is<sp/>a<sp/>self-contained<sp/>module<sp/>(encoder,<sp/>decoder,<sp/>vision,<sp/>audio).</highlight></codeline>
<codeline lineno="376"><highlight class="comment"><sp/>*<sp/>============================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="377"><highlight class="normal"></highlight></codeline>
<codeline lineno="378"><highlight class="normal"></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="379"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>CONFIGURATION<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="380"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="structCKSectionConfig" kindref="compound">CKSectionConfig</ref><sp/>config;</highlight></codeline>
<codeline lineno="381" refid="structCKSection_1a0c37521cc2163ed38a4d65ff9ce2f381" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">char</highlight><highlight class="normal"><sp/>*<ref refid="structCKSection_1a0c37521cc2163ed38a4d65ff9ce2f381" kindref="member">name</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>&quot;vision_encoder&quot;,<sp/>&quot;text_decoder&quot;,<sp/>etc.<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="382" refid="structCKSection_1aaf13683953b54b12a83a90251eb6a881" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="structCKSection_1aaf13683953b54b12a83a90251eb6a881" kindref="member">section_id</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>0,<sp/>1,<sp/>2,<sp/>...<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="383"><highlight class="normal"></highlight></codeline>
<codeline lineno="384"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>HEADER<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="385" refid="structCKSection_1adafbb43b1edb42a0adb1b97311b601a4" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="structCKHeaderOffsets" kindref="compound">CKHeaderOffsets</ref><sp/><ref refid="structCKSection_1adafbb43b1edb42a0adb1b97311b601a4" kindref="member">header</ref>;</highlight></codeline>
<codeline lineno="386"><highlight class="normal"></highlight></codeline>
<codeline lineno="387"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>BODY<sp/>(transformer<sp/>layers)<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="388"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>num_layers;</highlight></codeline>
<codeline lineno="389"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="structCKLayerOffsets" kindref="compound">CKLayerOffsets</ref><sp/>*layers;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Array<sp/>of<sp/>per-layer<sp/>offsets<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="390" refid="structCKSection_1acd76a9f347cf9d4551e7c7cd33ca8f30" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="structCKLayerGradOffsets" kindref="compound">CKLayerGradOffsets</ref><sp/>*<ref refid="structCKSection_1acd76a9f347cf9d4551e7c7cd33ca8f30" kindref="member">layer_grads</ref>;<sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Array<sp/>of<sp/>per-layer<sp/>gradient<sp/>offsets<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="391" refid="structCKSection_1a77177dc1f5d94b91942e9dd199556661" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="structCKLayerOptimizerOffsets" kindref="compound">CKLayerOptimizerOffsets</ref><sp/>*<ref refid="structCKSection_1a77177dc1f5d94b91942e9dd199556661" kindref="member">layer_opt</ref>;<sp/></highlight><highlight class="comment">/*<sp/>Array<sp/>of<sp/>per-layer<sp/>optimizer<sp/>state<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="392"><highlight class="normal"></highlight></codeline>
<codeline lineno="393"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>FOOTER<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="394" refid="structCKSection_1aa030a13ebf6b121d19344e0249786fb8" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="structCKFooterOffsets" kindref="compound">CKFooterOffsets</ref><sp/><ref refid="structCKSection_1aa030a13ebf6b121d19344e0249786fb8" kindref="member">footer</ref>;</highlight></codeline>
<codeline lineno="395" refid="structCKSection_1aeb788d634d43d321c22d52573318692f" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="structCKFooterGradOffsets" kindref="compound">CKFooterGradOffsets</ref><sp/><ref refid="structCKSection_1aeb788d634d43d321c22d52573318692f" kindref="member">footer_grads</ref>;</highlight></codeline>
<codeline lineno="396"><highlight class="normal"></highlight></codeline>
<codeline lineno="397"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>GLOBAL<sp/>BUFFERS<sp/>FOR<sp/>THIS<sp/>SECTION<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="398" refid="structCKSection_1a54f5ffde9d9968d1f3b928dc54bbd439" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKSection_1a54f5ffde9d9968d1f3b928dc54bbd439" kindref="member">rope_cos</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[max_seq,<sp/>head_dim/2]<sp/>RoPE<sp/>cosines<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="399" refid="structCKSection_1a117cf20f51a6d9d22c18fad061fde15f" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKSection_1a117cf20f51a6d9d22c18fad061fde15f" kindref="member">rope_sin</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[max_seq,<sp/>head_dim/2]<sp/>RoPE<sp/>sines<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="400" refid="structCKSection_1a74a02e21d1d89af4a3f64c236b5595d7" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKSection_1a74a02e21d1d89af4a3f64c236b5595d7" kindref="member">causal_mask</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>[max_seq,<sp/>max_seq]<sp/>causal<sp/>attention<sp/>mask<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="401"><highlight class="normal"></highlight></codeline>
<codeline lineno="402"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>SECTION<sp/>BYTE<sp/>BOUNDARIES<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="403"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>section_start;<sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>First<sp/>byte<sp/>of<sp/>this<sp/>section<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="404"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>section_end;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Last<sp/>byte<sp/>+<sp/>1<sp/>of<sp/>this<sp/>section<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="405" refid="structCKSection_1a50088bc199e240759c6402920180e469" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKSection_1a50088bc199e240759c6402920180e469" kindref="member">section_weight_bytes</ref>;</highlight></codeline>
<codeline lineno="406" refid="structCKSection_1aa21574168860ae278245951028df3ff0" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKSection_1aa21574168860ae278245951028df3ff0" kindref="member">section_activation_bytes</ref>;</highlight></codeline>
<codeline lineno="407" refid="structCKSection_1aeea1efa805610505363a8dbe6d734282" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKSection_1aeea1efa805610505363a8dbe6d734282" kindref="member">section_grad_bytes</ref>;</highlight></codeline>
<codeline lineno="408" refid="structCKSection_1abd9ca87b9ad74cd97d0096872749fbc8" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKSection_1abd9ca87b9ad74cd97d0096872749fbc8" kindref="member">section_opt_bytes</ref>;</highlight></codeline>
<codeline lineno="409"><highlight class="normal"></highlight></codeline>
<codeline lineno="410"><highlight class="normal">}<sp/><ref refid="structCKSection" kindref="compound">CKSection</ref>;</highlight></codeline>
<codeline lineno="411"><highlight class="normal"></highlight></codeline>
<codeline lineno="412"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="413"><highlight class="comment"><sp/>*<sp/>MODEL<sp/>-<sp/>The<sp/>Complete<sp/>Multi-Section<sp/>Model</highlight></codeline>
<codeline lineno="414"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="415"><highlight class="comment"><sp/>*<sp/>ONE<sp/>allocation.<sp/>ONE<sp/>base<sp/>pointer.<sp/>ALL<sp/>offsets<sp/>relative<sp/>to<sp/>base.</highlight></codeline>
<codeline lineno="416"><highlight class="comment"><sp/>*<sp/>============================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="417"><highlight class="normal"></highlight></codeline>
<codeline lineno="418"><highlight class="normal"></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">struct<sp/></highlight><highlight class="normal">{</highlight></codeline>
<codeline lineno="419"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>MEMORY<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="420"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>*base;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>THE<sp/>single<sp/>allocation<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="421"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>total_bytes;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Total<sp/>size<sp/>of<sp/>allocation<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="422"><highlight class="normal"></highlight></codeline>
<codeline lineno="423"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>BREAKDOWN<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="424"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>weight_bytes;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Total<sp/>weights<sp/>across<sp/>all<sp/>sections<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="425"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>activation_bytes;<sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Total<sp/>activations<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="426"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>grad_bytes;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Total<sp/>gradients<sp/>(0<sp/>if<sp/>inference)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="427" refid="structCKModel_1a4f3d9a363a8fc7d37556b33e6b20cd69" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKModel_1a4f3d9a363a8fc7d37556b33e6b20cd69" kindref="member">opt_bytes</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Total<sp/>optimizer<sp/>state<sp/>(0<sp/>if<sp/>inference)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="428"><highlight class="normal"></highlight></codeline>
<codeline lineno="429"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>SECTIONS<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="430"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>num_sections;</highlight></codeline>
<codeline lineno="431"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="structCKSection" kindref="compound">CKSection</ref><sp/>*sections;</highlight></codeline>
<codeline lineno="432"><highlight class="normal"></highlight></codeline>
<codeline lineno="433"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>GLOBAL<sp/>SHARED<sp/>BUFFERS<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="434" refid="structCKModel_1a23c5fb291d06cc7cbe7aa8bc2a07b06b" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKModel_1a23c5fb291d06cc7cbe7aa8bc2a07b06b" kindref="member">shared_scratch</ref>;<sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Scratch<sp/>buffer<sp/>for<sp/>temp<sp/>computations<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="435" refid="structCKModel_1afdaa49dc294acb37ed54a2708b6bc8e0" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKModel_1afdaa49dc294acb37ed54a2708b6bc8e0" kindref="member">shared_scratch_bytes</ref>;</highlight></codeline>
<codeline lineno="436"><highlight class="normal"></highlight></codeline>
<codeline lineno="437"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>MODE<sp/>FLAGS<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="438" refid="structCKModel_1a84832de4929055025d6634e18ceae38a" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="structCKModel_1a84832de4929055025d6634e18ceae38a" kindref="member">training_enabled</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>0=inference,<sp/>1=training<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="439" refid="structCKModel_1a30077b979aff326f5c4bd20da8b6d807" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="structCKModel_1a30077b979aff326f5c4bd20da8b6d807" kindref="member">kv_cache_enabled</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>0=prefill,<sp/>1=decode<sp/>with<sp/>cache<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="440"><highlight class="normal"><sp/><sp/><sp/><sp/>uint32_t<sp/>fusion_flags;<sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Bitmask<sp/>of<sp/>enabled<sp/>kernel<sp/>fusions<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="441"><highlight class="normal"></highlight></codeline>
<codeline lineno="442"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>RUNTIME<sp/>STATE<sp/>(not<sp/>offsets)<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="443"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>current_seq_len;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Tokens<sp/>processed<sp/>in<sp/>current<sp/>sequence<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="444" refid="structCKModel_1a9b0ad93300ab3b15395daf0d8e720f4d" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="structCKModel_1a9b0ad93300ab3b15395daf0d8e720f4d" kindref="member">current_pos</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Position<sp/>for<sp/>decode<sp/>mode<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="445"><highlight class="normal"></highlight></codeline>
<codeline lineno="446"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>===<sp/>NUMA<sp/>INFO<sp/>===<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="447" refid="structCKModel_1a2a35dbca7a62e3ebe14b6c502c68f2aa" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="structCKModel_1a2a35dbca7a62e3ebe14b6c502c68f2aa" kindref="member">num_numa_nodes</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Number<sp/>of<sp/>NUMA<sp/>nodes<sp/>detected<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="448" refid="structCKModel_1a9122ea9b37528516af41eb29c237838f" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="structCKModel_1a9122ea9b37528516af41eb29c237838f" kindref="member">hugepage_size</ref>;<sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Size<sp/>of<sp/>hugepages<sp/>(2MB<sp/>or<sp/>1GB)<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="449"><highlight class="normal"></highlight></codeline>
<codeline lineno="450"><highlight class="normal">}<sp/><ref refid="structCKModel" kindref="compound">CKModel</ref>;</highlight></codeline>
<codeline lineno="451"><highlight class="normal"></highlight></codeline>
<codeline lineno="452"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="453"><highlight class="comment"><sp/>*<sp/>FUSION<sp/>FLAGS</highlight></codeline>
<codeline lineno="454"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="455"><highlight class="comment"><sp/>*<sp/>When<sp/>a<sp/>fusion<sp/>is<sp/>enabled,<sp/>intermediate<sp/>activations<sp/>are<sp/>SKIPPED.</highlight></codeline>
<codeline lineno="456"><highlight class="comment"><sp/>*<sp/>Memory<sp/>is<sp/>still<sp/>allocated,<sp/>but<sp/>the<sp/>fused<sp/>kernel<sp/>bypasses<sp/>it.</highlight></codeline>
<codeline lineno="457"><highlight class="comment"><sp/>*<sp/>============================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="458"><highlight class="normal"></highlight></codeline>
<codeline lineno="459" refid="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efe" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">typedef</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">enum</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="460" refid="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efeac701cd87ffd41b651fdb39fd4d9231db" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efeac701cd87ffd41b651fdb39fd4d9231db" kindref="member">CK_FUSE_NONE</ref><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>0,</highlight></codeline>
<codeline lineno="461" refid="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efea45bba7ecc02555c097f51c9469157a21" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efea45bba7ecc02555c097f51c9469157a21" kindref="member">CK_FUSE_EMBED_NORM</ref><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>1<sp/>&lt;&lt;<sp/>0,<sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>embedding<sp/>+<sp/>first<sp/>layernorm<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="462" refid="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efea34b104e34a7aa0d0937ad1d8d064f0a9" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efea34b104e34a7aa0d0937ad1d8d064f0a9" kindref="member">CK_FUSE_NORM_QKV</ref><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>1<sp/>&lt;&lt;<sp/>1,<sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>layernorm<sp/>+<sp/>QKV<sp/>projection<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="463" refid="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efeabdee28d29574a516859ce8a97cdbe959" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efeabdee28d29574a516859ce8a97cdbe959" kindref="member">CK_FUSE_QKV_ROPE</ref><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>1<sp/>&lt;&lt;<sp/>2,<sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>QKV<sp/>+<sp/>rotary<sp/>position<sp/>encoding<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="464" refid="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efea43848ac20412b3e616a81b53bacb02ce" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efea43848ac20412b3e616a81b53bacb02ce" kindref="member">CK_FUSE_ATTN_PROJ</ref><sp/><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>1<sp/>&lt;&lt;<sp/>3,<sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>attention<sp/>output<sp/>+<sp/>projection<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="465" refid="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efeac49b63f12bae2e1fb3db203ec6a60fca" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efeac49b63f12bae2e1fb3db203ec6a60fca" kindref="member">CK_FUSE_NORM_MLP</ref><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>1<sp/>&lt;&lt;<sp/>4,<sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>layernorm<sp/>+<sp/>MLP<sp/>input<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="466" refid="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efeaa4b32bb297017e550a88ca82c0346b02" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efeaa4b32bb297017e550a88ca82c0346b02" kindref="member">CK_FUSE_MLP_GATE_UP</ref><sp/><sp/><sp/><sp/><sp/>=<sp/>1<sp/>&lt;&lt;<sp/>5,<sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>gate<sp/>and<sp/>up<sp/>projections<sp/>together<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="467" refid="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efea97e883e02f60415d64767579e4b65eb2" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efea97e883e02f60415d64767579e4b65eb2" kindref="member">CK_FUSE_MLP_ACT_DOWN</ref><sp/><sp/><sp/><sp/>=<sp/>1<sp/>&lt;&lt;<sp/>6,<sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>activation<sp/>+<sp/>down<sp/>projection<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="468" refid="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efea6a3bb26ab9dcc8bb90714a3c77250997" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efea6a3bb26ab9dcc8bb90714a3c77250997" kindref="member">CK_FUSE_RESIDUAL_NORM</ref><sp/><sp/><sp/>=<sp/>1<sp/>&lt;&lt;<sp/>7,<sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>residual<sp/>add<sp/>+<sp/>layernorm<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="469"><highlight class="normal">}<sp/><ref refid="ckernel__section__layout_8h_1aff5ee31d19be80e3bc7d00f0506f8efe" kindref="member">CKFusionFlags</ref>;</highlight></codeline>
<codeline lineno="470"><highlight class="normal"></highlight></codeline>
<codeline lineno="471"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="472"><highlight class="comment"><sp/>*<sp/>MEMORY<sp/>PLANNER<sp/>API</highlight></codeline>
<codeline lineno="473"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="474"><highlight class="comment"><sp/>*<sp/>Two-phase<sp/>allocation:</highlight></codeline>
<codeline lineno="475"><highlight class="comment"><sp/>*<sp/>1.<sp/>Plan:<sp/>dry<sp/>run<sp/>to<sp/>compute<sp/>all<sp/>offsets<sp/>and<sp/>total<sp/>size</highlight></codeline>
<codeline lineno="476"><highlight class="comment"><sp/>*<sp/>2.<sp/>Allocate:<sp/>single<sp/>hugepage-backed<sp/>mmap</highlight></codeline>
<codeline lineno="477"><highlight class="comment"><sp/>*<sp/>============================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="478"><highlight class="normal"></highlight><highlight class="comment"></highlight></codeline>
<codeline lineno="479"><highlight class="comment">/**</highlight></codeline>
<codeline lineno="480"><highlight class="comment"><sp/>*<sp/>Initialize<sp/>section<sp/>config<sp/>with<sp/>computed<sp/>alignments.</highlight></codeline>
<codeline lineno="481"><highlight class="comment"><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="482" refid="ckernel__section__layout_8h_1a45ba8ddf4f1d6280681d37136dbc3a5a" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="ckernel__section__layout_8h_1a45ba8ddf4f1d6280681d37136dbc3a5a" kindref="member">ck_section_config_init</ref>(<ref refid="structCKSectionConfig" kindref="compound">CKSectionConfig</ref><sp/>*config,<sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>simd_align);</highlight></codeline>
<codeline lineno="483"><highlight class="normal"></highlight><highlight class="comment"></highlight></codeline>
<codeline lineno="484"><highlight class="comment">/**</highlight></codeline>
<codeline lineno="485"><highlight class="comment"><sp/>*<sp/>Plan<sp/>memory<sp/>layout<sp/>for<sp/>a<sp/>single<sp/>section.</highlight></codeline>
<codeline lineno="486"><highlight class="comment"><sp/>*<sp/>Returns<sp/>bytes<sp/>needed<sp/>for<sp/>this<sp/>section.</highlight></codeline>
<codeline lineno="487"><highlight class="comment"><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="488" refid="ckernel__section__layout_8h_1a7a3e8075d666d342c725cea328322cd2" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="ckernel__section__layout_8h_1a7a3e8075d666d342c725cea328322cd2" kindref="member">ck_section_plan</ref>(<ref refid="structCKSection" kindref="compound">CKSection</ref><sp/>*section,</highlight></codeline>
<codeline lineno="489"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structCKSectionConfig" kindref="compound">CKSectionConfig</ref><sp/>*config,</highlight></codeline>
<codeline lineno="490"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>training_enabled,</highlight></codeline>
<codeline lineno="491"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/>base_offset);</highlight></codeline>
<codeline lineno="492"><highlight class="normal"></highlight><highlight class="comment"></highlight></codeline>
<codeline lineno="493"><highlight class="comment">/**</highlight></codeline>
<codeline lineno="494"><highlight class="comment"><sp/>*<sp/>Plan<sp/>memory<sp/>layout<sp/>for<sp/>complete<sp/>model.</highlight></codeline>
<codeline lineno="495"><highlight class="comment"><sp/>*<sp/>Returns<sp/>total<sp/>bytes<sp/>needed.</highlight></codeline>
<codeline lineno="496"><highlight class="comment"><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="497" refid="ckernel__section__layout_8h_1a82b72b659b7ce81f24b3f79b101ab6d4" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">size_t</highlight><highlight class="normal"><sp/><ref refid="ckernel__section__layout_8h_1a82b72b659b7ce81f24b3f79b101ab6d4" kindref="member">ck_model_plan</ref>(<ref refid="structCKModel" kindref="compound">CKModel</ref><sp/>*model,</highlight></codeline>
<codeline lineno="498"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="structCKSectionConfig" kindref="compound">CKSectionConfig</ref><sp/>*configs,</highlight></codeline>
<codeline lineno="499"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>num_sections,</highlight></codeline>
<codeline lineno="500"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>training_enabled,</highlight></codeline>
<codeline lineno="501"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>uint32_t<sp/>fusion_flags);</highlight></codeline>
<codeline lineno="502"><highlight class="normal"></highlight><highlight class="comment"></highlight></codeline>
<codeline lineno="503"><highlight class="comment">/**</highlight></codeline>
<codeline lineno="504"><highlight class="comment"><sp/>*<sp/>Allocate<sp/>the<sp/>planned<sp/>memory.</highlight></codeline>
<codeline lineno="505"><highlight class="comment"><sp/>*<sp/>@param<sp/>hugepage_mode:<sp/>0=normal,<sp/>1=2MB<sp/>hugepages,<sp/>2=1GB<sp/>hugepages</highlight></codeline>
<codeline lineno="506"><highlight class="comment"><sp/>*<sp/>@return<sp/>0<sp/>on<sp/>success,<sp/>-1<sp/>on<sp/>failure</highlight></codeline>
<codeline lineno="507"><highlight class="comment"><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="508" refid="ckernel__section__layout_8h_1a8d52ec7a90940748c493c1e6cbb2675e" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="ckernel__section__layout_8h_1a8d52ec7a90940748c493c1e6cbb2675e" kindref="member">ck_model_allocate</ref>(<ref refid="structCKModel" kindref="compound">CKModel</ref><sp/>*model,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>hugepage_mode);</highlight></codeline>
<codeline lineno="509"><highlight class="normal"></highlight><highlight class="comment"></highlight></codeline>
<codeline lineno="510"><highlight class="comment">/**</highlight></codeline>
<codeline lineno="511"><highlight class="comment"><sp/>*<sp/>Free<sp/>the<sp/>model<sp/>(single<sp/>free,<sp/>since<sp/>single<sp/>allocation).</highlight></codeline>
<codeline lineno="512"><highlight class="comment"><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="513" refid="ckernel__section__layout_8h_1a1098b7df468a5ac5164b440b6e08209f" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="ckernel__section__layout_8h_1a1098b7df468a5ac5164b440b6e08209f" kindref="member">ck_model_free</ref>(<ref refid="structCKModel" kindref="compound">CKModel</ref><sp/>*model);</highlight></codeline>
<codeline lineno="514"><highlight class="normal"></highlight></codeline>
<codeline lineno="515"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="516"><highlight class="comment"><sp/>*<sp/>ACCESSOR<sp/>MACROS</highlight></codeline>
<codeline lineno="517"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="518"><highlight class="comment"><sp/>*<sp/>Clean<sp/>syntax<sp/>for<sp/>accessing<sp/>tensors<sp/>from<sp/>offsets.</highlight></codeline>
<codeline lineno="519"><highlight class="comment"><sp/>*<sp/>============================================================================<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="520"><highlight class="normal"></highlight></codeline>
<codeline lineno="521"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>Get<sp/>pointer<sp/>from<sp/>offset<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="522" refid="ckernel__section__layout_8h_1aed689667a597546f4ca76393d018eb06" refkind="member"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>CK_PTR(model,<sp/>offset)<sp/>\</highlight></codeline>
<codeline lineno="523"><highlight class="preprocessor"><sp/><sp/><sp/><sp/>((float*)((char*)(model)-&gt;base<sp/>+<sp/>(offset)))</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="524"><highlight class="normal"></highlight></codeline>
<codeline lineno="525" refid="ckernel__section__layout_8h_1a8c3c24884f3f89455a6578875d6ebe40" refkind="member"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>CK_PTR_BF16(model,<sp/>offset)<sp/>\</highlight></codeline>
<codeline lineno="526"><highlight class="preprocessor"><sp/><sp/><sp/><sp/>((uint16_t*)((char*)(model)-&gt;base<sp/>+<sp/>(offset)))</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="527"><highlight class="normal"></highlight></codeline>
<codeline lineno="528"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>Get<sp/>layer<sp/>offsets<sp/>for<sp/>section<sp/>s,<sp/>layer<sp/>l<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="529" refid="ckernel__section__layout_8h_1abc25629d856fc301f5dcb0af8a63d03c" refkind="member"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>CK_LAYER(model,<sp/>s,<sp/>l)<sp/>\</highlight></codeline>
<codeline lineno="530"><highlight class="preprocessor"><sp/><sp/><sp/><sp/>(&amp;(model)-&gt;sections[s].layers[l])</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="531"><highlight class="normal"></highlight></codeline>
<codeline lineno="532"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>Get<sp/>layer<sp/>gradient<sp/>offsets<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="533" refid="ckernel__section__layout_8h_1ac3349598b4a574599247b50fd72e0be6" refkind="member"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>CK_LAYER_GRAD(model,<sp/>s,<sp/>l)<sp/>\</highlight></codeline>
<codeline lineno="534"><highlight class="preprocessor"><sp/><sp/><sp/><sp/>(&amp;(model)-&gt;sections[s].layer_grads[l])</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="535"><highlight class="normal"></highlight></codeline>
<codeline lineno="536"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>Get<sp/>header<sp/>offsets<sp/>for<sp/>section<sp/>s<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="537" refid="ckernel__section__layout_8h_1a6cd4d41f081a79df7ac57cc0d39e086f" refkind="member"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>CK_HEADER(model,<sp/>s)<sp/>\</highlight></codeline>
<codeline lineno="538"><highlight class="preprocessor"><sp/><sp/><sp/><sp/>(&amp;(model)-&gt;sections[s].header)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="539"><highlight class="normal"></highlight></codeline>
<codeline lineno="540"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>Get<sp/>footer<sp/>offsets<sp/>for<sp/>section<sp/>s<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="541" refid="ckernel__section__layout_8h_1adc318f4f8aa045cac46a382d033efea4" refkind="member"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>CK_FOOTER(model,<sp/>s)<sp/>\</highlight></codeline>
<codeline lineno="542"><highlight class="preprocessor"><sp/><sp/><sp/><sp/>(&amp;(model)-&gt;sections[s].footer)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="543"><highlight class="normal"></highlight></codeline>
<codeline lineno="544"><highlight class="normal"></highlight><highlight class="comment">/*<sp/>============================================================================</highlight></codeline>
<codeline lineno="545"><highlight class="comment"><sp/>*<sp/>EXAMPLE<sp/>USAGE</highlight></codeline>
<codeline lineno="546"><highlight class="comment"><sp/>*<sp/>============================================================================</highlight></codeline>
<codeline lineno="547"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="548"><highlight class="comment"><sp/>*<sp/>//<sp/>Define<sp/>a<sp/>vision-language<sp/>model<sp/>(2<sp/>sections)</highlight></codeline>
<codeline lineno="549"><highlight class="comment"><sp/>*<sp/>CKSectionConfig<sp/>configs[2]<sp/>=<sp/>{</highlight></codeline>
<codeline lineno="550"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/><sp/>//<sp/>Section<sp/>0:<sp/>Vision<sp/>Encoder<sp/>(ViT-L)</highlight></codeline>
<codeline lineno="551"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/><sp/>{<sp/>.embed_dim<sp/>=<sp/>1024,<sp/>.num_heads<sp/>=<sp/>16,<sp/>.num_kv_heads<sp/>=<sp/>16,</highlight></codeline>
<codeline lineno="552"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/><sp/><sp/><sp/>.head_dim<sp/>=<sp/>64,<sp/>.intermediate_dim<sp/>=<sp/>4096,<sp/>.num_layers<sp/>=<sp/>24,</highlight></codeline>
<codeline lineno="553"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/><sp/><sp/><sp/>.vocab_size<sp/>=<sp/>0,<sp/>.max_seq_len<sp/>=<sp/>576,<sp/><sp/>//<sp/>24x24<sp/>patches</highlight></codeline>
<codeline lineno="554"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/><sp/><sp/><sp/>.has_bias<sp/>=<sp/>1,<sp/>.has_rope<sp/>=<sp/>0,<sp/>.has_pos_embed<sp/>=<sp/>1,</highlight></codeline>
<codeline lineno="555"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/><sp/><sp/><sp/>.gated_mlp<sp/>=<sp/>0,<sp/>.norm_type<sp/>=<sp/>0<sp/>},</highlight></codeline>
<codeline lineno="556"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="557"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/><sp/>//<sp/>Section<sp/>1:<sp/>Text<sp/>Decoder<sp/>(LLaMA-7B<sp/>style)</highlight></codeline>
<codeline lineno="558"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/><sp/>{<sp/>.embed_dim<sp/>=<sp/>4096,<sp/>.num_heads<sp/>=<sp/>32,<sp/>.num_kv_heads<sp/>=<sp/>32,</highlight></codeline>
<codeline lineno="559"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/><sp/><sp/><sp/>.head_dim<sp/>=<sp/>128,<sp/>.intermediate_dim<sp/>=<sp/>11008,<sp/>.num_layers<sp/>=<sp/>32,</highlight></codeline>
<codeline lineno="560"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/><sp/><sp/><sp/>.vocab_size<sp/>=<sp/>32000,<sp/>.max_seq_len<sp/>=<sp/>2048,</highlight></codeline>
<codeline lineno="561"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/><sp/><sp/><sp/>.has_bias<sp/>=<sp/>0,<sp/>.has_rope<sp/>=<sp/>1,<sp/>.has_pos_embed<sp/>=<sp/>0,</highlight></codeline>
<codeline lineno="562"><highlight class="comment"><sp/>*<sp/><sp/><sp/><sp/><sp/><sp/><sp/>.gated_mlp<sp/>=<sp/>1,<sp/>.norm_type<sp/>=<sp/>1<sp/>}</highlight></codeline>
<codeline lineno="563"><highlight class="comment"><sp/>*<sp/>};</highlight></codeline>
<codeline lineno="564"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="565"><highlight class="comment"><sp/>*<sp/>CKModel<sp/>model<sp/>=<sp/>{0};</highlight></codeline>
<codeline lineno="566"><highlight class="comment"><sp/>*<sp/>size_t<sp/>total<sp/>=<sp/>ck_model_plan(&amp;model,<sp/>configs,<sp/>2,<sp/>1,<sp/>CK_FUSE_NORM_QKV);</highlight></codeline>
<codeline lineno="567"><highlight class="comment"><sp/>*<sp/>printf(&quot;Total<sp/>memory:<sp/>%.2f<sp/>GB\n&quot;,<sp/>total<sp/>/<sp/>1e9);</highlight></codeline>
<codeline lineno="568"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="569"><highlight class="comment"><sp/>*<sp/>ck_model_allocate(&amp;model,<sp/>2);<sp/><sp/>//<sp/>1GB<sp/>hugepages</highlight></codeline>
<codeline lineno="570"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="571"><highlight class="comment"><sp/>*<sp/>//<sp/>Access<sp/>vision<sp/>encoder<sp/>layer<sp/>5<sp/>Q<sp/>weights:</highlight></codeline>
<codeline lineno="572"><highlight class="comment"><sp/>*<sp/>float<sp/>*wq<sp/>=<sp/>CK_PTR(&amp;model,<sp/>CK_LAYER(&amp;model,<sp/>0,<sp/>5)-&gt;wq);</highlight></codeline>
<codeline lineno="573"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="574"><highlight class="comment"><sp/>*<sp/>//<sp/>Access<sp/>text<sp/>decoder<sp/>layer<sp/>10<sp/>attention<sp/>output:</highlight></codeline>
<codeline lineno="575"><highlight class="comment"><sp/>*<sp/>float<sp/>*attn<sp/>=<sp/>CK_PTR(&amp;model,<sp/>CK_LAYER(&amp;model,<sp/>1,<sp/>10)-&gt;attn_out);</highlight></codeline>
<codeline lineno="576"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="577"><highlight class="comment"><sp/>*<sp/>//<sp/>When<sp/>done:</highlight></codeline>
<codeline lineno="578"><highlight class="comment"><sp/>*<sp/>ck_model_free(&amp;model);<sp/><sp/>//<sp/>Single<sp/>free!</highlight></codeline>
<codeline lineno="579"><highlight class="comment"><sp/>*</highlight></codeline>
<codeline lineno="580"><highlight class="comment"><sp/>*<sp/>============================================================================</highlight></codeline>
<codeline lineno="581"><highlight class="comment"><sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="582"><highlight class="normal"></highlight></codeline>
<codeline lineno="583"><highlight class="normal"></highlight><highlight class="preprocessor">#ifdef<sp/>__cplusplus</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="584"><highlight class="normal">}</highlight></codeline>
<codeline lineno="585"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="586"><highlight class="normal"></highlight></codeline>
<codeline lineno="587"><highlight class="normal"></highlight><highlight class="preprocessor">#endif<sp/></highlight><highlight class="comment">/*<sp/>CKERNEL_SECTION_LAYOUT_H<sp/>*/</highlight><highlight class="preprocessor"></highlight></codeline>
    </programlisting>
    <location file="/home/antshiv/Workspace/C-Kernel-Engine/include/ckernel_section_layout.h"/>
  </compounddef>
</doxygen>
