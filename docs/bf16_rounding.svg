<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 650" width="900" height="650">
  <defs>
    <style>
      .title { font: bold 22px 'Segoe UI', Arial, sans-serif; fill: #1a1a2e; }
      .subtitle { font: bold 14px 'Segoe UI', Arial, sans-serif; fill: #16213e; }
      .label { font: 12px 'Courier New', monospace; fill: #333; }
      .small-label { font: 10px 'Courier New', monospace; fill: #666; }
      .annotation { font: 11px 'Segoe UI', Arial, sans-serif; fill: #444; }
      .code { font: 11px 'Courier New', monospace; fill: #0f3460; }
      .box-title { font: bold 12px 'Segoe UI', Arial, sans-serif; fill: #333; }
      .decision-text { font: 11px 'Segoe UI', Arial, sans-serif; fill: #333; }
    </style>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#555"/>
    </marker>
    <marker id="arrow-green" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#2ecc71"/>
    </marker>
    <marker id="arrow-red" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#e94560"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="900" height="650" fill="#fafafa"/>

  <!-- Title -->
  <text x="450" y="30" text-anchor="middle" class="title">BF16 Round-to-Nearest-Even Algorithm</text>
  <text x="450" y="52" text-anchor="middle" class="annotation">The 0x7FFF + LSB trick explained</text>

  <!-- ===== LEFT SIDE: Number Line Visualization ===== -->
  <text x="50" y="90" class="subtitle">Number Line: FP32 values between two BF16 points</text>

  <g transform="translate(50, 105)">
    <!-- Number line -->
    <line x1="0" y1="50" x2="400" y2="50" stroke="#333" stroke-width="2"/>

    <!-- BF16 points -->
    <circle cx="0" cy="50" r="8" fill="#00b4d8"/>
    <text x="0" y="75" text-anchor="middle" class="label">BF16_n</text>
    <text x="0" y="90" text-anchor="middle" class="small-label">(LSB=0)</text>

    <circle cx="400" cy="50" r="8" fill="#00b4d8"/>
    <text x="400" y="75" text-anchor="middle" class="label">BF16_n+1</text>
    <text x="400" y="90" text-anchor="middle" class="small-label">(LSB=1)</text>

    <!-- Midpoint -->
    <line x1="200" y1="35" x2="200" y2="65" stroke="#e94560" stroke-width="2" stroke-dasharray="4,2"/>
    <text x="200" y="28" text-anchor="middle" class="small-label" fill="#e94560">Exact midpoint</text>
    <text x="200" y="90" text-anchor="middle" class="small-label" fill="#e94560">(fraction = 0.5)</text>

    <!-- Regions with labels -->
    <rect x="0" y="100" width="200" height="25" fill="#e8f4f8" stroke="#00b4d8" rx="3"/>
    <text x="100" y="117" text-anchor="middle" class="decision-text">Round DOWN to BF16_n</text>

    <rect x="200" y="100" width="200" height="25" fill="#fff0f3" stroke="#e94560" rx="3"/>
    <text x="300" y="117" text-anchor="middle" class="decision-text">Round UP to BF16_n+1</text>

    <!-- Tie-breaker note -->
    <rect x="150" y="130" width="100" height="40" fill="#ffeaa7" stroke="#f39c12" rx="3"/>
    <text x="200" y="148" text-anchor="middle" class="small-label">At 0.5: pick EVEN</text>
    <text x="200" y="162" text-anchor="middle" class="small-label">(BF16_n, LSB=0)</text>
  </g>

  <!-- ===== RIGHT SIDE: The Magic of 0x7FFF ===== -->
  <text x="500" y="90" class="subtitle">The 0x7FFF + LSB Magic</text>

  <g transform="translate(500, 105)">
    <rect x="0" y="0" width="350" height="170" fill="#f8f9fa" stroke="#dee2e6" rx="5"/>

    <text x="15" y="25" class="box-title">Lower 16 bits of FP32 (to be discarded):</text>

    <text x="15" y="50" class="code">0x0000 to 0x7FFE → fraction &lt; 0.5</text>
    <text x="15" y="68" class="annotation">Adding 0x7FFF won't overflow → rounds down</text>

    <text x="15" y="95" class="code">0x8000 to 0xFFFF → fraction ≥ 0.5</text>
    <text x="15" y="113" class="annotation">Adding 0x7FFF overflows → rounds up</text>

    <text x="15" y="140" class="code">0x8000 exactly → fraction = 0.5</text>
    <text x="15" y="158" class="annotation">+LSB breaks tie: even stays, odd rounds up</text>
  </g>

  <!-- ===== CENTER: Flowchart ===== -->
  <text x="450" y="305" text-anchor="middle" class="subtitle">Conversion Flowchart</text>

  <!-- Input box -->
  <rect x="325" y="320" width="250" height="40" rx="5" fill="#e8f4f8" stroke="#00b4d8" stroke-width="2"/>
  <text x="450" y="345" text-anchor="middle" class="code">Input: FP32 as uint32_t</text>

  <!-- Arrow -->
  <line x1="450" y1="360" x2="450" y2="385" stroke="#555" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Extract LSB box -->
  <rect x="300" y="390" width="300" height="45" rx="5" fill="#fff" stroke="#333" stroke-width="1"/>
  <text x="450" y="410" text-anchor="middle" class="code">lsb = (value >> 16) &amp; 1</text>
  <text x="450" y="427" text-anchor="middle" class="small-label">Extract bit 16 (LSB of future BF16)</text>

  <!-- Arrow -->
  <line x1="450" y1="435" x2="450" y2="460" stroke="#555" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Add rounding box -->
  <rect x="275" y="465" width="350" height="45" rx="5" fill="#fff" stroke="#333" stroke-width="1"/>
  <text x="450" y="485" text-anchor="middle" class="code">value += 0x7FFF + lsb</text>
  <text x="450" y="502" text-anchor="middle" class="small-label">Add rounding bias (may overflow to next value)</text>

  <!-- Arrow -->
  <line x1="450" y1="510" x2="450" y2="535" stroke="#555" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Shift box -->
  <rect x="300" y="540" width="300" height="45" rx="5" fill="#fff" stroke="#333" stroke-width="1"/>
  <text x="450" y="560" text-anchor="middle" class="code">bf16 = value >> 16</text>
  <text x="450" y="577" text-anchor="middle" class="small-label">Truncate lower 16 bits</text>

  <!-- Arrow -->
  <line x1="450" y1="585" x2="450" y2="610" stroke="#555" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Output box -->
  <rect x="325" y="615" width="250" height="30" rx="5" fill="#d4edda" stroke="#2ecc71" stroke-width="2"/>
  <text x="450" y="635" text-anchor="middle" class="code">Output: uint16_t (BF16)</text>

  <!-- ===== BOTTOM: Three Cases Example ===== -->
  <rect x="50" y="315" width="220" height="200" fill="#f8f9fa" stroke="#dee2e6" rx="5"/>
  <text x="160" y="335" text-anchor="middle" class="box-title">Case 1: Round Down</text>
  <text x="60" y="360" class="small-label">FP32 = 0x3F803FFF</text>
  <text x="60" y="378" class="small-label">Lower bits = 0x3FFF (&lt; 0.5)</text>
  <text x="60" y="396" class="small-label">LSB = 0</text>
  <text x="60" y="420" class="small-label">+0x7FFF = 0x3F80BFFE</text>
  <text x="60" y="444" class="small-label">>>16 = 0x3F80</text>
  <text x="60" y="468" class="label" fill="#2ecc71">Result: 0x3F80 (down)</text>

  <rect x="630" y="315" width="220" height="200" fill="#f8f9fa" stroke="#dee2e6" rx="5"/>
  <text x="740" y="335" text-anchor="middle" class="box-title">Case 2: Round Up</text>
  <text x="640" y="360" class="small-label">FP32 = 0x3F80C000</text>
  <text x="640" y="378" class="small-label">Lower bits = 0xC000 (> 0.5)</text>
  <text x="640" y="396" class="small-label">LSB = 0</text>
  <text x="640" y="420" class="small-label">+0x7FFF = 0x3F813FFF</text>
  <text x="640" y="444" class="small-label">>>16 = 0x3F81</text>
  <text x="640" y="468" class="label" fill="#e94560">Result: 0x3F81 (up)</text>

  <rect x="50" y="520" width="220" height="125" fill="#ffeaa7" stroke="#f39c12" rx="5"/>
  <text x="160" y="540" text-anchor="middle" class="box-title">Case 3: Exact Tie</text>
  <text x="60" y="565" class="small-label">FP32 = 0x3F808000 (= 0.5)</text>
  <text x="60" y="583" class="small-label">LSB = 0 (even) → +0x7FFF</text>
  <text x="60" y="601" class="small-label">FP32 = 0x3F818000 (= 0.5)</text>
  <text x="60" y="619" class="small-label">LSB = 1 (odd) → +0x8000</text>
  <text x="60" y="637" class="label" fill="#f39c12">Ties → pick even result</text>

</svg>
