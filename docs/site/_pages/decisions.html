<!-- TITLE: Architecture Decisions -->
<!-- NAV: decisions -->

<style>
/* Collapsible ADR Styling - Dark Mode */
details.adr {
    background: var(--dark-card, #323232);
    border-radius: 8px;
    margin-bottom: 1rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--grey, #454545);
    overflow: hidden;
}

details.adr[open] {
    border-color: var(--orange, #ffb400);
    box-shadow: var(--shadow-md);
}

details.adr summary {
    padding: 1rem 1.5rem;
    cursor: pointer;
    background: linear-gradient(135deg, var(--dark-lighter, #363636) 0%, var(--dark-card, #323232) 100%);
    border-bottom: 2px solid transparent;
    display: flex;
    align-items: center;
    gap: 1rem;
    font-weight: 600;
    color: var(--orange, #ffb400);
    list-style: none;
}

details.adr summary::-webkit-details-marker {
    display: none;
}

details.adr summary::before {
    content: "▶";
    font-size: 0.8rem;
    transition: transform 0.2s;
    color: var(--orange, #ffb400);
}

details.adr[open] summary::before {
    transform: rotate(90deg);
}

details.adr[open] summary {
    border-bottom: 2px solid var(--orange, #ffb400);
    background: linear-gradient(135deg, var(--grey, #454545) 0%, var(--dark-lighter, #363636) 100%);
}

details.adr summary .adr-title {
    flex: 1;
}

details.adr summary .adr-status {
    font-size: 0.85rem;
}

details.adr .adr-content {
    padding: 1.5rem;
    background: var(--dark-card, #323232);
}

.badge-accepted { background: #22c55e; color: white; }
.badge-design { background: #8b5cf6; color: white; }
.badge-perf { background: #f59e0b; color: var(--dark, #2a2a2a); }

.adr-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.5rem;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    background: var(--dark-lighter, #363636);
    padding: 1rem;
    border-radius: 6px;
}

@media (max-width: 768px) {
    .adr-grid { grid-template-columns: repeat(2, 1fr); }
}

/* Dark mode cards inside ADRs */
details.adr .card {
    background: var(--dark-lighter, #363636);
    border-color: var(--grey, #454545);
}

details.adr .grid-2 {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}

@media (max-width: 768px) {
    details.adr .grid-2 { grid-template-columns: 1fr; }
}

/* Alert boxes in dark mode */
details.adr .alert-success {
    background: rgba(34, 197, 94, 0.1);
    border-color: #22c55e;
}

details.adr .alert-warning {
    background: rgba(255, 180, 0, 0.1);
    border-color: var(--orange, #ffb400);
}

/* Code blocks in ADRs */
details.adr pre {
    background: var(--code-bg, #1a1a1a);
    border: 1px solid var(--grey, #454545);
}

/* Highlight card with glow effect */
.highlight-card {
    background: linear-gradient(135deg, var(--dark-lighter, #363636) 0%, var(--dark-card, #323232) 100%);
    border: 1px solid var(--orange, #ffb400);
    border-left: 4px solid var(--orange, #ffb400);
    box-shadow:
        0 0 20px rgba(255, 180, 0, 0.15),
        0 0 40px rgba(255, 180, 0, 0.1),
        inset 0 1px 0 rgba(255, 180, 0, 0.1);
    position: relative;
    overflow: hidden;
}

.highlight-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg,
        transparent,
        var(--orange, #ffb400),
        transparent);
    opacity: 0.8;
}

.highlight-card h3 {
    color: var(--orange, #ffb400);
}

.highlight-card:hover {
    box-shadow:
        0 0 30px rgba(255, 180, 0, 0.2),
        0 0 60px rgba(255, 180, 0, 0.15),
        inset 0 1px 0 rgba(255, 180, 0, 0.15);
    border-color: var(--orange-light, #ffc933);
}

/* Pipeline Flowchart Styling */
.pipeline-flowchart {
    background: var(--dark-card, #323232);
    border: 1px solid var(--grey, #454545);
    border-radius: 12px;
    padding: 2rem;
    margin: 1.5rem 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
}

.pipeline-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--orange, #ffb400);
    letter-spacing: 1px;
    margin-bottom: 1rem;
    padding: 0.5rem 1.5rem;
    border: 2px solid var(--orange, #ffb400);
    border-radius: 6px;
    background: rgba(255, 180, 0, 0.1);
}

.pipeline-input {
    color: var(--text-secondary, #b0b0b0);
    font-size: 0.95rem;
    margin-bottom: 0.25rem;
}

.pipeline-input code {
    background: var(--grey, #454545);
    color: var(--orange, #ffb400);
}

.pipeline-arrow {
    color: var(--orange, #ffb400);
    font-size: 1.2rem;
    line-height: 1;
    opacity: 0.8;
}

.pipeline-stage {
    width: 100%;
    max-width: 500px;
    background: var(--dark-lighter, #363636);
    border: 1px solid var(--grey, #454545);
    border-radius: 8px;
    padding: 1rem 1.5rem;
    display: grid;
    grid-template-columns: auto 1fr;
    grid-template-rows: auto auto;
    gap: 0.25rem 1rem;
    position: relative;
    transition: all 0.2s ease;
}

.pipeline-stage:hover {
    border-color: var(--orange, #ffb400);
    box-shadow: 0 0 15px rgba(255, 180, 0, 0.1);
}

.stage-header {
    font-weight: 700;
    font-size: 1rem;
    color: var(--white, #fff);
    font-family: 'JetBrains Mono', monospace;
}

.stage-subtitle {
    font-size: 0.75rem;
    color: var(--text-muted, #808080);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stage-desc {
    grid-column: 2;
    grid-row: 1 / 3;
    font-size: 0.85rem;
    color: var(--text-secondary, #b0b0b0);
    line-height: 1.5;
    display: flex;
    align-items: center;
}

.stage-desc code {
    font-size: 0.8rem;
    background: var(--code-bg, #1a1a1a);
    padding: 0.15rem 0.4rem;
}

/* Stage accent colors */
.stage-1 { border-left: 3px solid #8b5cf6; }  /* Purple - Graph */
.stage-2 { border-left: 3px solid #f59e0b; }  /* Orange - Lowered */
.stage-3 { border-left: 3px solid #22c55e; }  /* Green - Layout */
.stage-4 { border-left: 3px solid #07adf8; }  /* Blue - Codegen */

.stage-1 .stage-header { color: #a78bfa; }
.stage-2 .stage-header { color: #fbbf24; }
.stage-3 .stage-header { color: #4ade80; }
.stage-4 .stage-header { color: #38bdf8; }

@media (max-width: 600px) {
    .pipeline-stage {
        grid-template-columns: 1fr;
        grid-template-rows: auto;
    }
    .stage-desc {
        grid-column: 1;
        grid-row: auto;
        margin-top: 0.5rem;
    }
}

/* Consequences Grid */
.consequences-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin: 1rem 0;
}

@media (max-width: 600px) {
    .consequences-grid {
        grid-template-columns: 1fr;
    }
}

.consequence-card {
    background: var(--dark-lighter, #363636);
    border: 1px solid var(--grey, #454545);
    border-radius: 8px;
    padding: 1rem 1.25rem;
}

.consequence-card h4 {
    margin: 0 0 0.75rem 0;
    font-size: 1rem;
}

.consequence-card ul {
    margin: 0;
    padding-left: 1.25rem;
}

.consequence-card li {
    margin-bottom: 0.35rem;
    font-size: 0.9rem;
}

.consequence-card.benefit {
    border-left: 4px solid #22c55e;
}

.consequence-card.benefit h4 {
    color: #4ade80;
}

.consequence-card.cost {
    border-left: 4px solid #ef4444;
}

.consequence-card.cost h4 {
    color: #f87171;
}
</style>

<h1>Architecture Decision Records</h1>

<p>This page documents key architectural decisions for the C-Kernel-Engine IR v4 code generation system.
Each ADR explains the <em>context</em>, <em>decision</em>, and <em>consequences</em> to help future contributors
understand why things are built the way they are.</p>

<div class="alert alert-info">
    <div class="alert-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
    </div>
    <div>
        <strong>IR v4 Context</strong><br>
        IR v4 is the "bridge release" unifying v2 (lowering + memory planning) with v3 (deterministic layout).
        These ADRs trace why each step exists in the pipeline.
    </div>
</div>

<div class="card highlight-card">
    <h3 style="margin-top: 0;">Start Here: ADR-001</h3>
    <p style="margin-bottom: 0;"><strong>ADR-001 (Pipeline Split)</strong> is the foundation that explains <em>why</em> we separate Graph IR, Lowered IR, and Layout. Read it first to understand the architecture.</p>
</div>

<h2>Decision Index</h2>

<table>
    <tr>
        <th>ID</th>
        <th>Title</th>
        <th>Category</th>
        <th>Status</th>
    </tr>
    <tr>
        <td><a href="#adr-001">ADR-001</a></td>
        <td>IR v4 Pipeline Split (Graph → Lowered → Layout)</td>
        <td><span class="badge badge-design">Design</span></td>
        <td><span class="badge badge-accepted">Accepted</span></td>
    </tr>
    <tr>
        <td><a href="#adr-002">ADR-002</a></td>
        <td>Templates as Canonical Architecture Source</td>
        <td><span class="badge badge-design">Design</span></td>
        <td><span class="badge badge-accepted">Accepted</span></td>
    </tr>
    <tr>
        <td><a href="#adr-003">ADR-003</a></td>
        <td>Mode-Specific Lowering (Prefill/Decode/Backward)</td>
        <td><span class="badge badge-perf">Performance</span></td>
        <td><span class="badge badge-accepted">Accepted</span></td>
    </tr>
    <tr>
        <td><a href="#adr-004">ADR-004</a></td>
        <td>Deterministic Layout + Canaries for Debug</td>
        <td><span class="badge badge-design">Design</span></td>
        <td><span class="badge badge-accepted">Accepted</span></td>
    </tr>
    <tr>
        <td><a href="#adr-005">ADR-005</a></td>
        <td>Kernel Selection Happens in Lowering</td>
        <td><span class="badge badge-perf">Performance</span></td>
        <td><span class="badge badge-accepted">Accepted</span></td>
    </tr>
    <tr>
        <td><a href="#adr-006">ADR-006</a></td>
        <td>Weights Map from HuggingFace Names via Template</td>
        <td><span class="badge badge-design">Design</span></td>
        <td><span class="badge badge-accepted">Accepted</span></td>
    </tr>
</table>

<!-- ADR-001 -->
<details class="adr" id="adr-001" open>
<summary>
    <span class="adr-title">ADR-001: IR v4 Pipeline Split (Graph → Lowered → Layout)</span>
    <span class="adr-status"><span class="badge badge-accepted">Accepted</span></span>
</summary>
<div class="adr-content">

<div class="adr-grid">
    <div><strong>Status:</strong> Accepted</div>
    <div><strong>Date:</strong> 2025-01</div>
    <div><strong>Category:</strong> <span class="badge badge-design">Design</span></div>
    <div><strong>Supersedes:</strong> IR v2, v3</div>
</div>

<div class="alert alert-success">
    <div class="alert-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6 9 17l-5-5"/></svg>
    </div>
    <div>
        <strong>This is the foundational ADR.</strong> It explains the three-phase pipeline. All other ADRs build on these concepts.
    </div>
</div>

<h3>Context</h3>

<p>Previous IR versions conflated several concerns:</p>
<ul>
    <li><strong>IR v2</strong>: Combined lowering and memory planning into a single phase</li>
    <li><strong>IR v3</strong>: Clean layout but hardcoded architecture knowledge in Python</li>
</ul>

<h3>Decision</h3>

<p>Split the IR pipeline into three distinct phases:</p>

<!-- CSS Flowchart -->
<div class="pipeline-flowchart">
    <div class="pipeline-title">IR v4 PIPELINE</div>

    <div class="pipeline-input">
        <code>config.json</code> + <code>template.yaml</code>
    </div>

    <div class="pipeline-arrow">▼</div>

    <div class="pipeline-stage stage-1">
        <div class="stage-header">GRAPH IR</div>
        <div class="stage-subtitle">High-level</div>
        <div class="stage-desc">Abstract ops: Embed, GEMM, Attention<br>No kernels, no offsets, no modes</div>
    </div>

    <div class="pipeline-arrow">▼</div>

    <div class="pipeline-stage stage-2">
        <div class="stage-header">LOWERED IR</div>
        <div class="stage-subtitle">Per-mode</div>
        <div class="stage-desc">
            Concrete kernels selected<br>
            <code>prefill: gemm_blocked_parallel_bf16</code><br>
            <code>decode: gemm_1x1_bf16</code>
        </div>
    </div>

    <div class="pipeline-arrow">▼</div>

    <div class="pipeline-stage stage-3">
        <div class="stage-header">LAYOUT</div>
        <div class="stage-subtitle">Memory plan</div>
        <div class="stage-desc">Byte offsets, 64B alignment<br>Canary markers for debug</div>
    </div>

    <div class="pipeline-arrow">▼</div>

    <div class="pipeline-stage stage-4">
        <div class="stage-header">CODEGEN</div>
        <div class="stage-subtitle">Output</div>
        <div class="stage-desc">Emit C code with real kernel calls<br><code>model.c</code>, <code>model.h</code>, <code>layout.json</code></div>
    </div>
</div>

<h3>Consequences</h3>

<div class="consequences-grid">
    <div class="consequence-card benefit">
        <h4>Benefits</h4>
        <ul>
            <li>Each phase testable independently</li>
            <li>New modes = new lowering pass</li>
            <li>Layout is deterministic and exportable</li>
            <li>Graph IR can be visualized</li>
        </ul>
    </div>
    <div class="consequence-card cost">
        <h4>Costs</h4>
        <ul>
            <li>Three-phase pipeline more complex</li>
            <li>More intermediate artifacts</li>
            <li>Phases must stay in sync</li>
        </ul>
    </div>
</div>

</div>
</details>

<!-- ADR-002 -->
<details class="adr" id="adr-002">
<summary>
    <span class="adr-title">ADR-002: Templates as Canonical Architecture Source</span>
    <span class="adr-status"><span class="badge badge-accepted">Accepted</span></span>
</summary>
<div class="adr-content">

<div class="adr-grid">
    <div><strong>Status:</strong> Accepted</div>
    <div><strong>Date:</strong> 2025-01</div>
    <div><strong>Category:</strong> <span class="badge badge-design">Design</span></div>
    <div><strong>Supersedes:</strong> Hardcoded Python</div>
</div>

<h3>Context</h3>

<p>In IR v3, model architecture was embedded in <code>build_layer_layout()</code>. Adding new models required modifying core codegen.</p>

<h3>Decision</h3>

<p><strong>Templates are the canonical definition of model architectures.</strong> The IR is a compiled artifact derived from templates + config.json.</p>

<div class="card">
<pre><code class="language-yaml"># templates/qwen2.yaml
name: qwen2
config_mapping:
  hidden_size: embed_dim
  num_attention_heads: num_heads

layers:
  - name: decoder_layers
    repeat: "{{num_layers}}"
    ops:
      - name: pre_attn_norm
        op: RMSNorm
        input: "{{prev_output}}"
        output: normed

      - name: qkv_proj
        op: GEMM
        input: normed
        outputs: [q, k, v]

      - name: attention
        op: Attention
        inputs: [q, k, v]
        output: attn_out
        params:
          causal: true
</code></pre>
</div>

<h3>Consequences</h3>

<ul>
    <li><strong>New architectures</strong>: Add YAML file, not Python code</li>
    <li><strong>Explicit</strong>: Architecture visible at a glance</li>
    <li><strong>Validation</strong>: Can diff templates against HuggingFace</li>
</ul>

</div>
</details>

<!-- ADR-003 -->
<details class="adr" id="adr-003">
<summary>
    <span class="adr-title">ADR-003: Mode-Specific Lowering (Prefill/Decode/Backward)</span>
    <span class="adr-status"><span class="badge badge-accepted">Accepted</span></span>
</summary>
<div class="adr-content">

<div class="adr-grid">
    <div><strong>Status:</strong> Accepted</div>
    <div><strong>Date:</strong> 2025-01</div>
    <div><strong>Category:</strong> <span class="badge badge-perf">Performance</span></div>
    <div><strong>Related:</strong> ADR-005</div>
</div>

<h3>Context</h3>

<p>Transformer inference has fundamentally different execution patterns:</p>
<ul>
    <li><strong>Prefill</strong>: Process entire prompt (T tokens, large buffers)</li>
    <li><strong>Decode</strong>: Generate one token (T=1, KV cache reused)</li>
    <li><strong>Backward</strong>: Compute gradients for training</li>
</ul>

<h3>Decision</h3>

<p><strong>Allocate separate activation buffers for each execution mode.</strong> Weights are shared, working memory is mode-specific.</p>

<div class="card" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
<pre style="background: #1e293b; margin: 0; color: #e2e8f0;">
┌─────────────────────────────────────────────────────────────┐
│                    MEMORY LAYOUT                             │
├─────────────────────────────────────────────────────────────┤
│ Weights (read-only, shared across modes)                     │
├─────────────────────────────────────────────────────────────┤
│ KV Cache (persistent across decode steps)                    │
├─────────────────────────────────────────────────────────────┤
│ Prefill Buffers [max_seq, embed_dim] ← Large                 │
├─────────────────────────────────────────────────────────────┤
│ Decode Buffers [1, embed_dim] ← 2000x smaller                │
└─────────────────────────────────────────────────────────────┘
</pre>
</div>

<h3>Buffer Size Comparison (Qwen2-0.5B)</h3>

<table>
    <tr><th>Buffer</th><th>Prefill</th><th>Decode</th><th>Ratio</th></tr>
    <tr><td>layer_input</td><td>3.5 MB</td><td>1.75 KB</td><td>2048x</td></tr>
    <tr><td>attn_scores</td><td>224 MB</td><td>112 KB</td><td>2048x</td></tr>
</table>

<p>Decode buffers are ~2000x smaller, enabling better cache utilization.</p>

</div>
</details>

<!-- ADR-004 -->
<details class="adr" id="adr-004">
<summary>
    <span class="adr-title">ADR-004: Deterministic Layout + Canaries for Debug</span>
    <span class="adr-status"><span class="badge badge-accepted">Accepted</span></span>
</summary>
<div class="adr-content">

<div class="adr-grid">
    <div><strong>Status:</strong> Accepted</div>
    <div><strong>Date:</strong> 2025-01</div>
    <div><strong>Category:</strong> <span class="badge badge-design">Design</span></div>
    <div><strong>Origin:</strong> IR v3</div>
</div>

<h3>Context</h3>

<p>Buffer overflows in GEMM/attention are common and hard to diagnose. IR v2 used dynamic allocation, making bugs non-reproducible.</p>

<h3>Decision</h3>

<ul>
    <li>All tensor offsets computed at codegen time, baked into C code</li>
    <li>64-byte alignment for AVX-512 cache line optimization</li>
    <li>Insert 64-byte canary markers (<code>0xDEADBEEF</code>) between tensors in debug builds</li>
    <li>Export <code>memory_layout.json</code> for debugging tools</li>
</ul>

<div class="card">
<pre><code class="language-c">// Generated code - offsets are compile-time constants
#define OFFSET_EMBED_WEIGHT      64
#define OFFSET_LAYER_0_WQ        1606720
#define CANARY_0                 272629824  // Between embed and layer_0

// Verify canaries after each layer (debug mode)
bool verify_canaries(Model *model) {
    uint64_t *canary = (uint64_t*)(model->base + CANARY_0);
    for (int j = 0; j < 8; j++) {
        if (canary[j] != 0xDEADBEEFDEADBEEFULL) {
            fprintf(stderr, "CANARY VIOLATION!\n");
            return false;
        }
    }
    return true;
}
</code></pre>
</div>

</div>
</details>

<!-- ADR-005 -->
<details class="adr" id="adr-005">
<summary>
    <span class="adr-title">ADR-005: Kernel Selection Happens in Lowering</span>
    <span class="adr-status"><span class="badge badge-accepted">Accepted</span></span>
</summary>
<div class="adr-content">

<div class="adr-grid">
    <div><strong>Status:</strong> Accepted</div>
    <div><strong>Date:</strong> 2025-01</div>
    <div><strong>Category:</strong> <span class="badge badge-perf">Performance</span></div>
    <div><strong>Related:</strong> ADR-003</div>
</div>

<h3>Context</h3>

<p>Multiple kernel variants exist for each operation:</p>
<ul>
    <li><strong>GEMM</strong>: <code>gemm_blocked_serial_bf16</code>, <code>gemm_blocked_parallel_bf16</code>, <code>gemm_1x1_bf16</code></li>
    <li><strong>Attention</strong>: batch vs single-query, GQA vs MHA</li>
</ul>

<h3>Decision</h3>

<p><strong>Graph IR uses abstract ops. Lowering resolves to concrete kernel function names.</strong></p>

<div class="grid grid-2">
    <div class="card">
        <h4 style="margin-top: 0;">Graph IR (Abstract)</h4>
<pre><code>{"op": "GEMM",
 "inputs": ["x", "w"],
 "output": "y"}</code></pre>
    </div>
    <div class="card">
        <h4 style="margin-top: 0;">Lowered IR (Concrete)</h4>
<pre><code>// Prefill mode
{"kernel": "gemm_blocked_parallel_bf16"}

// Decode mode
{"kernel": "gemm_1x1_bf16"}</code></pre>
    </div>
</div>

<p><strong>Result:</strong> No runtime branching for kernel selection. Mode-specific code paths are explicit.</p>

</div>
</details>

<!-- ADR-006 -->
<details class="adr" id="adr-006">
<summary>
    <span class="adr-title">ADR-006: Weights Map from HuggingFace Names via Template</span>
    <span class="adr-status"><span class="badge badge-accepted">Accepted</span></span>
</summary>
<div class="adr-content">

<div class="adr-grid">
    <div><strong>Status:</strong> Accepted</div>
    <div><strong>Date:</strong> 2025-01</div>
    <div><strong>Category:</strong> <span class="badge badge-design">Design</span></div>
    <div><strong>Related:</strong> ADR-002</div>
</div>

<h3>Context</h3>

<p>HuggingFace models use inconsistent naming conventions:</p>
<ul>
    <li>Llama: <code>model.layers.0.self_attn.q_proj.weight</code></li>
    <li>GPT-2: <code>transformer.h.0.attn.c_attn.weight</code> (combined QKV!)</li>
</ul>

<h3>Decision</h3>

<p><strong>Weight name mapping defined in architecture templates.</strong></p>

<div class="card">
<pre><code class="language-yaml"># templates/qwen2.yaml
weight_mapping:
  "model.embed_tokens.weight": "embed.weight"
  "model.layers.{i}.self_attn.q_proj.weight": "layers.{i}.attn.wq"
  "model.layers.{i}.self_attn.k_proj.weight": "layers.{i}.attn.wk"
  "model.layers.{i}.mlp.gate_proj.weight": "layers.{i}.mlp.gate"
  "model.norm.weight": "final_norm.gamma"
  "lm_head.weight": "lm_head.weight"
</code></pre>
</div>

<p>At codegen, validate all mapped weights exist in safetensors header. Warn about unmapped weights.</p>

</div>
</details>

<h2>Related Documentation</h2>

<ul>
    <li><a href="codegen.html">Code Generation Guide</a> - How generated C code is structured</li>
    <li><a href="ir-v2.html">IR v2 Format</a> - Previous IR format documentation</li>
    <li><a href="memory-safety.html">Memory Safety</a> - Canary and debug features</li>
</ul>
