<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEMM Optimization | C-Kernel-Engine</title>
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
    <style>
        :root {
            /* Antsand Brand Colors - Lightened */
            --orange: #ffb400;
            --orange-dark: #e5a200;
            --orange-light: #ffc933;
            --dark: #2a2a2a;
            --dark-lighter: #363636;
            --dark-card: #323232;
            --grey: #454545;
            --grey-light: #555555;
            --text-primary: #f5f5f5;
            --text-secondary: #b0b0b0;
            --text-muted: #808080;
            --bg-dark: #232323;
            --white: #ffffff;
            --code-bg: #1a1a1a;
            --green: #47b475;
            --blue: #07adf8;
            --purple: #a855f7;
            --red: #ef4444;
            --gradient-header: linear-gradient(135deg, #2a2a2a 0%, #363636 50%, #2a2a2a 100%);
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.5);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--bg-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .site-header {
            background: var(--gradient-header);
            border-bottom: 3px solid var(--orange);
            padding: 0.5rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow-md);
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
        }

        .header-logo {
            width: 40px;
            height: 40px;
            background: var(--orange);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--dark);
            font-size: 1.1rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .header-title {
            color: var(--white);
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header-subtitle {
            color: var(--orange);
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Navigation */
        .site-nav {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .site-nav > a {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 0.6rem 1rem;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: var(--transition);
        }

        .site-nav > a:hover {
            color: var(--white);
            background: var(--grey);
        }

        .site-nav > a.active {
            background: var(--orange);
            color: var(--dark);
            font-weight: 600;
        }

        /* Main Content */
        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            flex: 1;
            width: 100%;
        }

        /* Hero Section */
        .hero {
            background: var(--gradient-header);
            border: 1px solid var(--grey);
            color: var(--white);
            padding: 3rem 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--orange), var(--orange-light), var(--orange));
        }

        .hero h1 {
            color: var(--white);
            border: none;
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .hero p {
            font-size: 1.1rem;
            color: var(--text-secondary);
            max-width: 800px;
            margin: 0 auto;
        }

        .hero-badge {
            display: inline-block;
            background: var(--green);
            color: var(--dark);
            padding: 0.3rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 1rem;
        }

        /* Typography */
        h1 {
            color: var(--white);
            font-size: 2rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--orange);
            padding-bottom: 0.5rem;
        }

        h2 {
            color: var(--white);
            font-size: 1.5rem;
            margin: 2.5rem 0 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        h2::before {
            content: '';
            width: 4px;
            height: 1.5rem;
            background: var(--orange);
            border-radius: 2px;
        }

        h3 {
            color: var(--orange);
            font-size: 1.2rem;
            margin: 1.5rem 0 0.75rem;
        }

        p {
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }

        /* Cards */
        .card {
            background: var(--dark-card);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--grey);
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card h3 {
            margin-top: 0;
        }

        /* Grid */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        /* SVG Container */
        .svg-container {
            background: var(--code-bg);
            border-radius: 12px;
            padding: 2rem;
            margin: 1.5rem 0;
            border: 1px solid var(--grey);
            overflow-x: auto;
        }

        .svg-container svg {
            display: block;
            margin: 0 auto;
            max-width: 100%;
            height: auto;
        }

        /* Stats */
        .stat-card {
            background: var(--dark-card);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid var(--grey);
            transition: var(--transition);
        }

        .stat-card:hover {
            border-color: var(--orange);
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--orange);
            line-height: 1.2;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .stat-card.green .stat-value { color: var(--green); }
        .stat-card.blue .stat-value { color: var(--blue); }
        .stat-card.purple .stat-value { color: var(--purple); }

        /* Timeline */
        .timeline {
            position: relative;
            padding-left: 2rem;
            margin: 2rem 0;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, var(--orange), var(--green));
            border-radius: 3px;
        }

        .timeline-item {
            position: relative;
            padding-bottom: 2rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -2rem;
            top: 0.3rem;
            width: 12px;
            height: 12px;
            background: var(--orange);
            border-radius: 50%;
            border: 3px solid var(--bg-dark);
        }

        .timeline-item.done::before {
            background: var(--green);
        }

        .timeline-title {
            color: var(--white);
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .timeline-desc {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* Code blocks */
        code {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            background: var(--code-bg);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.9em;
            color: var(--orange-light);
        }

        pre {
            background: var(--code-bg);
            border-radius: 8px;
            padding: 1.5rem;
            overflow-x: auto;
            border: 1px solid var(--grey);
            margin: 1rem 0;
        }

        pre code {
            background: none;
            padding: 0;
            font-size: 0.85rem;
            line-height: 1.6;
        }

        /* Comparison Table */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            background: var(--dark-card);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--grey);
        }

        .comparison-table th,
        .comparison-table td {
            padding: 1rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid var(--grey);
        }

        .comparison-table th {
            background: var(--dark);
            color: var(--white);
            font-weight: 600;
        }

        .comparison-table td {
            color: var(--text-secondary);
        }

        .comparison-table tr:last-child td {
            border-bottom: none;
        }

        .comparison-table tr:hover td {
            background: var(--grey);
        }

        .faster {
            color: var(--green);
            font-weight: 600;
        }

        .slower {
            color: var(--red);
        }

        /* Footer */
        .site-footer {
            background: var(--dark);
            border-top: 1px solid var(--grey);
            padding: 2rem;
            text-align: center;
            color: var(--text-muted);
            margin-top: auto;
        }

        /* Inspiration logos */
        .inspiration-grid {
            display: flex;
            justify-content: center;
            gap: 3rem;
            flex-wrap: wrap;
            margin: 2rem 0;
        }

        .inspiration-item {
            text-align: center;
            color: var(--text-secondary);
        }

        .inspiration-item svg {
            margin-bottom: 0.5rem;
        }

        .inspiration-item span {
            display: block;
            font-size: 0.85rem;
        }

        /* Legend */
        .legend {
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
            margin: 1rem 0;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="site-header">
        <a href="index.html" class="header-brand">
            <div class="header-logo">CK</div>
            <div>
                <div class="header-title">C-Kernel-Engine</div>
                <div class="header-subtitle">High-Performance ML Kernels</div>
            </div>
        </a>
        <nav class="site-nav">
            <a href="index.html">Home</a>
            <a href="quickstart.html">Quickstart</a>
            <a href="kernels.html">Kernels</a>
            <a href="gemm-optimization.html" class="active">GEMM</a>
            <a href="architecture.html">Architecture</a>
            <a href="api.html">API</a>
        </nav>
    </header>

    <main>
        <!-- Hero -->
        <section class="hero">
            <h1>GEMM Optimization Deep Dive</h1>
            <p>How we built a high-performance matrix multiplication kernel that beats Intel MKL, inspired by oneDNN, BLIS, and decades of HPC research.</p>
            <span class="hero-badge">1.44x Faster than PyTorch/MKL</span>
        </section>

        <!-- Performance Stats -->
        <div class="grid-4">
            <div class="stat-card">
                <div class="stat-value">52.95</div>
                <div class="stat-label">Peak GFLOPS</div>
            </div>
            <div class="stat-card green">
                <div class="stat-value">1.44x</div>
                <div class="stat-label">vs PyTorch/MKL</div>
            </div>
            <div class="stat-card blue">
                <div class="stat-value">4.31x</div>
                <div class="stat-label">vs Naive GEMM</div>
            </div>
            <div class="stat-card purple">
                <div class="stat-value">8x8</div>
                <div class="stat-label">Register Tile</div>
            </div>
        </div>

        <!-- Inspiration Section -->
        <h2>Standing on the Shoulders of Giants</h2>
        <p>Our GEMM implementation draws from decades of high-performance computing research and industry-leading libraries:</p>

        <div class="svg-container">
            <svg width="900" height="200" viewBox="0 0 900 200">
                <!-- oneDNN -->
                <g transform="translate(100, 50)">
                    <rect x="0" y="0" width="120" height="80" rx="10" fill="#0071c5" opacity="0.2" stroke="#0071c5" stroke-width="2"/>
                    <text x="60" y="35" text-anchor="middle" fill="#0071c5" font-size="16" font-weight="bold">oneDNN</text>
                    <text x="60" y="55" text-anchor="middle" fill="#b0b0b0" font-size="11">Intel Deep Neural</text>
                    <text x="60" y="70" text-anchor="middle" fill="#b0b0b0" font-size="11">Network Library</text>
                </g>
                <!-- Arrow -->
                <path d="M230 90 L280 90" stroke="#ffb400" stroke-width="2" marker-end="url(#arrowhead)"/>

                <!-- BLIS -->
                <g transform="translate(300, 50)">
                    <rect x="0" y="0" width="120" height="80" rx="10" fill="#47b475" opacity="0.2" stroke="#47b475" stroke-width="2"/>
                    <text x="60" y="35" text-anchor="middle" fill="#47b475" font-size="16" font-weight="bold">BLIS</text>
                    <text x="60" y="55" text-anchor="middle" fill="#b0b0b0" font-size="11">BLAS-like Library</text>
                    <text x="60" y="70" text-anchor="middle" fill="#b0b0b0" font-size="11">Instantiation</text>
                </g>
                <!-- Arrow -->
                <path d="M430 90 L480 90" stroke="#ffb400" stroke-width="2" marker-end="url(#arrowhead)"/>

                <!-- Intel MKL -->
                <g transform="translate(500, 50)">
                    <rect x="0" y="0" width="120" height="80" rx="10" fill="#a855f7" opacity="0.2" stroke="#a855f7" stroke-width="2"/>
                    <text x="60" y="35" text-anchor="middle" fill="#a855f7" font-size="16" font-weight="bold">Intel MKL</text>
                    <text x="60" y="55" text-anchor="middle" fill="#b0b0b0" font-size="11">Math Kernel</text>
                    <text x="60" y="70" text-anchor="middle" fill="#b0b0b0" font-size="11">Library</text>
                </g>
                <!-- Arrow -->
                <path d="M630 90 L680 90" stroke="#ffb400" stroke-width="2" marker-end="url(#arrowhead)"/>

                <!-- Our Implementation -->
                <g transform="translate(700, 50)">
                    <rect x="0" y="0" width="140" height="80" rx="10" fill="#ffb400" opacity="0.3" stroke="#ffb400" stroke-width="3"/>
                    <text x="70" y="35" text-anchor="middle" fill="#ffb400" font-size="16" font-weight="bold">C-Kernel</text>
                    <text x="70" y="55" text-anchor="middle" fill="#ffb400" font-size="16" font-weight="bold">Engine</text>
                    <text x="70" y="75" text-anchor="middle" fill="#47b475" font-size="11" font-weight="bold">1.44x Faster!</text>
                </g>

                <!-- Key concepts below -->
                <text x="160" y="160" text-anchor="middle" fill="#808080" font-size="10">JIT Compilation</text>
                <text x="160" y="175" text-anchor="middle" fill="#808080" font-size="10">Post-ops Fusion</text>

                <text x="360" y="160" text-anchor="middle" fill="#808080" font-size="10">Microkernel Design</text>
                <text x="360" y="175" text-anchor="middle" fill="#808080" font-size="10">Register Blocking</text>

                <text x="560" y="160" text-anchor="middle" fill="#808080" font-size="10">Matrix Packing</text>
                <text x="560" y="175" text-anchor="middle" fill="#808080" font-size="10">Cache Optimization</text>

                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#ffb400"/>
                    </marker>
                </defs>
            </svg>
        </div>

        <!-- The Microkernel Architecture -->
        <h2>The 8x8 Microkernel Architecture</h2>
        <p>The heart of our GEMM is an 8x8 microkernel that keeps all 64 accumulator values in AVX registers throughout the entire K-loop. This is the same strategy used by oneDNN and BLIS.</p>

        <div class="svg-container">
            <svg width="900" height="450" viewBox="0 0 900 450">
                <!-- Title -->
                <text x="450" y="30" text-anchor="middle" fill="#ffffff" font-size="18" font-weight="bold">8x8 Register-Blocked Microkernel</text>

                <!-- A Matrix (8 x K) -->
                <g transform="translate(50, 60)">
                    <text x="40" y="0" text-anchor="middle" fill="#07adf8" font-size="14" font-weight="bold">A [8 x K]</text>
                    <rect x="0" y="10" width="80" height="160" rx="4" fill="#07adf8" opacity="0.2" stroke="#07adf8" stroke-width="2"/>
                    <!-- Row labels -->
                    <text x="-10" y="35" text-anchor="end" fill="#808080" font-size="10">row 0</text>
                    <text x="-10" y="55" text-anchor="end" fill="#808080" font-size="10">row 1</text>
                    <text x="-10" y="75" text-anchor="end" fill="#808080" font-size="10">row 2</text>
                    <text x="-10" y="155" text-anchor="end" fill="#808080" font-size="10">row 7</text>
                    <!-- Dots -->
                    <text x="40" y="115" text-anchor="middle" fill="#808080" font-size="16">...</text>
                    <!-- Highlight column k -->
                    <rect x="35" y="10" width="10" height="160" fill="#ffb400" opacity="0.4"/>
                    <text x="40" y="185" text-anchor="middle" fill="#ffb400" font-size="10">col k</text>
                </g>

                <!-- @ symbol -->
                <text x="170" y="150" text-anchor="middle" fill="#ffffff" font-size="24">@</text>

                <!-- B Matrix (K x 8) -->
                <g transform="translate(200, 60)">
                    <text x="80" y="0" text-anchor="middle" fill="#47b475" font-size="14" font-weight="bold">B [K x 8]</text>
                    <rect x="0" y="10" width="160" height="80" rx="4" fill="#47b475" opacity="0.2" stroke="#47b475" stroke-width="2"/>
                    <!-- Highlight row k -->
                    <rect x="0" y="35" width="160" height="10" fill="#ffb400" opacity="0.4"/>
                    <text x="-10" y="43" text-anchor="end" fill="#ffb400" font-size="10">k</text>
                    <!-- Column labels -->
                    <text x="10" y="105" text-anchor="middle" fill="#808080" font-size="10">0</text>
                    <text x="30" y="105" text-anchor="middle" fill="#808080" font-size="10">1</text>
                    <text x="50" y="105" text-anchor="middle" fill="#808080" font-size="10">2</text>
                    <text x="80" y="105" text-anchor="middle" fill="#808080" font-size="10">...</text>
                    <text x="150" y="105" text-anchor="middle" fill="#808080" font-size="10">7</text>
                </g>

                <!-- = symbol -->
                <text x="400" y="150" text-anchor="middle" fill="#ffffff" font-size="24">=</text>

                <!-- C Matrix (8 x 8) - The accumulator -->
                <g transform="translate(440, 60)">
                    <text x="80" y="0" text-anchor="middle" fill="#ffb400" font-size="14" font-weight="bold">C [8 x 8] in Registers</text>
                    <rect x="0" y="10" width="160" height="160" rx="4" fill="#ffb400" opacity="0.2" stroke="#ffb400" stroke-width="3"/>
                    <!-- Grid lines -->
                    <line x1="20" y1="10" x2="20" y2="170" stroke="#ffb400" stroke-width="0.5" opacity="0.5"/>
                    <line x1="40" y1="10" x2="40" y2="170" stroke="#ffb400" stroke-width="0.5" opacity="0.5"/>
                    <line x1="60" y1="10" x2="60" y2="170" stroke="#ffb400" stroke-width="0.5" opacity="0.5"/>
                    <line x1="80" y1="10" x2="80" y2="170" stroke="#ffb400" stroke-width="0.5" opacity="0.5"/>
                    <line x1="100" y1="10" x2="100" y2="170" stroke="#ffb400" stroke-width="0.5" opacity="0.5"/>
                    <line x1="120" y1="10" x2="120" y2="170" stroke="#ffb400" stroke-width="0.5" opacity="0.5"/>
                    <line x1="140" y1="10" x2="140" y2="170" stroke="#ffb400" stroke-width="0.5" opacity="0.5"/>
                    <line x1="0" y1="30" x2="160" y2="30" stroke="#ffb400" stroke-width="0.5" opacity="0.5"/>
                    <line x1="0" y1="50" x2="160" y2="50" stroke="#ffb400" stroke-width="0.5" opacity="0.5"/>
                    <line x1="0" y1="70" x2="160" y2="70" stroke="#ffb400" stroke-width="0.5" opacity="0.5"/>
                    <line x1="0" y1="90" x2="160" y2="90" stroke="#ffb400" stroke-width="0.5" opacity="0.5"/>
                    <line x1="0" y1="110" x2="160" y2="110" stroke="#ffb400" stroke-width="0.5" opacity="0.5"/>
                    <line x1="0" y1="130" x2="160" y2="130" stroke="#ffb400" stroke-width="0.5" opacity="0.5"/>
                    <line x1="0" y1="150" x2="160" y2="150" stroke="#ffb400" stroke-width="0.5" opacity="0.5"/>
                    <text x="80" y="100" text-anchor="middle" fill="#ffb400" font-size="12" font-weight="bold">64 floats</text>
                </g>

                <!-- Register assignments -->
                <g transform="translate(630, 60)">
                    <text x="0" y="0" fill="#ffffff" font-size="14" font-weight="bold">YMM Registers:</text>
                    <rect x="0" y="15" width="200" height="155" rx="8" fill="#1a1a1a" stroke="#555555"/>
                    <text x="10" y="40" fill="#07adf8" font-size="12" font-family="monospace">c0 = row 0 of C [8 floats]</text>
                    <text x="10" y="60" fill="#07adf8" font-size="12" font-family="monospace">c1 = row 1 of C [8 floats]</text>
                    <text x="10" y="80" fill="#07adf8" font-size="12" font-family="monospace">c2 = row 2 of C [8 floats]</text>
                    <text x="10" y="100" fill="#808080" font-size="12" font-family="monospace">...</text>
                    <text x="10" y="120" fill="#07adf8" font-size="12" font-family="monospace">c7 = row 7 of C [8 floats]</text>
                    <text x="10" y="145" fill="#47b475" font-size="12" font-family="monospace">b  = B[k, 0:8]  [8 floats]</text>
                    <text x="10" y="165" fill="#a855f7" font-size="12" font-family="monospace">a0-a7 = A[0:8, k] broadcast</text>
                </g>

                <!-- The K-loop visualization -->
                <g transform="translate(50, 280)">
                    <text x="400" y="0" text-anchor="middle" fill="#ffffff" font-size="16" font-weight="bold">The K-Loop: All 64 Values Stay in Registers!</text>

                    <!-- Loop iterations -->
                    <g transform="translate(0, 30)">
                        <!-- k=0 -->
                        <rect x="0" y="0" width="150" height="80" rx="8" fill="#323232" stroke="#555555"/>
                        <text x="75" y="20" text-anchor="middle" fill="#ffb400" font-size="12" font-weight="bold">k = 0</text>
                        <text x="75" y="40" text-anchor="middle" fill="#b0b0b0" font-size="10">b = load B[0, :]</text>
                        <text x="75" y="55" text-anchor="middle" fill="#b0b0b0" font-size="10">a = broadcast A[:, 0]</text>
                        <text x="75" y="70" text-anchor="middle" fill="#47b475" font-size="10">c += a * b</text>

                        <!-- Arrow -->
                        <path d="M160 40 L190 40" stroke="#ffb400" stroke-width="2" marker-end="url(#arrowhead)"/>

                        <!-- k=1 -->
                        <rect x="200" y="0" width="150" height="80" rx="8" fill="#323232" stroke="#555555"/>
                        <text x="275" y="20" text-anchor="middle" fill="#ffb400" font-size="12" font-weight="bold">k = 1</text>
                        <text x="275" y="40" text-anchor="middle" fill="#b0b0b0" font-size="10">b = load B[1, :]</text>
                        <text x="275" y="55" text-anchor="middle" fill="#b0b0b0" font-size="10">a = broadcast A[:, 1]</text>
                        <text x="275" y="70" text-anchor="middle" fill="#47b475" font-size="10">c += a * b</text>

                        <!-- Arrow -->
                        <path d="M360 40 L390 40" stroke="#ffb400" stroke-width="2" marker-end="url(#arrowhead)"/>

                        <!-- ... -->
                        <text x="430" y="45" text-anchor="middle" fill="#808080" font-size="20">...</text>

                        <!-- Arrow -->
                        <path d="M470 40 L500 40" stroke="#ffb400" stroke-width="2" marker-end="url(#arrowhead)"/>

                        <!-- k=K-1 -->
                        <rect x="510" y="0" width="150" height="80" rx="8" fill="#323232" stroke="#555555"/>
                        <text x="585" y="20" text-anchor="middle" fill="#ffb400" font-size="12" font-weight="bold">k = K-1</text>
                        <text x="585" y="40" text-anchor="middle" fill="#b0b0b0" font-size="10">b = load B[K-1, :]</text>
                        <text x="585" y="55" text-anchor="middle" fill="#b0b0b0" font-size="10">a = broadcast A[:, K-1]</text>
                        <text x="585" y="70" text-anchor="middle" fill="#47b475" font-size="10">c += a * b</text>

                        <!-- Arrow to store -->
                        <path d="M670 40 L700 40" stroke="#47b475" stroke-width="2" marker-end="url(#arrowhead2)"/>

                        <!-- Final store -->
                        <rect x="710" y="0" width="120" height="80" rx="8" fill="#47b475" opacity="0.2" stroke="#47b475" stroke-width="2"/>
                        <text x="770" y="35" text-anchor="middle" fill="#47b475" font-size="12" font-weight="bold">Store C</text>
                        <text x="770" y="55" text-anchor="middle" fill="#b0b0b0" font-size="10">to memory</text>
                        <text x="770" y="70" text-anchor="middle" fill="#47b475" font-size="10">ONCE!</text>
                    </g>
                </g>

                <!-- Key insight -->
                <g transform="translate(50, 410)">
                    <rect x="0" y="0" width="800" height="30" rx="6" fill="#ffb400" opacity="0.15"/>
                    <text x="400" y="20" text-anchor="middle" fill="#ffb400" font-size="13" font-weight="bold">
                        Key Insight: C values never leave registers during the entire K-loop = Maximum arithmetic intensity
                    </text>
                </g>

                <defs>
                    <marker id="arrowhead2" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#47b475"/>
                    </marker>
                </defs>
            </svg>
        </div>

        <!-- Matrix Packing -->
        <h2>Matrix Packing for Cache Efficiency</h2>
        <p>For large matrices, we pack A and B into contiguous memory layouts that maximize cache line utilization. This is the key technique that allowed us to beat MKL.</p>

        <div class="svg-container">
            <svg width="900" height="350" viewBox="0 0 900 350">
                <!-- Title -->
                <text x="450" y="25" text-anchor="middle" fill="#ffffff" font-size="16" font-weight="bold">Matrix Packing: Before vs After</text>

                <!-- Before: Original Layout -->
                <g transform="translate(50, 50)">
                    <text x="150" y="0" text-anchor="middle" fill="#ef4444" font-size="14" font-weight="bold">Before: Strided Access</text>

                    <!-- Original A matrix -->
                    <rect x="0" y="20" width="300" height="120" rx="4" fill="#07adf8" opacity="0.15" stroke="#07adf8"/>
                    <text x="150" y="45" text-anchor="middle" fill="#07adf8" font-size="12">A Matrix [M x K]</text>

                    <!-- Show strided access pattern -->
                    <g transform="translate(20, 55)">
                        <rect x="0" y="0" width="260" height="15" fill="#323232" stroke="#555555"/>
                        <rect x="0" y="18" width="260" height="15" fill="#323232" stroke="#555555"/>
                        <rect x="0" y="36" width="260" height="15" fill="#323232" stroke="#555555"/>
                        <rect x="0" y="54" width="260" height="15" fill="#323232" stroke="#555555"/>

                        <!-- Access arrows showing stride -->
                        <path d="M10 7 L10 61" stroke="#ef4444" stroke-width="2" stroke-dasharray="4"/>
                        <path d="M30 7 L30 61" stroke="#ef4444" stroke-width="2" stroke-dasharray="4"/>
                        <path d="M50 7 L50 61" stroke="#ef4444" stroke-width="2" stroke-dasharray="4"/>
                    </g>

                    <text x="150" y="155" text-anchor="middle" fill="#ef4444" font-size="11">Cache misses on every row!</text>
                </g>

                <!-- Arrow -->
                <g transform="translate(370, 110)">
                    <path d="M0 30 L60 30" stroke="#ffb400" stroke-width="3" marker-end="url(#arrowhead)"/>
                    <text x="30" y="15" text-anchor="middle" fill="#ffb400" font-size="11" font-weight="bold">pack_a()</text>
                </g>

                <!-- After: Packed Layout -->
                <g transform="translate(450, 50)">
                    <text x="180" y="0" text-anchor="middle" fill="#47b475" font-size="14" font-weight="bold">After: Contiguous Access</text>

                    <!-- Packed A matrix -->
                    <rect x="0" y="20" width="360" height="120" rx="4" fill="#47b475" opacity="0.15" stroke="#47b475"/>
                    <text x="180" y="45" text-anchor="middle" fill="#47b475" font-size="12">Packed A [MC x KC panels]</text>

                    <!-- Show packed layout - panels side by side -->
                    <g transform="translate(20, 55)">
                        <!-- Panel 0 -->
                        <rect x="0" y="0" width="70" height="60" fill="#47b475" opacity="0.3" stroke="#47b475"/>
                        <text x="35" y="35" text-anchor="middle" fill="#47b475" font-size="10">Panel 0</text>

                        <!-- Panel 1 -->
                        <rect x="80" y="0" width="70" height="60" fill="#47b475" opacity="0.3" stroke="#47b475"/>
                        <text x="115" y="35" text-anchor="middle" fill="#47b475" font-size="10">Panel 1</text>

                        <!-- Panel 2 -->
                        <rect x="160" y="0" width="70" height="60" fill="#47b475" opacity="0.3" stroke="#47b475"/>
                        <text x="195" y="35" text-anchor="middle" fill="#47b475" font-size="10">Panel 2</text>

                        <!-- Sequential access arrow -->
                        <path d="M5 70 L235 70" stroke="#47b475" stroke-width="2" marker-end="url(#arrowhead2)"/>
                    </g>

                    <text x="180" y="155" text-anchor="middle" fill="#47b475" font-size="11">Sequential memory access!</text>
                </g>

                <!-- B Matrix packing -->
                <g transform="translate(50, 200)">
                    <text x="150" y="0" text-anchor="middle" fill="#ef4444" font-size="14" font-weight="bold">B Matrix: Column Stride</text>

                    <rect x="0" y="20" width="300" height="100" rx="4" fill="#a855f7" opacity="0.15" stroke="#a855f7"/>

                    <!-- Show column access -->
                    <g transform="translate(20, 35)">
                        <rect x="0" y="0" width="20" height="70" fill="#323232" stroke="#555555"/>
                        <rect x="25" y="0" width="20" height="70" fill="#323232" stroke="#555555"/>
                        <rect x="50" y="0" width="20" height="70" fill="#323232" stroke="#555555"/>
                        <text x="100" y="40" fill="#808080" font-size="14">...</text>
                        <rect x="130" y="0" width="20" height="70" fill="#323232" stroke="#555555"/>

                        <!-- Stride arrows -->
                        <path d="M10 5 L145 5" stroke="#ef4444" stroke-width="2" stroke-dasharray="4"/>
                    </g>
                </g>

                <!-- Arrow -->
                <g transform="translate(370, 250)">
                    <path d="M0 30 L60 30" stroke="#ffb400" stroke-width="3" marker-end="url(#arrowhead)"/>
                    <text x="30" y="15" text-anchor="middle" fill="#ffb400" font-size="11" font-weight="bold">pack_b()</text>
                </g>

                <!-- Packed B -->
                <g transform="translate(450, 200)">
                    <text x="180" y="0" text-anchor="middle" fill="#47b475" font-size="14" font-weight="bold">B Packed: Row-Panel Format</text>

                    <rect x="0" y="20" width="360" height="100" rx="4" fill="#47b475" opacity="0.15" stroke="#47b475"/>

                    <!-- Packed B - K x NR contiguous -->
                    <g transform="translate(20, 35)">
                        <rect x="0" y="0" width="320" height="20" fill="#47b475" opacity="0.3" stroke="#47b475"/>
                        <text x="160" y="14" text-anchor="middle" fill="#47b475" font-size="10">k=0: [8 floats contiguous]</text>

                        <rect x="0" y="25" width="320" height="20" fill="#47b475" opacity="0.3" stroke="#47b475"/>
                        <text x="160" y="39" text-anchor="middle" fill="#47b475" font-size="10">k=1: [8 floats contiguous]</text>

                        <rect x="0" y="50" width="320" height="20" fill="#47b475" opacity="0.3" stroke="#47b475"/>
                        <text x="160" y="64" text-anchor="middle" fill="#47b475" font-size="10">k=2: [8 floats contiguous]</text>
                    </g>
                </g>

                <!-- Benefit callout -->
                <g transform="translate(50, 320)">
                    <rect x="0" y="0" width="800" height="25" rx="6" fill="#47b475" opacity="0.15"/>
                    <text x="400" y="17" text-anchor="middle" fill="#47b475" font-size="12" font-weight="bold">
                        Packing converts strided access to sequential access = Full cache line utilization
                    </text>
                </g>
            </svg>
        </div>

        <!-- Cache Blocking Strategy -->
        <h2>Three-Level Cache Blocking</h2>
        <p>We tile the computation to fit each level of the memory hierarchy, minimizing data movement between DRAM and CPU.</p>

        <div class="svg-container">
            <svg width="900" height="380" viewBox="0 0 900 380">
                <!-- Memory Hierarchy -->
                <g transform="translate(50, 30)">
                    <text x="100" y="0" text-anchor="middle" fill="#ffffff" font-size="14" font-weight="bold">Memory Hierarchy</text>

                    <!-- Registers -->
                    <rect x="60" y="20" width="80" height="40" rx="6" fill="#ffb400" opacity="0.3" stroke="#ffb400" stroke-width="2"/>
                    <text x="100" y="45" text-anchor="middle" fill="#ffb400" font-size="11" font-weight="bold">Registers</text>
                    <text x="160" y="45" fill="#808080" font-size="10">~1 cycle</text>

                    <!-- L1 Cache -->
                    <rect x="40" y="70" width="120" height="40" rx="6" fill="#47b475" opacity="0.3" stroke="#47b475" stroke-width="2"/>
                    <text x="100" y="95" text-anchor="middle" fill="#47b475" font-size="11" font-weight="bold">L1 Cache (32KB)</text>
                    <text x="175" y="95" fill="#808080" font-size="10">~4 cycles</text>

                    <!-- L2 Cache -->
                    <rect x="20" y="120" width="160" height="40" rx="6" fill="#07adf8" opacity="0.3" stroke="#07adf8" stroke-width="2"/>
                    <text x="100" y="145" text-anchor="middle" fill="#07adf8" font-size="11" font-weight="bold">L2 Cache (256KB)</text>
                    <text x="195" y="145" fill="#808080" font-size="10">~12 cycles</text>

                    <!-- L3 Cache -->
                    <rect x="0" y="170" width="200" height="40" rx="6" fill="#a855f7" opacity="0.3" stroke="#a855f7" stroke-width="2"/>
                    <text x="100" y="195" text-anchor="middle" fill="#a855f7" font-size="11" font-weight="bold">L3 Cache (6-8MB)</text>
                    <text x="215" y="195" fill="#808080" font-size="10">~40 cycles</text>

                    <!-- DRAM -->
                    <rect x="-20" y="220" width="240" height="40" rx="6" fill="#ef4444" opacity="0.3" stroke="#ef4444" stroke-width="2"/>
                    <text x="100" y="245" text-anchor="middle" fill="#ef4444" font-size="11" font-weight="bold">DRAM (Main Memory)</text>
                    <text x="235" y="245" fill="#808080" font-size="10">~200 cycles</text>
                </g>

                <!-- Blocking Parameters -->
                <g transform="translate(350, 30)">
                    <text x="200" y="0" text-anchor="middle" fill="#ffffff" font-size="14" font-weight="bold">Our Blocking Parameters</text>

                    <!-- MC x KC for L2 -->
                    <rect x="0" y="25" width="400" height="70" rx="8" fill="#323232" stroke="#07adf8"/>
                    <text x="200" y="50" text-anchor="middle" fill="#07adf8" font-size="13" font-weight="bold">A Panel: MC x KC = 64 x 256</text>
                    <text x="200" y="70" text-anchor="middle" fill="#808080" font-size="11">64 × 256 × 4 bytes = 64KB (fits in L2)</text>
                    <text x="200" y="85" text-anchor="middle" fill="#47b475" font-size="10">Reused across all N tiles</text>

                    <!-- KC x NC for L3 -->
                    <rect x="0" y="105" width="400" height="70" rx="8" fill="#323232" stroke="#a855f7"/>
                    <text x="200" y="130" text-anchor="middle" fill="#a855f7" font-size="13" font-weight="bold">B Panel: KC x NC = 256 x 256</text>
                    <text x="200" y="150" text-anchor="middle" fill="#808080" font-size="11">256 × 256 × 4 bytes = 256KB (fits in L3)</text>
                    <text x="200" y="165" text-anchor="middle" fill="#47b475" font-size="10">Reused across all M tiles</text>

                    <!-- MR x NR for registers -->
                    <rect x="0" y="185" width="400" height="70" rx="8" fill="#323232" stroke="#ffb400"/>
                    <text x="200" y="210" text-anchor="middle" fill="#ffb400" font-size="13" font-weight="bold">Microkernel: MR x NR = 8 x 8</text>
                    <text x="200" y="230" text-anchor="middle" fill="#808080" font-size="11">8 × 8 × 4 bytes = 256 bytes (fits in 8 YMM registers)</text>
                    <text x="200" y="245" text-anchor="middle" fill="#47b475" font-size="10">All accumulators in registers!</text>
                </g>

                <!-- Loop Nest Diagram -->
                <g transform="translate(50, 290)">
                    <text x="400" y="0" text-anchor="middle" fill="#ffffff" font-size="14" font-weight="bold">Loop Nest Structure</text>

                    <rect x="0" y="15" width="800" height="60" rx="8" fill="#1a1a1a" stroke="#555555"/>

                    <text x="20" y="40" fill="#a855f7" font-size="12" font-family="monospace">for k0 in range(0, K, KC):</text>
                    <text x="50" y="55" fill="#07adf8" font-size="12" font-family="monospace">for n0 in range(0, N, NC):    # pack B panel</text>
                    <text x="80" y="70" fill="#47b475" font-size="12" font-family="monospace">for m0 in range(0, M, MC):  # pack A panel, call microkernel</text>

                    <text x="500" y="40" fill="#808080" font-size="11"># L3 blocking</text>
                    <text x="500" y="55" fill="#808080" font-size="11"># L2 blocking</text>
                    <text x="500" y="70" fill="#808080" font-size="11"># L1 blocking + parallel</text>
                </g>
            </svg>
        </div>

        <!-- Optimization Timeline -->
        <h2>Our Optimization Journey</h2>

        <div class="timeline">
            <div class="timeline-item done">
                <div class="timeline-title">Step 1: Naive Implementation</div>
                <div class="timeline-desc">Triple nested loop with poor cache behavior. ~8 GFLOPS.</div>
            </div>
            <div class="timeline-item done">
                <div class="timeline-title">Step 2: OpenMP Parallelization</div>
                <div class="timeline-desc">Added parallel for loops. Still cache-unfriendly.</div>
            </div>
            <div class="timeline-item done">
                <div class="timeline-title">Step 3: AVX Vectorization</div>
                <div class="timeline-desc">8-wide SIMD using 256-bit YMM registers. ~15 GFLOPS.</div>
            </div>
            <div class="timeline-item done">
                <div class="timeline-title">Step 4: 8x8 Register Blocking</div>
                <div class="timeline-desc">Keep 64 accumulators in registers across K-loop. ~20 GFLOPS.</div>
            </div>
            <div class="timeline-item done">
                <div class="timeline-title">Step 5: Cache Blocking (MC/NC/KC)</div>
                <div class="timeline-desc">Tile for L1/L2/L3 cache hierarchy. ~25 GFLOPS.</div>
            </div>
            <div class="timeline-item done">
                <div class="timeline-title">Step 6: Matrix Packing</div>
                <div class="timeline-desc">Pack A and B for contiguous access. ~30 GFLOPS.</div>
            </div>
            <div class="timeline-item done">
                <div class="timeline-title">Step 7: Software Prefetching + Loop Unrolling</div>
                <div class="timeline-desc">Prefetch next cache line, unroll K by 4. <strong>52.95 GFLOPS peak!</strong></div>
            </div>
        </div>

        <!-- Performance Comparison -->
        <h2>Performance Results</h2>

        <table class="comparison-table">
            <thead>
                <tr>
                    <th>Matrix Size</th>
                    <th>PyTorch/MKL</th>
                    <th>Our Microkernel</th>
                    <th>Result</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>32 x 32 x 32</td>
                    <td>5.17 GFLOPS</td>
                    <td>10.19 GFLOPS</td>
                    <td class="faster">2.0x FASTER</td>
                </tr>
                <tr>
                    <td>64 x 64 x 64</td>
                    <td>14.03 GFLOPS</td>
                    <td>22.94 GFLOPS</td>
                    <td class="faster">1.6x FASTER</td>
                </tr>
                <tr>
                    <td>128 x 128 x 128</td>
                    <td>19.75 GFLOPS</td>
                    <td>27.75 GFLOPS</td>
                    <td class="faster">1.4x FASTER</td>
                </tr>
                <tr>
                    <td>256 x 256 x 256</td>
                    <td>22.41 GFLOPS</td>
                    <td>32.76 GFLOPS</td>
                    <td class="faster">1.5x FASTER</td>
                </tr>
                <tr>
                    <td>512 x 512 x 512</td>
                    <td>22.50 GFLOPS</td>
                    <td>24.22 GFLOPS</td>
                    <td class="faster">1.1x FASTER</td>
                </tr>
                <tr>
                    <td>1024 x 1024 x 1024</td>
                    <td>23.00 GFLOPS</td>
                    <td>31.48 GFLOPS</td>
                    <td class="faster">1.4x FASTER</td>
                </tr>
            </tbody>
        </table>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: var(--green);"></div>
                <span>Our kernel beats MKL at ALL sizes</span>
            </div>
        </div>

        <!-- Code Example -->
        <h2>Using the Microkernel</h2>

        <pre><code>#include "ckernel_engine.h"

// Basic usage - automatically selects best implementation
float A[M * K], B[K * N], C[M * N];
gemm_microkernel(A, B, C, M, N, K, 0);  // B not transposed

// For neural network weights (B is [N, K] transposed)
gemm_microkernel(A, B, C, M, N, K, 1);  // B transposed

// Direct packed version for large matrices
gemm_microkernel_packed(A, B, C, M, N, K);</code></pre>

        <!-- Key Files -->
        <h2>Source Files</h2>

        <div class="grid-3">
            <div class="card">
                <h3>gemm_microkernel.c</h3>
                <p>Main microkernel implementation with 8x8 register blocking, matrix packing, and cache blocking.</p>
                <code>src/kernels/gemm_microkernel.c</code>
            </div>
            <div class="card">
                <h3>gemm_fused_kernels.c</h3>
                <p>Fused GEMM operations: GEMM+ReLU, GEMM+GELU, GEMM+SiLU, and the dual-GEMM SwiGLU.</p>
                <code>src/kernels/gemm_fused_kernels.c</code>
            </div>
            <div class="card">
                <h3>test_gemm_microkernel.py</h3>
                <p>Unit test with accuracy verification and performance benchmarks vs PyTorch.</p>
                <code>unittest/test_gemm_microkernel.py</code>
            </div>
        </div>

        <!-- References -->
        <h2>References & Further Reading</h2>

        <div class="grid-2">
            <div class="card">
                <h3>BLIS: A Framework for Rapidly Instantiating BLAS Functionality</h3>
                <p>The foundational paper on microkernel-based GEMM design.</p>
                <p><code>Field G. Van Zee, Robert A. van de Geijn</code></p>
            </div>
            <div class="card">
                <h3>Anatomy of High-Performance Matrix Multiplication</h3>
                <p>Classic paper explaining cache blocking and register tiling.</p>
                <p><code>Kazushige Goto, Robert A. van de Geijn</code></p>
            </div>
            <div class="card">
                <h3>oneDNN Developer Guide</h3>
                <p>Intel's deep learning library with state-of-the-art GEMM kernels.</p>
                <p><code>oneapi-src/oneDNN</code></p>
            </div>
            <div class="card">
                <h3>How to Optimize GEMM</h3>
                <p>Practical tutorial on GEMM optimization techniques.</p>
                <p><code>flame.cs.utexas.edu/~flame/web/</code></p>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="site-footer">
        <p>C-Kernel-Engine &copy; 2024 | High-Performance ML Kernels in Pure C</p>
    </footer>
</body>
</html>
