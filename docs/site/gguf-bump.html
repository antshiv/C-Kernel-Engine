<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GGUFtoBump | C-Kernel-Engine</title>
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
    <style>
        :root {
            /* Antsand Brand Colors - Lightened */
            --orange: #ffb400;
            --orange-dark: #e5a200;
            --orange-light: #ffc933;
            --dark: #2a2a2a;
            --dark-lighter: #363636;
            --dark-card: #323232;
            --grey: #454545;
            --grey-light: #555555;
            --text-primary: #f5f5f5;
            --text-secondary: #b0b0b0;
            --text-muted: #808080;
            --bg-dark: #232323;
            --white: #ffffff;
            --code-bg: #1a1a1a;
            --green: #47b475;
            --blue: #07adf8;
            --gradient-header: linear-gradient(135deg, #2a2a2a 0%, #363636 50%, #2a2a2a 100%);
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.5);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--bg-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .site-header {
            background: var(--gradient-header);
            border-bottom: 3px solid var(--orange);
            padding: 0.5rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow-md);
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
        }

        .header-logo {
            width: 40px;
            height: 40px;
            background: var(--orange);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--dark);
            font-size: 1.1rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .header-title {
            color: var(--white);
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header-subtitle {
            color: var(--orange);
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Navigation */
        .site-nav {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .site-nav > a,
        .nav-dropdown > .nav-trigger {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 0.6rem 1rem;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: var(--transition);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            border: none;
            background: transparent;
            font-family: inherit;
        }

        .site-nav > a:hover,
        .nav-dropdown:hover > .nav-trigger {
            color: var(--white);
            background: var(--grey);
        }

        .site-nav > a.active {
            background: var(--orange);
            color: var(--dark);
            font-weight: 600;
        }

        /* Dropdown */
        .nav-dropdown {
            position: relative;
        }

        .nav-trigger::after {
            content: '';
            border: solid currentColor;
            border-width: 0 2px 2px 0;
            display: inline-block;
            padding: 3px;
            transform: rotate(45deg);
            margin-top: -3px;
            transition: transform 0.2s;
        }

        .nav-dropdown:hover .nav-trigger::after {
            transform: rotate(-135deg);
            margin-top: 3px;
        }

        .nav-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--dark-card);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            min-width: 220px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: var(--transition);
            overflow: hidden;
            margin-top: 0.5rem;
            border: 1px solid var(--grey);
        }

        .nav-dropdown:hover .nav-dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .nav-dropdown-menu a {
            display: block;
            padding: 0.75rem 1rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: var(--transition);
            border-left: 3px solid transparent;
        }

        .nav-dropdown-menu a:hover {
            background: var(--grey);
            border-left-color: var(--orange);
            color: var(--white);
        }

        .nav-dropdown-menu a small {
            display: block;
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-top: 0.2rem;
        }

        /* Last dropdown aligns to the right edge */
        .nav-dropdown:last-child .nav-dropdown-menu {
            left: auto;
            right: 0;
        }

        /* Mega menu for Architecture dropdown */
        .nav-dropdown-menu.mega-menu {
            min-width: 580px;
            padding: 1.25rem 1.5rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem 2rem;
            /* Position to the left so it doesn't clip right edge */
            left: 50%;
            transform: translateX(-60%);
        }

        .nav-dropdown:hover .nav-dropdown-menu.mega-menu {
            transform: translateX(-60%) translateY(0);
        }

        .mega-menu .menu-section {
            margin-bottom: 0.75rem;
        }

        .mega-menu .menu-heading {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--orange);
            padding: 0.5rem 0.75rem 0.35rem;
            border-bottom: 1px solid var(--grey);
            margin-bottom: 0.35rem;
        }

        .mega-menu a {
            padding: 0.6rem 0.75rem;
            font-size: 0.9rem;
            border-radius: 4px;
            border-left: none;
            line-height: 1.3;
        }

        .mega-menu a:hover {
            border-left: none;
            background: var(--grey);
        }

        .mega-menu a small {
            font-size: 0.75rem;
            margin-top: 0.15rem;
        }

        /* Main Content */
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            flex: 1;
            width: 100%;
        }

        /* Hero Section */
        .hero {
            background: var(--gradient-header);
            border: 1px solid var(--grey);
            color: var(--white);
            padding: 3rem 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--orange), var(--orange-light), var(--orange));
        }

        .hero h1 {
            color: var(--white);
            border: none;
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .hero p {
            font-size: 1.1rem;
            color: var(--text-secondary);
            max-width: 700px;
            margin: 0 auto;
        }

        /* Typography */
        h1 {
            color: var(--white);
            font-size: 2rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--orange);
            padding-bottom: 0.5rem;
        }

        h2 {
            color: var(--white);
            font-size: 1.4rem;
            margin: 2rem 0 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        h2::before {
            content: '';
            width: 4px;
            height: 1.4rem;
            background: var(--orange);
            border-radius: 2px;
        }

        h3 {
            color: var(--orange);
            font-size: 1.15rem;
            margin: 1.5rem 0 0.75rem;
        }

        p {
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }

        /* Cards */
        .card {
            background: var(--dark-card);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
            border-left: 3px solid var(--grey-light);
            transition: var(--transition);
            border: 1px solid var(--grey);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            border-left-color: var(--orange);
        }

        .card-accent {
            border-left-color: var(--orange);
        }

        .card-green {
            border-left-color: var(--green);
        }

        .card-blue {
            border-left-color: var(--blue);
        }

        .card h3 {
            margin-top: 0;
        }

        /* Clickable Cards */
        a.card-link {
            display: block;
            text-decoration: none;
            color: inherit;
        }

        a.card-link .card {
            cursor: pointer;
        }

        a.card-link .card:hover {
            border-left-width: 5px;
        }

        .card-arrow {
            color: var(--orange);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            transition: var(--transition);
        }

        a.card-link:hover .card-arrow {
            gap: 0.75rem;
        }

        /* Feature Icons */
        .feature-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .feature-icon.orange { background: rgba(255, 180, 0, 0.15); color: var(--orange); }
        .feature-icon.green { background: rgba(71, 180, 117, 0.15); color: var(--green); }
        .feature-icon.blue { background: rgba(7, 173, 248, 0.15); color: var(--blue); }
        .feature-icon.grey { background: rgba(255, 255, 255, 0.1); color: var(--text-secondary); }

        /* Stats */
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--orange);
            line-height: 1;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* Code blocks */
        pre {
            background: var(--code-bg);
            color: #e0e0e0;
            padding: 1.25rem;
            border-radius: 6px;
            overflow-x: auto;
            margin: 1rem 0;
            font-family: 'JetBrains Mono', 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.85rem;
            border: 1px solid var(--grey);
        }

        code {
            font-family: 'JetBrains Mono', 'SF Mono', Monaco, 'Cascadia Code', monospace;
            background: var(--grey);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.85rem;
            color: var(--orange);
        }

        pre code {
            background: none;
            padding: 0;
            color: #e0e0e0;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: var(--dark-card);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--grey);
        }

        th {
            background: var(--dark);
            color: var(--orange);
            padding: 0.875rem 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 0.875rem 1rem;
            border-bottom: 1px solid var(--grey);
            color: var(--text-secondary);
        }

        tr:hover {
            background: var(--grey);
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 1.5rem;
            color: var(--text-secondary);
        }

        li {
            margin-bottom: 0.5rem;
        }

        /* Links */
        a {
            color: var(--orange);
            transition: var(--transition);
        }

        a:hover {
            color: var(--orange-light);
        }

        /* Grid */
        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        /* Alerts */
        .alert {
            padding: 1rem 1.25rem;
            border-radius: 6px;
            margin: 1rem 0;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            border: 1px solid;
        }

        .alert-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .alert-info {
            background: rgba(7, 173, 248, 0.1);
            border-color: var(--blue);
            color: var(--blue);
        }

        .alert-warning {
            background: rgba(255, 180, 0, 0.1);
            border-color: var(--orange);
            color: var(--orange);
        }

        .alert-success {
            background: rgba(71, 180, 117, 0.1);
            border-color: var(--green);
            color: var(--green);
        }

        /* Image containers */
        .img-container {
            margin: 1.5rem 0;
            text-align: center;
        }

        .img-container img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--grey);
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-orange {
            background: var(--orange);
            color: var(--dark);
        }

        .badge-green {
            background: var(--green);
            color: white;
        }

        .badge-grey {
            background: var(--grey);
            color: var(--text-secondary);
        }

        /* Accordion */
        details {
            background: var(--dark-card);
            border-radius: 6px;
            margin-bottom: 0.75rem;
            border: 1px solid var(--grey);
            border-left: 3px solid var(--grey-light);
            overflow: hidden;
            transition: var(--transition);
        }

        details:hover {
            border-left-color: var(--orange);
        }

        details[open] {
            border-left-color: var(--orange);
        }

        summary {
            padding: 1rem 1.25rem;
            cursor: pointer;
            font-weight: 600;
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: space-between;
            list-style: none;
            user-select: none;
            transition: var(--transition);
        }

        summary::-webkit-details-marker {
            display: none;
        }

        summary::after {
            content: '';
            border: solid var(--orange);
            border-width: 0 2px 2px 0;
            display: inline-block;
            padding: 4px;
            transform: rotate(-45deg);
            transition: transform 0.2s ease;
            flex-shrink: 0;
            margin-left: 1rem;
        }

        details[open] summary::after {
            transform: rotate(45deg);
        }

        summary:hover {
            background: var(--grey);
        }

        details[open] summary {
            border-bottom: 1px solid var(--grey);
        }

        .accordion-content {
            padding: 1rem 1.25rem;
        }

        /* Mobile hamburger button */
        .nav-toggle {
            display: none;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            flex-direction: column;
            gap: 5px;
        }

        .nav-toggle span {
            display: block;
            width: 24px;
            height: 3px;
            background: var(--orange);
            border-radius: 2px;
            transition: var(--transition);
        }

        .nav-toggle.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .nav-toggle.active span:nth-child(2) {
            opacity: 0;
        }

        .nav-toggle.active span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .site-header {
                flex-direction: row;
                justify-content: space-between;
                padding: 0.75rem 1rem;
            }

            .nav-toggle {
                display: flex;
            }

            .site-nav {
                position: fixed;
                top: 60px;
                left: 0;
                right: 0;
                bottom: 0;
                background: var(--dark);
                flex-direction: column;
                padding: 1rem;
                gap: 0.5rem;
                overflow-y: auto;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 999;
            }

            .site-nav.open {
                transform: translateX(0);
            }

            .site-nav > a,
            .nav-dropdown > .nav-trigger {
                width: 100%;
                padding: 1rem;
                font-size: 1rem;
            }

            .nav-dropdown {
                width: 100%;
            }

            .nav-dropdown-menu {
                position: static;
                opacity: 1;
                visibility: hidden;
                max-height: 0;
                overflow: hidden;
                transform: none;
                margin-top: 0;
                transition: max-height 0.3s ease, visibility 0.3s ease;
                background: var(--dark-lighter);
                border-radius: 0;
                border: none;
                box-shadow: none;
            }

            .nav-dropdown.open .nav-dropdown-menu {
                visibility: visible;
                max-height: 500px;
            }

            .nav-dropdown-menu a {
                padding: 0.75rem 1.5rem;
            }

            /* Disable hover on mobile */
            .nav-dropdown:hover .nav-dropdown-menu {
                opacity: 1;
                visibility: hidden;
                max-height: 0;
            }

            .nav-dropdown.open .nav-dropdown-menu,
            .nav-dropdown.open:hover .nav-dropdown-menu {
                visibility: visible;
                max-height: 500px;
            }

            main {
                padding: 1rem;
            }

            h1 {
                font-size: 1.75rem;
            }

            .hero {
                padding: 2rem 1rem;
            }

            .hero h1 {
                font-size: 1.75rem;
            }
        }
    </style>
</head>
<body>
    <header class="site-header">
        <a href="index.html" class="header-brand">
            <div class="header-logo">CK</div>
            <div>
                <div class="header-title">C-Kernel-Engine</div>
                <div class="header-subtitle">High-Performance ML Kernels</div>
            </div>
        </a>
        <button class="nav-toggle" aria-label="Toggle navigation" aria-expanded="false">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <nav class="site-nav">
            <a href="index.html" class="">Home</a>
            <a href="quickstart.html" class="">Getting Started</a>
            <a href="developer-guide.html" class="">Developer Guide</a>
            <a href="scaling.html" class="">Scaling</a>
            <div class="nav-dropdown">
                <span class="nav-trigger">Architecture</span>
                <div class="nav-dropdown-menu mega-menu">
                    <!-- Left Column -->
                    <div class="menu-section">
                        <div class="menu-heading">Core</div>
                        <a href="architecture.html">System Overview<small>IR, Codegen, Kernels</small></a>
                        <a href="kernels.html">Kernel Reference<small>Forward/backward ops</small></a>
                        <a href="codegen.html">Code Generation<small>IR to C compilation</small></a>
                        <a href="ir-v2.html">IR v2 Format<small>Portable model representation</small></a>
                        <a href="concepts.html">Deep Dive Concepts<small>RoPE, Flash Attention, GQA</small></a>
                    </div>
                    <div class="menu-section">
                        <div class="menu-heading">Quantization</div>
                        <a href="quantization.html">Quant Fundamentals<small>Block formats, grouping</small></a>
                        <a href="gguf-bump.html">GGUF to Bump<small>Weight conversion</small></a>
                        <a href="gguf-conversion.html">GGUF Parsing<small>Byte-level guide</small></a>
                    </div>
                    <!-- Right Column -->
                    <div class="menu-section">
                        <div class="menu-heading">Optimization</div>
                        <a href="gemm-optimization.html">GEMM Optimization<small>AVX, MKL, blocking</small></a>
                        <a href="simd-architecture.html">SIMD Architecture<small>AVX-512, VNNI, AMX</small></a>
                    </div>
                    <div class="menu-section">
                        <div class="menu-heading">Infrastructure</div>
                        <a href="memory-safety.html">Memory Safety<small>Bump allocator, canaries</small></a>
                        <a href="deterministic-memory.html">Deterministic Memory<small>RDMA, interpretability</small></a>
                        <a href="profiling.html">Profiling Guide<small>Valgrind, perf, flamegraphs</small></a>
                        <a href="testing.html">Testing<small>Numerical parity verification</small></a>
                    </div>
                </div>
            </div>
            <a href="pytorch-parity.html" class="">PyTorch Parity</a>
            <a href="test-report.html" class="">Test Report</a>
            <a href="research.html" class="">Research</a>
            <a href="decisions.html" class="">ADR</a>
            <div class="nav-dropdown">
                <span class="nav-trigger">API & Docs</span>
                <div class="nav-dropdown-menu">
                    <a href="api.html">
                        API Reference
                        <small>Function signatures & usage</small>
                    </a>
                    <a href="doxygen/index.html">
                        Doxygen Docs
                        <small>Full source documentation</small>
                    </a>
                    <a href="doxygen/files.html">
                        Source Files
                        <small>Browse kernel source code</small>
                    </a>
                </div>
            </div>
        </nav>
    </header>
    <main>

<h1>GGUF to Bump Allocator</h1>

<p>This document explains how C-Kernel-Engine handles quantized weights from GGUF files (llama.cpp format) and converts them to our bump allocator layout for efficient inference and training.</p>

<div class="alert alert-info">
    <span class="alert-icon">&#128214;</span>
    <div>
        <strong>Prerequisites:</strong> For quantization fundamentals (why quantize, block formats, grouping), see <a href="quantization.html">Quantization Deep Dive</a>. For step-by-step byte-level GGUF parsing, see <a href="gguf-conversion.html">GGUF Conversion Guide</a>.
    </div>
</div>

<div class="alert alert-info">
    <span class="alert-icon">&#128161;</span>
    <div>
        <strong>Key Insight:</strong> We don't dequantize weights at load time. We keep them quantized in memory and dequantize on-the-fly during GEMM operations. This saves 4x memory for Q4_K models.
    </div>
</div>

<h2>Why Quantization Matters</h2>

<div class="grid grid-3">
    <div class="card card-accent">
        <div class="stat-number">4x</div>
        <div class="stat-label">Memory Reduction</div>
        <p>Q4_K uses ~4.5 bits/weight vs 32 bits for FP32</p>
    </div>
    <div class="card card-green">
        <div class="stat-number">2x</div>
        <div class="stat-label">Bandwidth Savings</div>
        <p>Less data to move from DRAM = faster inference</p>
    </div>
    <div class="card card-blue">
        <div class="stat-number">&lt;1%</div>
        <div class="stat-label">Quality Loss</div>
        <p>Q4_K_M preserves model quality remarkably well</p>
    </div>
</div>

<h2>GGUF File Format Overview</h2>

<p>GGUF (GGML Universal Format) is llama.cpp's binary format for storing quantized models. Understanding it is essential for our conversion pipeline.</p>

<div class="img-container">
    <svg viewBox="0 0 800 400" style="max-width: 100%; background: #1a1a1a; border-radius: 8px;">
        <!-- Title -->
        <text x="400" y="30" text-anchor="middle" fill="#ffb400" font-size="18" font-weight="bold">GGUF File Structure</text>

        <!-- Magic Header -->
        <rect x="50" y="60" width="700" height="50" fill="#2a2a2a" stroke="#ffb400" stroke-width="2" rx="4"/>
        <text x="70" y="90" fill="#fff" font-size="14" font-family="monospace">Magic: "GGUF" (4 bytes)</text>
        <text x="250" y="90" fill="#b0b0b0" font-size="14" font-family="monospace">Version: u32</text>
        <text x="400" y="90" fill="#b0b0b0" font-size="14" font-family="monospace">n_tensors: u64</text>
        <text x="580" y="90" fill="#b0b0b0" font-size="14" font-family="monospace">n_kv: u64</text>

        <!-- Metadata Section -->
        <rect x="50" y="120" width="700" height="80" fill="#323232" stroke="#47b475" stroke-width="2" rx="4"/>
        <text x="70" y="145" fill="#47b475" font-size="14" font-weight="bold">Metadata (Key-Value Pairs)</text>
        <text x="70" y="170" fill="#b0b0b0" font-size="12" font-family="monospace">llama.block_count: 32</text>
        <text x="250" y="170" fill="#b0b0b0" font-size="12" font-family="monospace">llama.embedding_length: 4096</text>
        <text x="500" y="170" fill="#b0b0b0" font-size="12" font-family="monospace">llama.attention.head_count: 32</text>
        <text x="70" y="190" fill="#b0b0b0" font-size="12" font-family="monospace">llama.rope.freq_base: 10000.0</text>
        <text x="300" y="190" fill="#b0b0b0" font-size="12" font-family="monospace">llama.norm_rms_eps: 1e-5</text>

        <!-- Tensor Info Section -->
        <rect x="50" y="210" width="700" height="80" fill="#323232" stroke="#07adf8" stroke-width="2" rx="4"/>
        <text x="70" y="235" fill="#07adf8" font-size="14" font-weight="bold">Tensor Info (Headers Only - No Data)</text>
        <text x="70" y="260" fill="#b0b0b0" font-size="12" font-family="monospace">name: "blk.0.attn_q.weight"  dims: [4096, 4096]  type: Q4_K  offset: 0x1000</text>
        <text x="70" y="280" fill="#b0b0b0" font-size="12" font-family="monospace">name: "blk.0.attn_k.weight"  dims: [4096, 1024]  type: Q4_K  offset: 0x801000</text>

        <!-- Alignment Padding -->
        <rect x="50" y="300" width="700" height="30" fill="#454545" stroke="#808080" stroke-width="1" rx="4"/>
        <text x="400" y="320" text-anchor="middle" fill="#808080" font-size="12">Alignment Padding (to 32-byte boundary)</text>

        <!-- Tensor Data Section -->
        <rect x="50" y="340" width="700" height="50" fill="#2a2a2a" stroke="#ffb400" stroke-width="2" rx="4"/>
        <text x="70" y="365" fill="#ffb400" font-size="14" font-weight="bold">Tensor Data (Quantized Blocks)</text>
        <text x="350" y="365" fill="#b0b0b0" font-size="12" font-family="monospace">block_q4_K[...] for each tensor</text>
    </svg>
</div>

<h2>Q4_K Block Structure</h2>

<p>Q4_K is a "K-quant" format with nested scales. Each super-block contains 256 weights organized into 8 sub-blocks of 32 weights each. This two-level scaling provides better accuracy than simple 4-bit quantization.</p>

<div class="img-container">
    <svg viewBox="0 0 800 500" style="max-width: 100%; background: #1a1a1a; border-radius: 8px;">
        <!-- Title -->
        <text x="400" y="30" text-anchor="middle" fill="#ffb400" font-size="18" font-weight="bold">Q4_K Super-Block: 144 bytes = 256 weights</text>

        <!-- Super-block header -->
        <rect x="50" y="60" width="80" height="60" fill="#ffb400" stroke="#fff" stroke-width="2" rx="4"/>
        <text x="90" y="85" text-anchor="middle" fill="#2a2a2a" font-size="12" font-weight="bold">d</text>
        <text x="90" y="105" text-anchor="middle" fill="#2a2a2a" font-size="10">FP16</text>
        <text x="90" y="115" text-anchor="middle" fill="#2a2a2a" font-size="10">2 bytes</text>

        <rect x="140" y="60" width="80" height="60" fill="#47b475" stroke="#fff" stroke-width="2" rx="4"/>
        <text x="180" y="85" text-anchor="middle" fill="#fff" font-size="12" font-weight="bold">dmin</text>
        <text x="180" y="105" text-anchor="middle" fill="#fff" font-size="10">FP16</text>
        <text x="180" y="115" text-anchor="middle" fill="#fff" font-size="10">2 bytes</text>

        <rect x="230" y="60" width="160" height="60" fill="#07adf8" stroke="#fff" stroke-width="2" rx="4"/>
        <text x="310" y="85" text-anchor="middle" fill="#fff" font-size="12" font-weight="bold">scales[12]</text>
        <text x="310" y="105" text-anchor="middle" fill="#fff" font-size="10">8 scales + 8 mins</text>
        <text x="310" y="115" text-anchor="middle" fill="#fff" font-size="10">6-bit packed</text>

        <!-- Quantized weights -->
        <rect x="400" y="60" width="350" height="60" fill="#323232" stroke="#ffb400" stroke-width="2" rx="4"/>
        <text x="575" y="85" text-anchor="middle" fill="#ffb400" font-size="12" font-weight="bold">qs[128]</text>
        <text x="575" y="105" text-anchor="middle" fill="#b0b0b0" font-size="10">256 x 4-bit weights</text>
        <text x="575" y="115" text-anchor="middle" fill="#b0b0b0" font-size="10">2 per byte = 128 bytes</text>

        <!-- Arrow showing structure -->
        <line x1="400" y1="140" x2="400" y2="170" stroke="#ffb400" stroke-width="2" marker-end="url(#arrowhead)"/>

        <!-- Sub-blocks -->
        <text x="400" y="190" text-anchor="middle" fill="#fff" font-size="14" font-weight="bold">8 Sub-blocks (32 weights each)</text>

        <!-- Sub-block detail -->
        <g transform="translate(50, 210)">
            <rect x="0" y="0" width="85" height="50" fill="#454545" stroke="#ffb400" stroke-width="1" rx="4"/>
            <text x="42" y="20" text-anchor="middle" fill="#ffb400" font-size="11" font-weight="bold">Sub 0</text>
            <text x="42" y="38" text-anchor="middle" fill="#b0b0b0" font-size="9">16 bytes</text>
        </g>
        <g transform="translate(140, 210)">
            <rect x="0" y="0" width="85" height="50" fill="#454545" stroke="#47b475" stroke-width="1" rx="4"/>
            <text x="42" y="20" text-anchor="middle" fill="#47b475" font-size="11" font-weight="bold">Sub 1</text>
            <text x="42" y="38" text-anchor="middle" fill="#b0b0b0" font-size="9">16 bytes</text>
        </g>
        <g transform="translate(230, 210)">
            <rect x="0" y="0" width="85" height="50" fill="#454545" stroke="#07adf8" stroke-width="1" rx="4"/>
            <text x="42" y="20" text-anchor="middle" fill="#07adf8" font-size="11" font-weight="bold">Sub 2</text>
            <text x="42" y="38" text-anchor="middle" fill="#b0b0b0" font-size="9">16 bytes</text>
        </g>
        <text x="350" y="240" fill="#808080" font-size="20">...</text>
        <g transform="translate(400, 210)">
            <rect x="0" y="0" width="85" height="50" fill="#454545" stroke="#ffb400" stroke-width="1" rx="4"/>
            <text x="42" y="20" text-anchor="middle" fill="#ffb400" font-size="11" font-weight="bold">Sub 7</text>
            <text x="42" y="38" text-anchor="middle" fill="#b0b0b0" font-size="9">16 bytes</text>
        </g>

        <!-- Dequantization formula -->
        <rect x="50" y="290" width="700" height="90" fill="#1a1a1a" stroke="#ffb400" stroke-width="2" rx="4"/>
        <text x="70" y="315" fill="#ffb400" font-size="14" font-weight="bold">Dequantization Formula:</text>
        <text x="70" y="345" fill="#fff" font-size="16" font-family="monospace">w_fp32 = (q - 8) * d * sc[sub] + dmin * m[sub]</text>
        <text x="70" y="370" fill="#b0b0b0" font-size="12">Where: q = 4-bit value (0-15), sc = sub-block scale, m = sub-block min</text>

        <!-- Byte breakdown -->
        <text x="400" y="410" text-anchor="middle" fill="#fff" font-size="14" font-weight="bold">Total: 2 + 2 + 12 + 128 = 144 bytes for 256 weights = 4.5 bits/weight</text>

        <!-- Memory comparison -->
        <g transform="translate(100, 430)">
            <rect x="0" y="0" width="150" height="40" fill="#47b475" rx="4"/>
            <text x="75" y="25" text-anchor="middle" fill="#fff" font-size="12" font-weight="bold">Q4_K: 144 bytes</text>
        </g>
        <text x="280" y="455" fill="#fff" font-size="14">vs</text>
        <g transform="translate(320, 430)">
            <rect x="0" y="0" width="200" height="40" fill="#e74c3c" rx="4"/>
            <text x="100" y="25" text-anchor="middle" fill="#fff" font-size="12" font-weight="bold">FP32: 1024 bytes (7x more)</text>
        </g>

        <!-- Arrow marker definition -->
        <defs>
            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                <polygon points="0 0, 10 3.5, 0 7" fill="#ffb400"/>
            </marker>
        </defs>
    </svg>
</div>

<h2>Scale Unpacking (The Tricky Part)</h2>

<p>The 12-byte <code>scales</code> array packs 8 scales and 8 mins in 6-bit format. Unpacking requires careful bit manipulation:</p>

<div class="card">
    <h3>6-bit Packed Layout</h3>
    <pre><code>// scales[12] = 96 bits = 16 x 6-bit values
// First 8 values: scales (sc[0..7])
// Last 8 values: mins (m[0..7])

// Unpacking sc[0..7] from bytes 0-5:
sc[0] = scales[0] & 0x3F;                              // bits 0-5 of byte 0
sc[1] = (scales[0] >> 6) | ((scales[1] & 0x0F) << 2);  // bits 6-7 of byte 0, bits 0-3 of byte 1
sc[2] = (scales[1] >> 4) | ((scales[2] & 0x03) << 4);  // bits 4-7 of byte 1, bits 0-1 of byte 2
sc[3] = scales[2] >> 2;                                // bits 2-7 of byte 2
// ... pattern repeats for sc[4..7] using bytes 3-5

// Unpacking m[0..7] from bytes 6-11:
// Same pattern as scales</code></pre>
</div>

<h2>GGUF to Bump Conversion Pipeline</h2>

<div class="img-container">
    <svg viewBox="0 0 800 550" style="max-width: 100%; background: #1a1a1a; border-radius: 8px;">
        <!-- Title -->
        <text x="400" y="30" text-anchor="middle" fill="#ffb400" font-size="18" font-weight="bold">GGUF to Bump Allocator Conversion</text>

        <!-- Step 1: Parse GGUF -->
        <rect x="50" y="60" width="200" height="80" fill="#323232" stroke="#ffb400" stroke-width="2" rx="8"/>
        <text x="150" y="85" text-anchor="middle" fill="#ffb400" font-size="14" font-weight="bold">1. Parse GGUF</text>
        <text x="150" y="105" text-anchor="middle" fill="#b0b0b0" font-size="11">Read magic, version</text>
        <text x="150" y="120" text-anchor="middle" fill="#b0b0b0" font-size="11">Extract metadata</text>
        <text x="150" y="135" text-anchor="middle" fill="#b0b0b0" font-size="11">Build tensor index</text>

        <!-- Arrow -->
        <line x1="250" y1="100" x2="300" y2="100" stroke="#ffb400" stroke-width="2" marker-end="url(#arrowhead)"/>

        <!-- Step 2: Validate -->
        <rect x="300" y="60" width="200" height="80" fill="#323232" stroke="#47b475" stroke-width="2" rx="8"/>
        <text x="400" y="85" text-anchor="middle" fill="#47b475" font-size="14" font-weight="bold">2. Validate Shapes</text>
        <text x="400" y="105" text-anchor="middle" fill="#b0b0b0" font-size="11">Check tensor dims</text>
        <text x="400" y="120" text-anchor="middle" fill="#b0b0b0" font-size="11">Verify Q4_K alignment</text>
        <text x="400" y="135" text-anchor="middle" fill="#b0b0b0" font-size="11">(ne0 % 256 == 0)</text>

        <!-- Arrow -->
        <line x1="500" y1="100" x2="550" y2="100" stroke="#ffb400" stroke-width="2" marker-end="url(#arrowhead)"/>

        <!-- Step 3: Build dtype table -->
        <rect x="550" y="60" width="200" height="80" fill="#323232" stroke="#07adf8" stroke-width="2" rx="8"/>
        <text x="650" y="85" text-anchor="middle" fill="#07adf8" font-size="14" font-weight="bold">3. Build Dtype Table</text>
        <text x="650" y="105" text-anchor="middle" fill="#b0b0b0" font-size="11">Per-tensor type codes</text>
        <text x="650" y="120" text-anchor="middle" fill="#b0b0b0" font-size="11">Q4_K=6, Q6_K=7, FP32=0</text>
        <text x="650" y="135" text-anchor="middle" fill="#b0b0b0" font-size="11">Enables mixed precision</text>

        <!-- Arrow down -->
        <line x1="650" y1="140" x2="650" y2="180" stroke="#ffb400" stroke-width="2" marker-end="url(#arrowhead)"/>

        <!-- Step 4: Write bump header -->
        <rect x="450" y="190" width="300" height="100" fill="#2a2a2a" stroke="#ffb400" stroke-width="3" rx="8"/>
        <text x="600" y="215" text-anchor="middle" fill="#ffb400" font-size="14" font-weight="bold">4. Write Bump Header (128 bytes)</text>
        <text x="480" y="240" fill="#b0b0b0" font-size="10" font-family="monospace">"BUMPWGT3" version=3</text>
        <text x="480" y="255" fill="#b0b0b0" font-size="10" font-family="monospace">num_layers, vocab_size, embed_dim</text>
        <text x="480" y="270" fill="#b0b0b0" font-size="10" font-family="monospace">context_len, num_heads, head_dim</text>
        <text x="480" y="285" fill="#b0b0b0" font-size="10" font-family="monospace">SHA-256 checksum (32 bytes)</text>

        <!-- Arrow down -->
        <line x1="600" y1="290" x2="600" y2="330" stroke="#ffb400" stroke-width="2" marker-end="url(#arrowhead)"/>

        <!-- Step 5: Copy tensor data -->
        <rect x="50" y="340" width="700" height="120" fill="#323232" stroke="#47b475" stroke-width="2" rx="8"/>
        <text x="400" y="365" text-anchor="middle" fill="#47b475" font-size="14" font-weight="bold">5. Stream Tensor Data (No Dequantization!)</text>

        <!-- Data flow boxes -->
        <rect x="80" y="385" width="120" height="55" fill="#454545" rx="4"/>
        <text x="140" y="405" text-anchor="middle" fill="#ffb400" font-size="11" font-weight="bold">token_embd</text>
        <text x="140" y="425" text-anchor="middle" fill="#b0b0b0" font-size="9">Q4_K blocks</text>

        <rect x="220" y="385" width="120" height="55" fill="#454545" rx="4"/>
        <text x="280" y="405" text-anchor="middle" fill="#07adf8" font-size="11" font-weight="bold">Layer 0</text>
        <text x="280" y="425" text-anchor="middle" fill="#b0b0b0" font-size="9">Q/K/V/O + MLP</text>

        <text x="370" y="415" fill="#808080" font-size="20">...</text>

        <rect x="410" y="385" width="120" height="55" fill="#454545" rx="4"/>
        <text x="470" y="405" text-anchor="middle" fill="#07adf8" font-size="11" font-weight="bold">Layer N-1</text>
        <text x="470" y="425" text-anchor="middle" fill="#b0b0b0" font-size="9">Q/K/V/O + MLP</text>

        <rect x="550" y="385" width="120" height="55" fill="#454545" rx="4"/>
        <text x="610" y="405" text-anchor="middle" fill="#47b475" font-size="11" font-weight="bold">output_norm</text>
        <text x="610" y="425" text-anchor="middle" fill="#b0b0b0" font-size="9">FP32 gamma</text>

        <!-- Output -->
        <rect x="250" y="480" width="300" height="50" fill="#ffb400" stroke="#fff" stroke-width="2" rx="8"/>
        <text x="400" y="510" text-anchor="middle" fill="#2a2a2a" font-size="14" font-weight="bold">weights.bump (ready for inference)</text>
    </svg>
</div>

<h2>Bump File Header Format</h2>

<p>The bump allocator uses a 128-byte header that contains all model configuration needed at runtime:</p>

<div class="card">
<pre><code>// Bump Header Structure (128 bytes total)
// ========================================

Offset  Size    Field                   Description
------  ----    -----                   -----------
0x00    8       magic                   "BUMPWGT3" (8 chars)
0x08    4       version                 3 (current version)
0x0C    4       model_type              1 = decoder-only LLM
0x10    4       num_layers              Number of transformer layers
0x14    4       vocab_size              Vocabulary size
0x18    4       embed_dim               Hidden dimension (hidden_size)
0x1C    4       context_len             Max sequence length
0x20    4       num_heads               Number of attention heads
0x24    4       head_dim                Per-head dimension (embed_dim / num_heads)
0x28    8       aligned_embed_dim       64-byte aligned embed dim
0x30    8       aligned_head_dim        64-byte aligned head dim
0x38    8       aligned_context         64-byte aligned context length
0x40    32      checksum                SHA-256 of payload (after header)
0x60    32      reserved                Future use (zeros)</code></pre>
</div>

<h3>Why Aligned Dimensions?</h3>

<div class="grid grid-2">
    <div class="card">
        <h3>Cache Line Alignment</h3>
        <p>Modern CPUs fetch data in 64-byte cache lines. Misaligned access causes:</p>
        <ul>
            <li>Two cache line fetches instead of one</li>
            <li>Cache line splitting penalties</li>
            <li>Reduced SIMD throughput</li>
        </ul>
    </div>
    <div class="card">
        <h3>AVX-512 Requirements</h3>
        <p>AVX-512 processes 16 floats (64 bytes) per instruction:</p>
        <ul>
            <li>Aligned loads: <code>_mm512_load_ps</code> (fast)</li>
            <li>Unaligned loads: <code>_mm512_loadu_ps</code> (slower)</li>
            <li>Padding zeros don't affect results</li>
        </ul>
    </div>
</div>

<h2>Per-Layer Weight Layout</h2>

<p>Each transformer layer's weights are stored contiguously in the bump file:</p>

<div class="img-container">
    <svg viewBox="0 0 800 400" style="max-width: 100%; background: #1a1a1a; border-radius: 8px;">
        <!-- Title -->
        <text x="400" y="30" text-anchor="middle" fill="#ffb400" font-size="16" font-weight="bold">Per-Layer Weight Layout in Bump File</text>

        <!-- Layer container -->
        <rect x="30" y="50" width="740" height="330" fill="#2a2a2a" stroke="#ffb400" stroke-width="2" rx="8"/>
        <text x="50" y="75" fill="#ffb400" font-size="14" font-weight="bold">Layer N</text>

        <!-- Normalization -->
        <rect x="50" y="90" width="150" height="50" fill="#47b475" rx="4"/>
        <text x="125" y="115" text-anchor="middle" fill="#fff" font-size="11" font-weight="bold">ln1_gamma</text>
        <text x="125" y="130" text-anchor="middle" fill="#fff" font-size="9">FP32 [embed_dim]</text>

        <rect x="210" y="90" width="150" height="50" fill="#47b475" rx="4"/>
        <text x="285" y="115" text-anchor="middle" fill="#fff" font-size="11" font-weight="bold">ln2_gamma</text>
        <text x="285" y="130" text-anchor="middle" fill="#fff" font-size="9">FP32 [embed_dim]</text>

        <!-- Attention weights -->
        <text x="50" y="165" fill="#07adf8" font-size="12" font-weight="bold">Attention Projections (Q4_K):</text>

        <rect x="50" y="175" width="100" height="45" fill="#07adf8" rx="4"/>
        <text x="100" y="195" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">Wq</text>
        <text x="100" y="210" text-anchor="middle" fill="#fff" font-size="8">[E x E]</text>

        <rect x="160" y="175" width="60" height="45" fill="#454545" rx="4"/>
        <text x="190" y="200" text-anchor="middle" fill="#b0b0b0" font-size="9">bq=0</text>

        <rect x="230" y="175" width="100" height="45" fill="#07adf8" rx="4"/>
        <text x="280" y="195" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">Wk</text>
        <text x="280" y="210" text-anchor="middle" fill="#fff" font-size="8">[E x kv]</text>

        <rect x="340" y="175" width="60" height="45" fill="#454545" rx="4"/>
        <text x="370" y="200" text-anchor="middle" fill="#b0b0b0" font-size="9">bk=0</text>

        <rect x="410" y="175" width="100" height="45" fill="#07adf8" rx="4"/>
        <text x="460" y="195" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">Wv</text>
        <text x="460" y="210" text-anchor="middle" fill="#fff" font-size="8">[E x kv]</text>

        <rect x="520" y="175" width="60" height="45" fill="#454545" rx="4"/>
        <text x="550" y="200" text-anchor="middle" fill="#b0b0b0" font-size="9">bv=0</text>

        <rect x="590" y="175" width="100" height="45" fill="#07adf8" rx="4"/>
        <text x="640" y="195" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">Wo</text>
        <text x="640" y="210" text-anchor="middle" fill="#fff" font-size="8">[E x E]</text>

        <rect x="700" y="175" width="60" height="45" fill="#454545" rx="4"/>
        <text x="730" y="200" text-anchor="middle" fill="#b0b0b0" font-size="9">bo=0</text>

        <!-- MLP weights -->
        <text x="50" y="250" fill="#ffb400" font-size="12" font-weight="bold">MLP Projections (Q4_K):</text>

        <rect x="50" y="260" width="150" height="45" fill="#ffb400" rx="4"/>
        <text x="125" y="280" text-anchor="middle" fill="#2a2a2a" font-size="10" font-weight="bold">W_gate</text>
        <text x="125" y="295" text-anchor="middle" fill="#2a2a2a" font-size="8">[E x intermediate]</text>

        <rect x="210" y="260" width="150" height="45" fill="#ffb400" rx="4"/>
        <text x="285" y="280" text-anchor="middle" fill="#2a2a2a" font-size="10" font-weight="bold">W_up</text>
        <text x="285" y="295" text-anchor="middle" fill="#2a2a2a" font-size="8">[E x intermediate]</text>

        <rect x="370" y="260" width="80" height="45" fill="#454545" rx="4"/>
        <text x="410" y="285" text-anchor="middle" fill="#b0b0b0" font-size="9">b1=0</text>

        <rect x="460" y="260" width="150" height="45" fill="#ffb400" rx="4"/>
        <text x="535" y="280" text-anchor="middle" fill="#2a2a2a" font-size="10" font-weight="bold">W_down</text>
        <text x="535" y="295" text-anchor="middle" fill="#2a2a2a" font-size="8">[intermediate x E]</text>

        <rect x="620" y="260" width="80" height="45" fill="#454545" rx="4"/>
        <text x="660" y="285" text-anchor="middle" fill="#b0b0b0" font-size="9">b2=0</text>

        <!-- Legend -->
        <rect x="50" y="320" width="15" height="15" fill="#07adf8"/>
        <text x="75" y="332" fill="#b0b0b0" font-size="10">Q4_K quantized</text>

        <rect x="200" y="320" width="15" height="15" fill="#47b475"/>
        <text x="225" y="332" fill="#b0b0b0" font-size="10">FP32 (norms)</text>

        <rect x="350" y="320" width="15" height="15" fill="#454545"/>
        <text x="375" y="332" fill="#b0b0b0" font-size="10">Zero bias placeholders</text>

        <text x="550" y="332" fill="#808080" font-size="10">E = embed_dim, kv = num_kv_heads * head_dim</text>
    </svg>
</div>

<h2>Dequantization Kernels</h2>

<p>At inference time, we dequantize weights on-the-fly during GEMM operations. This trades compute for memory bandwidth - a good trade on modern CPUs where memory is the bottleneck.</p>

<div class="card">
    <h3>Q4_K Dequantization (Scalar Reference)</h3>
<pre><code>void dequant_q4_k_block(const block_q4_K *block, float *output) {
    const float d = fp16_to_fp32(block->d);
    const float dmin = fp16_to_fp32(block->dmin);

    // Unpack 6-bit scales and mins
    uint8_t sc[8], m[8];
    unpack_q4_k_scales(block->scales, sc, m);

    // Process 8 sub-blocks of 32 weights each
    for (int sub = 0; sub < 8; sub++) {
        const float scale = d * (float)sc[sub];
        const float min_val = dmin * (float)m[sub];

        const uint8_t *qs = &block->qs[sub * 16];
        float *out = &output[sub * 32];

        for (int i = 0; i < 16; i++) {
            const uint8_t packed = qs[i];
            const int8_t q0 = (packed & 0x0F) - 8;  // Lower nibble
            const int8_t q1 = (packed >> 4) - 8;    // Upper nibble

            out[2*i + 0] = scale * (float)q0 + min_val;
            out[2*i + 1] = scale * (float)q1 + min_val;
        }
    }
}</code></pre>
</div>

<h3>AVX-512 Optimized Dequantization</h3>

<div class="card">
<pre><code>static inline void dequant_q4_k_subblock_avx512(
    const uint8_t *qs,      // 16 bytes = 32 x 4-bit weights
    float scale,            // d * sc[sub]
    float min_val,          // dmin * m[sub]
    __m512 *out0,           // Output: weights 0-15
    __m512 *out1)           // Output: weights 16-31
{
    const __m512 vscale = _mm512_set1_ps(scale);
    const __m512 vmin = _mm512_set1_ps(min_val);
    const __m512i offset = _mm512_set1_epi32(8);
    const __m512i mask_lo = _mm512_set1_epi32(0x0F);

    // Load 16 bytes, expand to 32-bit integers
    __m128i packed = _mm_loadu_si128((const __m128i *)qs);
    __m512i bytes = _mm512_cvtepu8_epi32(packed);

    // Extract lower nibbles: (byte & 0x0F) - 8
    __m512i lo = _mm512_and_epi32(bytes, mask_lo);
    lo = _mm512_sub_epi32(lo, offset);

    // Extract upper nibbles: (byte >> 4) - 8
    __m512i hi = _mm512_srli_epi32(bytes, 4);
    hi = _mm512_sub_epi32(hi, offset);

    // Convert to float, scale, add min: FMA!
    *out0 = _mm512_fmadd_ps(_mm512_cvtepi32_ps(lo), vscale, vmin);
    *out1 = _mm512_fmadd_ps(_mm512_cvtepi32_ps(hi), vscale, vmin);
}</code></pre>
</div>

<h2>Make Commands</h2>

<p>Use these commands to work with GGUF files:</p>

<table>
    <thead>
        <tr>
            <th>Command</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>make test-quant</code></td>
            <td>Run quantization kernel tests (dequant + q4/q8 gemm)</td>
        </tr>
        <tr>
            <td><code>make gguf-inspect GGUF=path</code></td>
            <td>Inspect GGUF tensor dtypes (what is quantized?)</td>
        </tr>
        <tr>
            <td><code>make gguf-list GGUF=path</code></td>
            <td>List all GGUF tensors (name/type/shape)</td>
        </tr>
        <tr>
            <td><code>make gguf-to-bump GGUF=path</code></td>
            <td>Convert GGUF to bump weights (outputs to GGUF_OUT/)</td>
        </tr>
    </tbody>
</table>

<h3>Example Usage</h3>

<div class="card">
<pre><code># Inspect a GGUF file to see what's quantized
make gguf-inspect GGUF=models/qwen2.5-3b-instruct-q4_k_m.gguf

# Output:
# [gguf] version=3 arch=llama tensors=291 kv=26 alignment=32
# [gguf] tensor types:
#   -      Q4_K:   225 tensors, bytes=1.71 GiB
#   -        F32:    66 tensors, bytes=48.05 MiB
# [gguf] key tensors:
#   - token_embd.weight: Q4_K dims=(3584, 151936)
#   - blk.0.attn_q.weight: Q4_K dims=(3584, 3584)

# Convert to bump format
make gguf-to-bump GGUF=models/qwen2.5-3b-instruct-q4_k_m.gguf

# Output files:
#   GGUF_OUT/weights.bump     - Quantized weights
#   GGUF_OUT/config.json      - HuggingFace-style config</code></pre>
</div>

<h2>Quantization Format Comparison</h2>

<table>
    <thead>
        <tr>
            <th>Format</th>
            <th>Block Size</th>
            <th>Bytes/Block</th>
            <th>Bits/Weight</th>
            <th>Quality</th>
            <th>Use Case</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>FP32</code></td>
            <td>1</td>
            <td>4</td>
            <td>32.0</td>
            <td>Baseline</td>
            <td>Training, norms</td>
        </tr>
        <tr>
            <td><code>FP16</code></td>
            <td>1</td>
            <td>2</td>
            <td>16.0</td>
            <td>~Same</td>
            <td>GPU inference</td>
        </tr>
        <tr>
            <td><code>Q8_0</code></td>
            <td>32</td>
            <td>34</td>
            <td>8.5</td>
            <td>Excellent</td>
            <td>Activations</td>
        </tr>
        <tr>
            <td><code>Q4_0</code></td>
            <td>32</td>
            <td>18</td>
            <td>4.5</td>
            <td>Good</td>
            <td>Simple quant</td>
        </tr>
        <tr>
            <td><strong><code>Q4_K</code></strong></td>
            <td>256</td>
            <td>144</td>
            <td><strong>4.5</strong></td>
            <td><strong>Very Good</strong></td>
            <td><strong>Weights (primary)</strong></td>
        </tr>
        <tr>
            <td><code>Q6_K</code></td>
            <td>256</td>
            <td>210</td>
            <td>6.6</td>
            <td>Excellent</td>
            <td>Quality-sensitive</td>
        </tr>
    </tbody>
</table>

<div class="alert alert-success">
    <span class="alert-icon">&#9989;</span>
    <div>
        <strong>Recommendation:</strong> Use Q4_K_M models for the best balance of quality and memory savings. The "M" in Q4_K_M means "medium" quantization - it keeps more precision in attention layers.
    </div>
</div>

<h2>Integration with Bump Allocator</h2>

<p>The bump allocator loads weights once at startup and keeps them in memory. The key insight is that quantized weights stay quantized - we never allocate space for dequantized FP32 weights.</p>

<div class="img-container">
    <svg viewBox="0 0 800 300" style="max-width: 100%; background: #1a1a1a; border-radius: 8px;">
        <!-- Title -->
        <text x="400" y="30" text-anchor="middle" fill="#ffb400" font-size="16" font-weight="bold">Memory Layout: Quantized Weights + FP32 Activations</text>

        <!-- Memory bar -->
        <rect x="50" y="60" width="700" height="80" fill="#323232" stroke="#ffb400" stroke-width="2" rx="4"/>

        <!-- Weights section (Q4_K) -->
        <rect x="55" y="65" width="400" height="70" fill="#07adf8" rx="2"/>
        <text x="255" y="100" text-anchor="middle" fill="#fff" font-size="14" font-weight="bold">Quantized Weights (Q4_K)</text>
        <text x="255" y="120" text-anchor="middle" fill="#fff" font-size="11">~1.7 GB for 7B model</text>

        <!-- Activations section (FP32) -->
        <rect x="460" y="65" width="285" height="70" fill="#47b475" rx="2"/>
        <text x="602" y="100" text-anchor="middle" fill="#fff" font-size="14" font-weight="bold">Activations (FP32)</text>
        <text x="602" y="120" text-anchor="middle" fill="#fff" font-size="11">Reused per layer</text>

        <!-- Comparison -->
        <text x="400" y="180" text-anchor="middle" fill="#fff" font-size="14" font-weight="bold">Memory Comparison (7B Model)</text>

        <!-- FP32 bar -->
        <rect x="50" y="200" width="700" height="30" fill="#e74c3c" rx="4"/>
        <text x="400" y="220" text-anchor="middle" fill="#fff" font-size="12" font-weight="bold">FP32 Weights: ~28 GB</text>

        <!-- Q4_K bar -->
        <rect x="50" y="240" width="175" height="30" fill="#07adf8" rx="4"/>
        <text x="137" y="260" text-anchor="middle" fill="#fff" font-size="12" font-weight="bold">Q4_K: ~3.5 GB</text>

        <!-- Savings label -->
        <text x="400" y="280" text-anchor="middle" fill="#47b475" font-size="14" font-weight="bold">8x memory reduction!</text>
    </svg>
</div>

<h2>Source Files</h2>

<table>
    <thead>
        <tr>
            <th>File</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>scripts/convert_gguf_to_bump.py</code></td>
            <td>GGUF to bump conversion tool</td>
        </tr>
        <tr>
            <td><code>include/ckernel_quant.h</code></td>
            <td>Block structures (block_q4_K, etc.)</td>
        </tr>
        <tr>
            <td><code>src/kernels/dequant_kernels.c</code></td>
            <td>Dequantization implementations</td>
        </tr>
        <tr>
            <td><code>include/ckernel_dtype.h</code></td>
            <td>Data type enums and utilities</td>
        </tr>
    </tbody>
</table>
    </main>

    <!-- SVG Viewer Overlay (shared across all pages) -->
    <style>
    .svg-viewer { cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
    .svg-viewer:hover { transform: scale(1.01); box-shadow: 0 8px 32px rgba(255, 180, 0, 0.3); }
    #svg-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 999999; }
    #svg-overlay .toolbar { position: fixed; top: 0; left: 0; right: 0; padding: 10px 20px; background: rgba(0,0,0,0.9); display: flex; justify-content: space-between; align-items: center; z-index: 1000000; border-bottom: 1px solid #333; }
    #svg-overlay .toolbar .title { color: #ccc; font-size: 14px; }
    #svg-overlay .toolbar .controls { display: flex; gap: 8px; align-items: center; }
    #svg-overlay .toolbar button { background: #333; color: #ffb400; border: 1px solid #555; padding: 8px 14px; cursor: pointer; border-radius: 4px; font-size: 14px; }
    #svg-overlay .toolbar button:hover { background: #444; border-color: #ffb400; }
    #svg-overlay .toolbar .close-btn { font-size: 20px; padding: 4px 12px; }
    #svg-overlay .toolbar .zoom-display { color: #888; font-size: 12px; min-width: 45px; text-align: center; }
    #svg-overlay .toolbar .separator { color: #444; }
    #svg-overlay .image-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 60px 20px 20px; cursor: grab; }
    #svg-overlay .image-container:active { cursor: grabbing; }
    #svg-overlay .image-container img { max-width: 95%; max-height: 90vh; transform-origin: center center; }
    #svg-overlay .nav-btn { position: fixed; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: #ffb400; border: 1px solid #555; font-size: 30px; padding: 20px 15px; cursor: pointer; z-index: 1000000; border-radius: 4px; }
    #svg-overlay .nav-btn:hover { background: rgba(255,180,0,0.2); border-color: #ffb400; }
    #svg-overlay .nav-prev { left: 10px; }
    #svg-overlay .nav-next { right: 10px; }
    #svg-overlay .hint { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); color: #666; font-size: 12px; background: rgba(0,0,0,0.8); padding: 8px 20px; border-radius: 20px; }
    </style>

    <div id="svg-overlay">
        <div class="toolbar">
            <span class="title" id="svg-title">Image</span>
            <div class="controls">
                <button onclick="svgViewer.zoomOut()" title="Zoom Out (-)">-</button>
                <span class="zoom-display" id="zoom-display">100%</span>
                <button onclick="svgViewer.zoomIn()" title="Zoom In (+)">+</button>
                <span class="separator">|</span>
                <button onclick="svgViewer.fitWidth()" title="Fit Width (W)">Width</button>
                <button onclick="svgViewer.fitHeight()" title="Fit Height (H)">Height</button>
                <button onclick="svgViewer.resetZoom()" title="Reset (0)">Reset</button>
                <span class="separator">|</span>
                <button class="close-btn" onclick="svgViewer.close()" title="Close (ESC)">&times;</button>
            </div>
        </div>
        <button class="nav-btn nav-prev" onclick="svgViewer.prev()" title="Previous">&larr;</button>
        <button class="nav-btn nav-next" onclick="svgViewer.next()" title="Next">&rarr;</button>
        <div class="image-container" id="svg-container">
            <img id="svg-image" src="" alt="">
        </div>
        <div class="hint">Scroll to zoom | Drag to pan | W/H to fit | 0 to reset | ESC to close</div>
    </div>

    <script>
    var svgViewer = (function() {
        var overlay, img, titleEl, container;
        var images = [];
        var currentIndex = 0;
        var scale = 1, panX = 0, panY = 0;
        var isDragging = false, dragStartX, dragStartY, panStartX, panStartY;

        function init() {
            overlay = document.getElementById('svg-overlay');
            img = document.getElementById('svg-image');
            titleEl = document.getElementById('svg-title');
            container = document.getElementById('svg-container');
            if (!overlay || !img) return;

            document.querySelectorAll('.svg-viewer').forEach(function(viewer, index) {
                var viewerImg = viewer.querySelector('img');
                if (viewerImg) {
                    images.push({ src: viewerImg.src, title: viewer.getAttribute('data-title') || viewerImg.alt || 'Diagram' });
                    viewer.onclick = function(e) { e.preventDefault(); open(index); };
                }
            });

            container.addEventListener('wheel', function(e) {
                e.preventDefault();
                scale = Math.max(0.5, Math.min(10, scale + (e.deltaY > 0 ? -0.2 : 0.2)));
                updateTransform();
            });

            container.addEventListener('mousedown', function(e) { isDragging = true; dragStartX = e.clientX; dragStartY = e.clientY; panStartX = panX; panStartY = panY; });
            document.addEventListener('mousemove', function(e) { if (!isDragging) return; panX = panStartX + (e.clientX - dragStartX); panY = panStartY + (e.clientY - dragStartY); updateTransform(); });
            document.addEventListener('mouseup', function() { isDragging = false; });

            document.addEventListener('keydown', function(e) {
                if (overlay.style.display !== 'block') return;
                if (e.key === 'Escape') close();
                if (e.key === 'ArrowLeft') prev();
                if (e.key === 'ArrowRight') next();
                if (e.key === '+' || e.key === '=') zoomIn();
                if (e.key === '-') zoomOut();
                if (e.key === '0') resetZoom();
                if (e.key === 'w' || e.key === 'W') fitWidth();
                if (e.key === 'h' || e.key === 'H') fitHeight();
            });

            overlay.addEventListener('click', function(e) { if (e.target === overlay || e.target === container) close(); });
        }

        function updateTransform() {
            img.style.transform = 'translate(' + panX + 'px, ' + panY + 'px) scale(' + scale + ')';
            var zd = document.getElementById('zoom-display');
            if (zd) zd.textContent = Math.round(scale * 100) + '%';
        }

        function open(index) {
            if (!images[index]) return;
            currentIndex = index; scale = 1; panX = 0; panY = 0;
            img.src = images[index].src;
            titleEl.textContent = images[index].title + ' (' + (index + 1) + '/' + images.length + ')';
            updateTransform();
            overlay.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function close() { overlay.style.display = 'none'; document.body.style.overflow = ''; }
        function prev() { open((currentIndex - 1 + images.length) % images.length); }
        function next() { open((currentIndex + 1) % images.length); }
        function zoomIn() { scale = Math.min(10, scale + 0.25); updateTransform(); }
        function zoomOut() { scale = Math.max(0.5, scale - 0.25); updateTransform(); }
        function resetZoom() { scale = 1; panX = 0; panY = 0; updateTransform(); }

        function fitWidth() {
            if (!img.naturalWidth || !img.complete) { img.onload = fitWidth; return; }
            scale = Math.max(0.1, Math.min(10, (window.innerWidth - 150) / img.naturalWidth));
            panX = 0; panY = 0; updateTransform();
        }

        function fitHeight() {
            if (!img.naturalHeight || !img.complete) { img.onload = fitHeight; return; }
            scale = Math.max(0.1, Math.min(10, (window.innerHeight - 120) / img.naturalHeight));
            panX = 0; panY = 0; updateTransform();
        }

        if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', init); } else { init(); }

        return { open: open, close: close, prev: prev, next: next, zoomIn: zoomIn, zoomOut: zoomOut, resetZoom: resetZoom, fitWidth: fitWidth, fitHeight: fitHeight };
    })();

    // Mobile navigation
    (function() {
        var navToggle = document.querySelector('.nav-toggle');
        var siteNav = document.querySelector('.site-nav');
        var dropdowns = document.querySelectorAll('.nav-dropdown');

        if (navToggle && siteNav) {
            navToggle.addEventListener('click', function() {
                navToggle.classList.toggle('active');
                siteNav.classList.toggle('open');
                navToggle.setAttribute('aria-expanded', siteNav.classList.contains('open'));
            });

            // Close menu when clicking a non-dropdown link
            siteNav.querySelectorAll('a:not(.nav-dropdown-menu a)').forEach(function(link) {
                link.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        navToggle.classList.remove('active');
                        siteNav.classList.remove('open');
                    }
                });
            });
        }

        // Handle dropdowns on mobile
        dropdowns.forEach(function(dropdown) {
            var trigger = dropdown.querySelector('.nav-trigger');
            if (trigger) {
                trigger.addEventListener('click', function(e) {
                    if (window.innerWidth <= 768) {
                        e.preventDefault();
                        // Close other dropdowns
                        dropdowns.forEach(function(d) {
                            if (d !== dropdown) d.classList.remove('open');
                        });
                        dropdown.classList.toggle('open');
                    }
                });
            }
        });

        // Close dropdowns when clicking outside on mobile
        document.addEventListener('click', function(e) {
            if (window.innerWidth <= 768 && !e.target.closest('.nav-dropdown')) {
                dropdowns.forEach(function(d) { d.classList.remove('open'); });
            }
        });
    })();
    </script>

    <footer style="background: #2a2a2a; border-top: 1px solid #454545; color: #b0b0b0; padding: 3rem 2rem; margin-top: auto;">
        <div style="max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 2rem;">
            <div>
                <h4 style="color: #ffb400; margin-bottom: 0.75rem; font-size: 1rem;">C-Kernel-Engine</h4>
                <p style="color: #707070; font-size: 0.875rem; margin: 0;">High-performance ML kernels with full PyTorch parity.</p>
            </div>
            <div>
                <h4 style="color: #ffb400; margin-bottom: 0.75rem; font-size: 1rem;">Resources</h4>
                <ul style="list-style: none; padding: 0; margin: 0;">
                    <li style="margin-bottom: 0.5rem;"><a href="https://github.com/antshiv/C-Kernel-Engine" style="color: #909090; text-decoration: none; font-size: 0.875rem;">GitHub</a></li>
                    <li style="margin-bottom: 0.5rem;"><a href="architecture.html" style="color: #909090; text-decoration: none; font-size: 0.875rem;">Architecture</a></li>
                    <li style="margin-bottom: 0.5rem;"><a href="api.html" style="color: #909090; text-decoration: none; font-size: 0.875rem;">API Reference</a></li>
                </ul>
            </div>
            <div>
                <h4 style="color: #ffb400; margin-bottom: 0.75rem; font-size: 1rem;">Related</h4>
                <ul style="list-style: none; padding: 0; margin: 0;">
                    <li style="margin-bottom: 0.5rem;"><a href="https://pytorch.org" style="color: #909090; text-decoration: none; font-size: 0.875rem;">PyTorch</a></li>
                    <li style="margin-bottom: 0.5rem;"><a href="https://antsand.com" style="color: #909090; text-decoration: none; font-size: 0.875rem;">antsand.com</a></li>
                </ul>
            </div>
            <div style="text-align: right;">
                <p style="color: #606060; font-size: 0.75rem; margin: 0;">Built with zero dependencies</p>
                <p style="color: #606060; font-size: 0.75rem; margin: 0.5rem 0 0 0;">2026-01-02</p>
            </div>
        </div>
    </footer>
</body>
</html>
