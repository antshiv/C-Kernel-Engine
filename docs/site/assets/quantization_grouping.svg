<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 2800" font-family="system-ui, -apple-system, sans-serif">
  <defs>
    <linearGradient id="headerGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#1a1a2e"/>
      <stop offset="100%" style="stop-color:#16213e"/>
    </linearGradient>
    <linearGradient id="groupGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#f97316"/>
      <stop offset="100%" style="stop-color:#ef4444"/>
    </linearGradient>
    <linearGradient id="scaleGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#22c55e"/>
      <stop offset="100%" style="stop-color:#16a34a"/>
    </linearGradient>
    <linearGradient id="weightGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#a855f7"/>
      <stop offset="100%" style="stop-color:#7c3aed"/>
    </linearGradient>
    <linearGradient id="activationGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#3b82f6"/>
      <stop offset="100%" style="stop-color:#1d4ed8"/>
    </linearGradient>
    <linearGradient id="cacheGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#06b6d4"/>
      <stop offset="100%" style="stop-color:#0891b2"/>
    </linearGradient>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="2" dy="4" stdDeviation="4" flood-opacity="0.3"/>
    </filter>
  </defs>

  <!-- Background -->
  <rect width="1400" height="2800" fill="#0f0f1a"/>
  <pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse">
    <path d="M 50 0 L 0 0 0 50" fill="none" stroke="#1a1a2e" stroke-width="1"/>
  </pattern>
  <rect width="1400" height="2800" fill="url(#grid)" opacity="0.5"/>

  <!-- Header -->
  <rect x="50" y="30" width="1300" height="120" rx="15" fill="url(#headerGrad)" filter="url(#shadow)"/>
  <text x="700" y="85" text-anchor="middle" fill="#ffffff" font-size="38" font-weight="bold">
    Quantization Grouping &amp; Memory Layout
  </text>
  <text x="700" y="120" text-anchor="middle" fill="#8892b0" font-size="18">
    How GGML/llama.cpp Structures Quantized Weights for Cache-Friendly Access
  </text>

  <!-- ============================================== -->
  <!-- SECTION 1: WHY GROUPING? -->
  <!-- ============================================== -->

  <text x="700" y="200" text-anchor="middle" fill="#64ffda" font-size="28" font-weight="bold">
    Why Per-Group Scales?
  </text>

  <g transform="translate(50, 230)">
    <!-- Without grouping -->
    <rect x="0" y="0" width="620" height="280" rx="15" fill="#1a1a2e" stroke="#ef4444" stroke-width="2"/>
    <text x="310" y="35" text-anchor="middle" fill="#ef4444" font-size="20" font-weight="bold">
      Without Grouping (Single Scale)
    </text>

    <text x="20" y="70" fill="#e2e8f0" font-size="14">Weight matrix with mixed magnitudes:</text>

    <!-- Value distribution -->
    <rect x="20" y="85" width="580" height="60" rx="5" fill="#0f172a"/>
    <text x="30" y="110" fill="#fca5a5" font-size="13" font-family="monospace">[-2.0, -1.8, -1.5, ..., 0.001, 0.002, 0.003, ...]</text>
    <text x="30" y="130" fill="#64748b" font-size="12">Range: -2.0 to +0.003 → scale = 2.0/127 = 0.0157</text>

    <!-- Problem illustration -->
    <rect x="20" y="155" width="580" height="110" rx="5" fill="#450a0a"/>
    <text x="30" y="180" fill="#fca5a5" font-size="14" font-weight="bold">Problem:</text>
    <text x="30" y="205" fill="#e2e8f0" font-size="13">quantize(0.001) = round(0.001 / 0.0157) = round(0.064) = 0</text>
    <text x="30" y="225" fill="#e2e8f0" font-size="13">quantize(0.002) = round(0.002 / 0.0157) = round(0.127) = 0</text>
    <text x="30" y="250" fill="#ef4444" font-size="14" font-weight="bold">Small weights become ZERO - information lost!</text>

    <!-- With grouping -->
    <rect x="660" y="0" width="620" height="280" rx="15" fill="#1a1a2e" stroke="#22c55e" stroke-width="2"/>
    <text x="970" y="35" text-anchor="middle" fill="#22c55e" font-size="20" font-weight="bold">
      With Grouping (Per-Block Scale)
    </text>

    <text x="680" y="70" fill="#e2e8f0" font-size="14">Same matrix, divided into 32-element blocks:</text>

    <!-- Block distribution -->
    <rect x="680" y="85" width="580" height="100" rx="5" fill="#0f172a"/>
    <text x="690" y="110" fill="#22c55e" font-size="13" font-weight="bold">Block 0:</text>
    <text x="690" y="128" fill="#e2e8f0" font-size="12" font-family="monospace">[-2.0, -1.8, ...] → scale₀ = 2.0/127 = 0.0157</text>
    <text x="690" y="150" fill="#22c55e" font-size="13" font-weight="bold">Block 47:</text>
    <text x="690" y="168" fill="#e2e8f0" font-size="12" font-family="monospace">[0.001, 0.002, ...] → scale₄₇ = 0.01/127 = 0.000079</text>

    <!-- Solution -->
    <rect x="680" y="195" width="580" height="70" rx="5" fill="#14532d"/>
    <text x="690" y="220" fill="#22c55e" font-size="14" font-weight="bold">Result:</text>
    <text x="690" y="245" fill="#e2e8f0" font-size="13">quantize(0.001) = round(0.001 / 0.000079) = round(12.7) = 13</text>
    <text x="690" y="263" fill="#22c55e" font-size="13">Small weights preserved with proper precision!</text>
  </g>

  <!-- ============================================== -->
  <!-- SECTION 2: Q4_0 BLOCK STRUCTURE -->
  <!-- ============================================== -->

  <text x="700" y="560" text-anchor="middle" fill="#64ffda" font-size="28" font-weight="bold">
    Q4_0 Block Structure (32 weights per block)
  </text>

  <g transform="translate(50, 590)">
    <rect x="0" y="0" width="1300" height="320" rx="15" fill="#1a1a2e" filter="url(#shadow)"/>

    <!-- Block structure -->
    <text x="30" y="40" fill="#e2e8f0" font-size="18" font-weight="bold">block_q4_0 (18 bytes total):</text>

    <!-- Scale (d) -->
    <g transform="translate(30, 60)">
      <rect x="0" y="0" width="120" height="80" rx="10" fill="url(#scaleGrad)"/>
      <text x="60" y="35" text-anchor="middle" fill="white" font-size="16" font-weight="bold">d (scale)</text>
      <text x="60" y="55" text-anchor="middle" fill="white" font-size="14">FP16</text>
      <text x="60" y="72" text-anchor="middle" fill="white" font-size="12">2 bytes</text>
    </g>

    <!-- Packed weights (qs) -->
    <g transform="translate(160, 60)">
      <rect x="0" y="0" width="1100" height="80" rx="10" fill="url(#weightGrad)"/>
      <text x="550" y="35" text-anchor="middle" fill="white" font-size="16" font-weight="bold">qs[16] - Packed 4-bit weights</text>
      <text x="550" y="55" text-anchor="middle" fill="white" font-size="14">16 bytes = 32 nibbles = 32 weights</text>

      <!-- Individual bytes -->
      <g transform="translate(20, 58)">
        <rect x="0" y="0" width="60" height="18" rx="3" fill="#581c87"/>
        <text x="30" y="13" text-anchor="middle" fill="white" font-size="10">qs[0]</text>
        <rect x="65" y="0" width="60" height="18" rx="3" fill="#581c87"/>
        <text x="95" y="13" text-anchor="middle" fill="white" font-size="10">qs[1]</text>
        <rect x="130" y="0" width="60" height="18" rx="3" fill="#581c87"/>
        <text x="160" y="13" text-anchor="middle" fill="white" font-size="10">qs[2]</text>
        <text x="210" y="13" fill="white" font-size="12">...</text>
        <rect x="240" y="0" width="60" height="18" rx="3" fill="#581c87"/>
        <text x="270" y="13" text-anchor="middle" fill="white" font-size="10">qs[15]</text>
      </g>
    </g>

    <!-- Byte unpacking detail -->
    <g transform="translate(30, 160)">
      <text x="0" y="20" fill="#64ffda" font-size="16" font-weight="bold">Nibble Packing (2 weights per byte):</text>

      <rect x="0" y="35" width="500" height="120" rx="10" fill="#0f172a"/>

      <!-- Single byte breakdown -->
      <text x="20" y="60" fill="#e2e8f0" font-size="14" font-family="monospace">qs[0] = 0xA7 (binary: 1010 0111)</text>

      <g transform="translate(20, 75)">
        <!-- High nibble -->
        <rect x="0" y="0" width="100" height="30" rx="5" fill="#7c3aed"/>
        <text x="50" y="20" text-anchor="middle" fill="white" font-size="12">High: 1010</text>
        <!-- Low nibble -->
        <rect x="110" y="0" width="100" height="30" rx="5" fill="#a855f7"/>
        <text x="160" y="20" text-anchor="middle" fill="white" font-size="12">Low: 0111</text>

        <!-- Arrows and values -->
        <text x="230" y="20" fill="#e2e8f0" font-size="13">→ weight₁ = 10 - 8 = +2</text>
        <text x="230" y="35" fill="#e2e8f0" font-size="13">→ weight₀ = 7 - 8 = -1</text>
      </g>

      <text x="20" y="135" fill="#64748b" font-size="13">Dequantized: value = (nibble - 8) × scale</text>
    </g>

    <!-- Memory calculation -->
    <g transform="translate(550, 160)">
      <text x="0" y="20" fill="#64ffda" font-size="16" font-weight="bold">Memory Efficiency:</text>

      <rect x="0" y="35" width="700" height="120" rx="10" fill="#0f172a"/>

      <text x="20" y="65" fill="#e2e8f0" font-size="14">FP32: 32 weights × 4 bytes = 128 bytes</text>
      <text x="20" y="90" fill="#e2e8f0" font-size="14">Q4_0: 2 (scale) + 16 (packed) = 18 bytes</text>
      <text x="20" y="115" fill="#22c55e" font-size="14" font-weight="bold">Compression: 128/18 = 7.1× smaller</text>
      <text x="20" y="140" fill="#64748b" font-size="13">Effective bits per weight: 18×8/32 = 4.5 bits</text>
    </g>
  </g>

  <!-- ============================================== -->
  <!-- SECTION 3: MEMORY LAYOUT IN BUMP ALLOCATOR -->
  <!-- ============================================== -->

  <text x="700" y="960" text-anchor="middle" fill="#64ffda" font-size="28" font-weight="bold">
    Memory Layout: Bump Allocator Regions
  </text>

  <g transform="translate(50, 990)">
    <rect x="0" y="0" width="1300" height="500" rx="15" fill="#1a1a2e" filter="url(#shadow)"/>

    <!-- Title -->
    <text x="650" y="35" text-anchor="middle" fill="#e2e8f0" font-size="18" font-weight="bold">
      No Type Mixing - Each Region is Homogeneous
    </text>

    <!-- Weight Region -->
    <g transform="translate(30, 60)">
      <rect x="0" y="0" width="1240" height="140" rx="10" fill="#0f172a" stroke="#a855f7" stroke-width="2"/>
      <text x="20" y="30" fill="#a855f7" font-size="16" font-weight="bold">WEIGHT REGION (quantized, read-only)</text>

      <!-- Q4_0 blocks -->
      <g transform="translate(20, 45)">
        <rect x="0" y="0" width="180" height="70" rx="5" fill="url(#weightGrad)"/>
        <text x="90" y="25" text-anchor="middle" fill="white" font-size="12" font-weight="bold">block_q4_0[0]</text>
        <text x="90" y="45" text-anchor="middle" fill="white" font-size="10">[d₀|qs₀...qs₁₅]</text>
        <text x="90" y="60" text-anchor="middle" fill="white" font-size="10">18 bytes</text>

        <rect x="190" y="0" width="180" height="70" rx="5" fill="url(#weightGrad)"/>
        <text x="280" y="25" text-anchor="middle" fill="white" font-size="12" font-weight="bold">block_q4_0[1]</text>
        <text x="280" y="45" text-anchor="middle" fill="white" font-size="10">[d₁|qs₀...qs₁₅]</text>
        <text x="280" y="60" text-anchor="middle" fill="white" font-size="10">18 bytes</text>

        <rect x="380" y="0" width="180" height="70" rx="5" fill="url(#weightGrad)"/>
        <text x="470" y="25" text-anchor="middle" fill="white" font-size="12" font-weight="bold">block_q4_0[2]</text>
        <text x="470" y="45" text-anchor="middle" fill="white" font-size="10">[d₂|qs₀...qs₁₅]</text>
        <text x="470" y="60" text-anchor="middle" fill="white" font-size="10">18 bytes</text>

        <text x="590" y="40" fill="#a855f7" font-size="24">...</text>

        <rect x="640" y="0" width="180" height="70" rx="5" fill="url(#weightGrad)"/>
        <text x="730" y="25" text-anchor="middle" fill="white" font-size="12" font-weight="bold">block_q4_0[N]</text>
        <text x="730" y="45" text-anchor="middle" fill="white" font-size="10">[dₙ|qs₀...qs₁₅]</text>
        <text x="730" y="60" text-anchor="middle" fill="white" font-size="10">18 bytes</text>
      </g>

      <text x="880" y="90" fill="#a855f7" font-size="13">All Q4_0 - contiguous, cache-friendly</text>
    </g>

    <!-- Activation Region -->
    <g transform="translate(30, 220)">
      <rect x="0" y="0" width="1240" height="120" rx="10" fill="#0f172a" stroke="#3b82f6" stroke-width="2"/>
      <text x="20" y="30" fill="#3b82f6" font-size="16" font-weight="bold">ACTIVATION REGION (FP32, reset each forward)</text>

      <!-- FP32 values -->
      <g transform="translate(20, 45)">
        <rect x="0" y="0" width="100" height="50" rx="5" fill="url(#activationGrad)"/>
        <text x="50" y="30" text-anchor="middle" fill="white" font-size="12">f32</text>
        <rect x="105" y="0" width="100" height="50" rx="5" fill="url(#activationGrad)"/>
        <text x="155" y="30" text-anchor="middle" fill="white" font-size="12">f32</text>
        <rect x="210" y="0" width="100" height="50" rx="5" fill="url(#activationGrad)"/>
        <text x="260" y="30" text-anchor="middle" fill="white" font-size="12">f32</text>
        <rect x="315" y="0" width="100" height="50" rx="5" fill="url(#activationGrad)"/>
        <text x="365" y="30" text-anchor="middle" fill="white" font-size="12">f32</text>
        <text x="440" y="30" fill="#3b82f6" font-size="24">...</text>
        <rect x="480" y="0" width="100" height="50" rx="5" fill="url(#activationGrad)"/>
        <text x="530" y="30" text-anchor="middle" fill="white" font-size="12">f32</text>
      </g>

      <text x="650" y="80" fill="#3b82f6" font-size="13">All FP32 - sequential read/write, perfect prefetch</text>
    </g>

    <!-- Scratch Region -->
    <g transform="translate(30, 360)">
      <rect x="0" y="0" width="1240" height="110" rx="10" fill="#0f172a" stroke="#06b6d4" stroke-width="2"/>
      <text x="20" y="30" fill="#06b6d4" font-size="16" font-weight="bold">SCRATCH REGION (temporary, reset each layer)</text>

      <g transform="translate(20, 45)">
        <rect x="0" y="0" width="200" height="45" rx="5" fill="#0e7490"/>
        <text x="100" y="28" text-anchor="middle" fill="white" font-size="12">attention_scores</text>
        <rect x="210" y="0" width="200" height="45" rx="5" fill="#0e7490"/>
        <text x="310" y="28" text-anchor="middle" fill="white" font-size="12">softmax_buffer</text>
        <rect x="420" y="0" width="200" height="45" rx="5" fill="#0e7490"/>
        <text x="520" y="28" text-anchor="middle" fill="white" font-size="12">mlp_intermediate</text>
      </g>
    </g>
  </g>

  <!-- ============================================== -->
  <!-- SECTION 4: CACHE LINE ACCESS -->
  <!-- ============================================== -->

  <text x="700" y="1550" text-anchor="middle" fill="#64ffda" font-size="28" font-weight="bold">
    Cache Line Access Pattern
  </text>

  <g transform="translate(50, 1580)">
    <rect x="0" y="0" width="1300" height="350" rx="15" fill="#1a1a2e" filter="url(#shadow)"/>

    <text x="650" y="35" text-anchor="middle" fill="#e2e8f0" font-size="16">
      64-byte cache line sees homogeneous data - optimal prefetch
    </text>

    <!-- Cache line visualization -->
    <g transform="translate(30, 60)">
      <text x="0" y="20" fill="#06b6d4" font-size="16" font-weight="bold">Cache Line 0 (bytes 0-63):</text>

      <rect x="0" y="35" width="1240" height="80" rx="10" fill="url(#cacheGrad)" stroke="#06b6d4" stroke-width="2"/>

      <!-- Blocks in cache line -->
      <g transform="translate(10, 50)">
        <rect x="0" y="0" width="380" height="50" rx="5" fill="#a855f7"/>
        <text x="190" y="20" text-anchor="middle" fill="white" font-size="12" font-weight="bold">block_q4_0[0]: 18 bytes</text>
        <text x="190" y="38" text-anchor="middle" fill="white" font-size="10">[scale + 32 packed weights]</text>

        <rect x="390" y="0" width="380" height="50" rx="5" fill="#a855f7"/>
        <text x="580" y="20" text-anchor="middle" fill="white" font-size="12" font-weight="bold">block_q4_0[1]: 18 bytes</text>
        <text x="580" y="38" text-anchor="middle" fill="white" font-size="10">[scale + 32 packed weights]</text>

        <rect x="780" y="0" width="380" height="50" rx="5" fill="#a855f7"/>
        <text x="970" y="20" text-anchor="middle" fill="white" font-size="12" font-weight="bold">block_q4_0[2]: 18 bytes</text>
        <text x="970" y="38" text-anchor="middle" fill="white" font-size="10">[scale + 32 packed weights]</text>

        <rect x="1170" y="0" width="50" height="50" rx="5" fill="#7c3aed"/>
        <text x="1195" y="30" text-anchor="middle" fill="white" font-size="10">+10B</text>
      </g>

      <text x="1100" y="130" fill="#22c55e" font-size="14" font-weight="bold">3.5 blocks per cache line!</text>
    </g>

    <!-- Key point -->
    <g transform="translate(30, 200)">
      <rect x="0" y="0" width="600" height="130" rx="10" fill="#14532d"/>
      <text x="300" y="30" text-anchor="middle" fill="#22c55e" font-size="16" font-weight="bold">Why This Matters:</text>
      <text x="20" y="60" fill="#e2e8f0" font-size="14">1. No type mixing in cache line</text>
      <text x="20" y="85" fill="#e2e8f0" font-size="14">2. Sequential access = hardware prefetch works</text>
      <text x="20" y="110" fill="#e2e8f0" font-size="14">3. Dequantization in registers, not memory</text>

      <rect x="630" y="0" width="610" height="130" rx="10" fill="#0f172a"/>
      <text x="935" y="30" text-anchor="middle" fill="#f97316" font-size="16" font-weight="bold">Bad Pattern (avoided):</text>
      <text x="650" y="60" fill="#fca5a5" font-size="14" font-family="monospace">[f32][q4][f32][q4][f32]... mixed</text>
      <text x="650" y="85" fill="#64748b" font-size="14">- Cache pollution from type transitions</text>
      <text x="650" y="110" fill="#64748b" font-size="14">- Unpredictable access patterns</text>
    </g>
  </g>

  <!-- ============================================== -->
  <!-- SECTION 5: DEQUANTIZATION IN REGISTERS -->
  <!-- ============================================== -->

  <text x="700" y="1990" text-anchor="middle" fill="#64ffda" font-size="28" font-weight="bold">
    Dequantization: Memory → Registers → Compute
  </text>

  <g transform="translate(50, 2020)">
    <rect x="0" y="0" width="1300" height="380" rx="15" fill="#1a1a2e" filter="url(#shadow)"/>

    <!-- Data flow -->
    <g transform="translate(30, 30)">
      <!-- Step 1: Memory Read -->
      <rect x="0" y="0" width="250" height="120" rx="10" fill="#0f172a" stroke="#a855f7" stroke-width="2"/>
      <text x="125" y="25" text-anchor="middle" fill="#a855f7" font-size="14" font-weight="bold">1. MEMORY READ</text>
      <text x="125" y="50" text-anchor="middle" fill="#e2e8f0" font-size="12">Weight Region (Q4_0)</text>
      <rect x="20" y="60" width="210" height="40" rx="5" fill="#581c87"/>
      <text x="125" y="85" text-anchor="middle" fill="white" font-size="11">[d | qs[0]...qs[15]]</text>

      <!-- Arrow -->
      <path d="M 260 60 L 300 60" stroke="#64ffda" stroke-width="3" fill="none" marker-end="url(#arrow)"/>

      <!-- Step 2: Unpack in Registers -->
      <rect x="310" y="0" width="300" height="120" rx="10" fill="#0f172a" stroke="#f97316" stroke-width="2"/>
      <text x="460" y="25" text-anchor="middle" fill="#f97316" font-size="14" font-weight="bold">2. UNPACK IN REGISTERS</text>
      <text x="460" y="50" text-anchor="middle" fill="#e2e8f0" font-size="12">AVX-512 register operations</text>
      <rect x="330" y="60" width="260" height="40" rx="5" fill="#9a3412"/>
      <text x="460" y="78" text-anchor="middle" fill="white" font-size="10">__m512i: nibble → int8 → int32</text>
      <text x="460" y="95" text-anchor="middle" fill="white" font-size="10">No memory write!</text>

      <!-- Arrow -->
      <path d="M 620 60 L 660 60" stroke="#64ffda" stroke-width="3" fill="none"/>

      <!-- Step 3: Scale multiply -->
      <rect x="670" y="0" width="260" height="120" rx="10" fill="#0f172a" stroke="#22c55e" stroke-width="2"/>
      <text x="800" y="25" text-anchor="middle" fill="#22c55e" font-size="14" font-weight="bold">3. SCALE × VALUE</text>
      <text x="800" y="50" text-anchor="middle" fill="#e2e8f0" font-size="12">FP32 in registers</text>
      <rect x="690" y="60" width="220" height="40" rx="5" fill="#166534"/>
      <text x="800" y="85" text-anchor="middle" fill="white" font-size="10">__m512: (q - 8) × scale</text>

      <!-- Arrow -->
      <path d="M 940 60 L 980 60" stroke="#64ffda" stroke-width="3" fill="none"/>

      <!-- Step 4: FMA with activation -->
      <rect x="990" y="0" width="250" height="120" rx="10" fill="#0f172a" stroke="#3b82f6" stroke-width="2"/>
      <text x="1115" y="25" text-anchor="middle" fill="#3b82f6" font-size="14" font-weight="bold">4. FMA COMPUTE</text>
      <text x="1115" y="50" text-anchor="middle" fill="#e2e8f0" font-size="12">Dot product accumulation</text>
      <rect x="1010" y="60" width="210" height="40" rx="5" fill="#1e40af"/>
      <text x="1115" y="85" text-anchor="middle" fill="white" font-size="10">acc += act × weight</text>
    </g>

    <!-- Code example -->
    <g transform="translate(30, 170)">
      <rect x="0" y="0" width="1240" height="190" rx="10" fill="#0f172a"/>
      <text x="20" y="25" fill="#64ffda" font-size="14" font-weight="bold">AVX-512 Dequantization (in registers only):</text>

      <text x="20" y="55" fill="#e2e8f0" font-size="13" font-family="monospace">// 1. Load packed Q4 weights (16 bytes = 32 weights)</text>
      <text x="20" y="75" fill="#a855f7" font-size="13" font-family="monospace">__m128i packed = _mm_loadu_si128((__m128i*)block->qs);</text>

      <text x="20" y="100" fill="#e2e8f0" font-size="13" font-family="monospace">// 2. Unpack nibbles to int8 (still in registers)</text>
      <text x="20" y="120" fill="#f97316" font-size="13" font-family="monospace">__m256i lo = _mm256_and_si256(cvt, _mm256_set1_epi8(0x0F));</text>

      <text x="20" y="145" fill="#e2e8f0" font-size="13" font-family="monospace">// 3. Subtract 8, multiply by scale → FP32 (registers)</text>
      <text x="20" y="165" fill="#22c55e" font-size="13" font-family="monospace">__m512 weights = _mm512_mul_ps(_mm512_cvtepi32_ps(sub8), _mm512_set1_ps(scale));</text>

      <text x="20" y="185" fill="#64748b" font-size="12">No memory allocations! All operations in 512-bit registers.</text>
    </g>
  </g>

  <!-- ============================================== -->
  <!-- SECTION 6: Q4_K SUPERBLOCK -->
  <!-- ============================================== -->

  <text x="700" y="2460" text-anchor="middle" fill="#64ffda" font-size="28" font-weight="bold">
    Q4_K: Nested Scales (256 weights per superblock)
  </text>

  <g transform="translate(50, 2490)">
    <rect x="0" y="0" width="1300" height="260" rx="15" fill="#1a1a2e" filter="url(#shadow)"/>

    <!-- Superblock structure -->
    <text x="30" y="35" fill="#e2e8f0" font-size="16" font-weight="bold">block_q4_K (144 bytes for 256 weights = 4.5 bits/weight):</text>

    <g transform="translate(30, 55)">
      <!-- Super-scale -->
      <rect x="0" y="0" width="100" height="60" rx="5" fill="#22c55e"/>
      <text x="50" y="25" text-anchor="middle" fill="white" font-size="12" font-weight="bold">d</text>
      <text x="50" y="45" text-anchor="middle" fill="white" font-size="10">super-scale</text>

      <!-- Super-min -->
      <rect x="110" y="0" width="100" height="60" rx="5" fill="#16a34a"/>
      <text x="160" y="25" text-anchor="middle" fill="white" font-size="12" font-weight="bold">dmin</text>
      <text x="160" y="45" text-anchor="middle" fill="white" font-size="10">super-min</text>

      <!-- Sub-scales -->
      <rect x="220" y="0" width="200" height="60" rx="5" fill="#f59e0b"/>
      <text x="320" y="25" text-anchor="middle" fill="white" font-size="12" font-weight="bold">scales[12]</text>
      <text x="320" y="45" text-anchor="middle" fill="white" font-size="10">8×6-bit sub-scales</text>

      <!-- Packed weights -->
      <rect x="430" y="0" width="800" height="60" rx="5" fill="url(#weightGrad)"/>
      <text x="830" y="25" text-anchor="middle" fill="white" font-size="14" font-weight="bold">qs[128] - 256 packed 4-bit weights</text>
      <text x="830" y="45" text-anchor="middle" fill="white" font-size="12">8 sub-blocks × 32 weights each</text>
    </g>

    <!-- Sub-block detail -->
    <g transform="translate(30, 135)">
      <text x="0" y="20" fill="#f97316" font-size="14" font-weight="bold">Sub-block structure (each has 32 weights):</text>

      <rect x="0" y="35" width="1240" height="60" rx="5" fill="#0f172a"/>

      <g transform="translate(10, 50)">
        <rect x="0" y="0" width="140" height="35" rx="5" fill="#7c3aed"/>
        <text x="70" y="22" text-anchor="middle" fill="white" font-size="11">Sub-block 0</text>

        <rect x="150" y="0" width="140" height="35" rx="5" fill="#7c3aed"/>
        <text x="220" y="22" text-anchor="middle" fill="white" font-size="11">Sub-block 1</text>

        <rect x="300" y="0" width="140" height="35" rx="5" fill="#7c3aed"/>
        <text x="370" y="22" text-anchor="middle" fill="white" font-size="11">Sub-block 2</text>

        <text x="470" y="22" fill="#a855f7" font-size="18">...</text>

        <rect x="520" y="0" width="140" height="35" rx="5" fill="#7c3aed"/>
        <text x="590" y="22" text-anchor="middle" fill="white" font-size="11">Sub-block 7</text>

        <text x="700" y="22" fill="#64748b" font-size="12">Each sub-block: scale₍ᵢ₎ = scales[i] × d</text>
      </g>

      <text x="0" y="115" fill="#22c55e" font-size="13">Two-level quantization: more precision than simple Q4_0, less overhead than per-32 scales</text>
    </g>
  </g>

  <!-- Footer -->
  <rect x="50" y="2760" width="1300" height="30" rx="5" fill="#1a1a2e"/>
  <text x="700" y="2782" text-anchor="middle" fill="#64748b" font-size="14">
    C-Kernel-Engine Quantization Guide | See also: quantization_infographic.svg | 2025
  </text>

  <!-- Arrow marker definition -->
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <path d="M0,0 L0,6 L9,3 z" fill="#64ffda"/>
    </marker>
  </defs>
</svg>
