name: Nightly Tests

on:
  # Run nightly at 2am UTC
  schedule:
    - cron: '0 2 * * *'

  # Also run on push to main and PRs
  push:
    branches: [main]
  pull_request:
    branches: [main]

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      test_category:
        description: 'Test category to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - quick
          - kernels
          - bf16
          - quant
          - parity

# Need write access to push to gh-pages
permissions:
  contents: write
  pages: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check CPU features
        run: |
          echo "=== CPU Info ==="
          lscpu | grep -E "(Model name|CPU\(s\)|Thread|Core|Socket|Flags)"
          echo ""
          echo "=== AVX Support ==="
          if grep -q avx512f /proc/cpuinfo; then
            echo "AVX-512: YES"
          else
            echo "AVX-512: NO (will use scalar fallbacks)"
          fi
          if grep -q avx2 /proc/cpuinfo; then
            echo "AVX2: YES"
          else
            echo "AVX2: NO"
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip list | grep -E "(torch|numpy)"

      - name: Build library
        run: |
          make clean || true
          make -j$(nproc)
          make test-libs
          echo ""
          echo "=== Built libraries ==="
          ls -la build/*.so 2>/dev/null || echo "No .so files in build/"

      - name: Run nightly tests (quick for PRs)
        if: github.event_name == 'pull_request'
        run: |
          python scripts/nightly_runner.py --quick --json build/nightly_report.json

      - name: Run nightly tests (full for main/scheduled)
        if: github.event_name != 'pull_request'
        run: |
          CATEGORY="${{ github.event.inputs.test_category || 'all' }}"
          if [ "$CATEGORY" = "all" ]; then
            python scripts/nightly_runner.py --json build/nightly_report.json
          elif [ "$CATEGORY" = "quick" ]; then
            python scripts/nightly_runner.py --quick --json build/nightly_report.json
          else
            python scripts/nightly_runner.py --category "$CATEGORY" --json build/nightly_report.json
          fi

      - name: Upload test report artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: nightly-report-${{ github.run_number }}
          path: build/nightly_report.json
          retention-days: 30

      - name: Publish report to gh-pages (main/scheduled only)
        if: (github.event_name == 'schedule' || github.event_name == 'push') && github.ref == 'refs/heads/main'
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Clone gh-pages branch
          git clone --depth 1 --branch gh-pages https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} gh-pages-tmp || {
            mkdir gh-pages-tmp
            cd gh-pages-tmp
            git init
            git checkout -b gh-pages
            cd ..
          }

          # Create nightly-results directory
          mkdir -p gh-pages-tmp/nightly-results

          # Copy current report
          cp build/nightly_report.json gh-pages-tmp/nightly-results/latest.json

          # Also save timestamped copy (keep last 30 days)
          TIMESTAMP=$(date +%Y-%m-%d)
          cp build/nightly_report.json "gh-pages-tmp/nightly-results/report-${TIMESTAMP}.json"

          # Create history index
          python3 << 'PYEOF'
          import json
          import os
          from datetime import datetime

          results_dir = "gh-pages-tmp/nightly-results"
          reports = []

          for f in sorted(os.listdir(results_dir)):
              if f.startswith("report-") and f.endswith(".json"):
                  path = os.path.join(results_dir, f)
                  try:
                      with open(path) as fp:
                          data = json.load(fp)
                      reports.append({
                          "date": f.replace("report-", "").replace(".json", ""),
                          "file": f,
                          "summary": data.get("summary", {}),
                          "duration_sec": data.get("duration_sec", 0)
                      })
                  except:
                      pass

          # Keep only last 30 reports
          reports = sorted(reports, key=lambda x: x["date"], reverse=True)[:30]

          # Write index
          with open(os.path.join(results_dir, "index.json"), "w") as fp:
              json.dump({
                  "updated": datetime.utcnow().isoformat() + "Z",
                  "reports": reports
              }, fp, indent=2)

          print(f"Index updated with {len(reports)} reports")
          PYEOF

          # Commit and push
          cd gh-pages-tmp
          git add nightly-results/
          git commit -m "Update nightly test results [skip ci]" || echo "No changes to commit"
          git push origin gh-pages || echo "Push failed (may need gh-pages branch created)"

      - name: Summary
        if: always()
        run: |
          if [ -f build/nightly_report.json ]; then
            echo "## Nightly Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Extract summary from JSON using Python
            python3 << 'PYEOF' >> $GITHUB_STEP_SUMMARY
          import json
          d = json.load(open('build/nightly_report.json'))
          s = d['summary']
          print("| Metric | Value |")
          print("|--------|-------|")
          print(f"| Passed | {s['passed']} |")
          print(f"| Failed | {s['failed']} |")
          print(f"| Total | {s['total']} |")
          print(f"| Duration | {d['duration_sec']:.1f}s |")
          if s['failed'] > 0:
              print("")
              print("### Failed Tests")
              for r in d['results']:
                  if r['status'] in ('fail', 'timeout'):
                      msg = r['error_msg'][:100] if r['error_msg'] else 'Unknown error'
                      print(f"- **{r['name']}** [{r['category']}]: {msg}")
          PYEOF
          fi

      - name: Check for failures
        run: |
          if [ -f build/nightly_report.json ]; then
            FAILED=$(python -c "import json; d=json.load(open('build/nightly_report.json')); print(d['summary']['failed'])")
            if [ "$FAILED" -gt 0 ]; then
              echo "::error::$FAILED tests failed"
              exit 1
            fi
          fi
